<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://t03i.github.io/FlatProt/api/scene/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Scene - FlatProt</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Scene";
        var mkdocs_page_input_path = "api/scene.md";
        var mkdocs_page_url = "/FlatProt/api/scene/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/json.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/toml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/numpy.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> FlatProt
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../installation/">Installation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../examples/">Examples</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Commands</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../commands/project/">Project</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../commands/align/">Align</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../commands/overlay/">Overlay</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">File Formats</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../file_formats/matrix/">Matrix Files</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../file_formats/style/">Style Files</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../file_formats/annotations/">Annotation Files</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../io/">IO</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../core/">Core</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../transformation/">Transformation & Projection</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Scene</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#scene-concept">Scene Concept</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#main-scene-class">Main Scene Class</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.Scene">Scene</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.Scene.resolver">resolver</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.Scene.structure">structure</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.Scene.top_level_nodes">top_level_nodes</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.Scene.__init__">__init__</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.Scene.__iter__">__iter__</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.Scene.__len__">__len__</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.Scene.__repr__">__repr__</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.Scene.add_element">add_element</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.Scene.get_all_elements">get_all_elements</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.Scene.get_element_by_id">get_element_by_id</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.Scene.get_sequential_structure_elements">get_sequential_structure_elements</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.Scene.move_element">move_element</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.Scene.remove_element">remove_element</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.Scene.traverse">traverse</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#base-classes">Base Classes</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.base_element.BaseSceneElement">BaseSceneElement</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.base_element.BaseSceneElement.default_style">default_style</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.base_element.BaseSceneElement.parent">parent</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.base_element.BaseSceneElement.style">style</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.base_element.BaseSceneElement.__init__">__init__</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.base_element.BaseSceneElement.__repr__">__repr__</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.base_element.BaseSceneElement.get_depth">get_depth</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.base_element.BaseSceneElement.update_style">update_style</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.base_element.BaseSceneStyle">BaseSceneStyle</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#structure-elements">Structure Elements</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.base_structure.BaseStructureSceneElement">BaseStructureSceneElement</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.base_structure.BaseStructureSceneElement.default_style">default_style</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.base_structure.BaseStructureSceneElement.__init__">__init__</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.base_structure.BaseStructureSceneElement.get_coordinate_at_residue">get_coordinate_at_residue</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.base_structure.BaseStructureSceneElement.get_coordinates">get_coordinates</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.base_structure.BaseStructureSceneElement.get_depth">get_depth</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.base_structure.BaseStructureSceneElement.get_end_connection_point">get_end_connection_point</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.base_structure.BaseStructureSceneElement.get_start_connection_point">get_start_connection_point</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.base_structure.BaseStructureSceneElement.is_adjacent_to">is_adjacent_to</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.base_structure.BaseStructureStyle">BaseStructureStyle</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.helix.HelixSceneElement">HelixSceneElement</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.helix.HelixSceneElement.default_style">default_style</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.helix.HelixSceneElement.__init__">__init__</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.helix.HelixSceneElement.get_coordinate_at_residue">get_coordinate_at_residue</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.helix.HelixSceneElement.get_coordinates">get_coordinates</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.helix.HelixSceneElement.get_end_connection_point">get_end_connection_point</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.helix.HelixSceneElement.get_start_connection_point">get_start_connection_point</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.helix.HelixStyle">HelixStyle</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.sheet.SheetSceneElement">SheetSceneElement</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.sheet.SheetSceneElement.default_style">default_style</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.sheet.SheetSceneElement.__init__">__init__</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.sheet.SheetSceneElement.get_coordinate_at_residue">get_coordinate_at_residue</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.sheet.SheetSceneElement.get_coordinates">get_coordinates</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.sheet.SheetSceneElement.get_end_connection_point">get_end_connection_point</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.sheet.SheetSceneElement.get_start_connection_point">get_start_connection_point</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.sheet.SheetStyle">SheetStyle</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.coil.CoilSceneElement">CoilSceneElement</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.coil.CoilSceneElement.default_style">default_style</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.coil.CoilSceneElement.__init__">__init__</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.coil.CoilSceneElement.get_coordinate_at_residue">get_coordinate_at_residue</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.coil.CoilSceneElement.get_coordinates">get_coordinates</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.coil.CoilSceneElement.get_end_connection_point">get_end_connection_point</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.coil.CoilSceneElement.get_start_connection_point">get_start_connection_point</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.structure.coil.CoilStyle">CoilStyle</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#annotation-elements">Annotation Elements</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.base_annotation.BaseAnnotationElement">BaseAnnotationElement</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.base_annotation.BaseAnnotationElement.default_style">default_style</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.base_annotation.BaseAnnotationElement.target">target</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.base_annotation.BaseAnnotationElement.targets_specific_coordinates">targets_specific_coordinates</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.base_annotation.BaseAnnotationElement.__init__">__init__</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.base_annotation.BaseAnnotationElement.get_coordinates">get_coordinates</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.base_annotation.BaseAnnotationElement.get_depth">get_depth</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.base_annotation.BaseAnnotationStyle">BaseAnnotationStyle</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.point.PointAnnotation">PointAnnotation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.point.PointAnnotation.default_style">default_style</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.point.PointAnnotation.target_coordinate">target_coordinate</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.point.PointAnnotation.__init__">__init__</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.point.PointAnnotation.get_coordinates">get_coordinates</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.point.PointAnnotationStyle">PointAnnotationStyle</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.line.LineAnnotation">LineAnnotation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.line.LineAnnotation.default_style">default_style</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.line.LineAnnotation.end_coordinate">end_coordinate</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.line.LineAnnotation.start_coordinate">start_coordinate</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.line.LineAnnotation.__init__">__init__</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.line.LineAnnotation.get_coordinates">get_coordinates</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.line.LineAnnotationStyle">LineAnnotationStyle</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.area.AreaAnnotation">AreaAnnotation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.area.AreaAnnotation.default_style">default_style</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.area.AreaAnnotation.__init__">__init__</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.area.AreaAnnotation.get_coordinates">get_coordinates</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.annotation.area.AreaAnnotationStyle">AreaAnnotationStyle</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#coordinate-resolver">Coordinate Resolver</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.resolver.CoordinateResolver">CoordinateResolver</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.resolver.CoordinateResolver.__init__">__init__</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.resolver.CoordinateResolver.resolve">resolve</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scene-utilities">Scene Utilities</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.utils.scene_utils.create_scene_from_structure">create_scene_from_structure</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.utils.scene_utils.add_annotations_to_scene">add_annotations_to_scene</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.utils.domain_utils.create_domain_aware_scene">create_domain_aware_scene</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scene-errors">Scene Errors</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.errors">errors</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.errors.CircularDependencyError">CircularDependencyError</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.errors.DuplicateElementError">DuplicateElementError</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.errors.ElementNotFoundError">ElementNotFoundError</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.errors.ElementTypeError">ElementTypeError</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.errors.InvalidSceneOperationError">InvalidSceneOperationError</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.errors.ParentNotFoundError">ParentNotFoundError</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.errors.SceneAnnotationError">SceneAnnotationError</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.errors.SceneCreationError">SceneCreationError</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.errors.SceneError">SceneError</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.errors.SceneGraphInconsistencyError">SceneGraphInconsistencyError</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flatprot.scene.errors.TargetResidueNotFoundError">TargetResidueNotFoundError</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../rendering/">Rendering</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../alignment/">DatabaseAlignment</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">FlatProt</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">API Reference</li>
      <li class="breadcrumb-item active">Scene</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/t03i/FlatProt/edit/master/docs/api/scene.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="scene-api">Scene API</h1>
<p>This section documents the components related to the FlatProt Scene, which acts as a container for projected visual elements before rendering.</p>
<h2 id="scene-concept">Scene Concept</h2>
<p>The "Scene" in FlatProt acts as a container that holds all the elements to be visualized <em>after</em> they have been projected into 2D space (plus depth information). It's the bridge between the processed structural data and the final rendering step (e.g., SVG generation).</p>
<p>Key concepts:</p>
<ol>
<li><strong>Container:</strong> The <code>Scene</code> object holds a collection of <code>SceneElement</code> objects (like helices, sheets, coils, annotations).</li>
<li><strong>Coordinate Space:</strong> Elements within the scene typically exist in a 2D coordinate system (X, Y) representing the canvas, but they retain a Z-coordinate representing their depth relative to the viewer.</li>
<li><strong>Resolution:</strong> It often works with a <code>CoordinateResolver</code> to map abstract residue identifiers (like <code>ChainID:ResidueIndex</code>) to the actual 2D+Depth coordinates within the scene's context.</li>
<li><strong>Z-Ordering:</strong> The depth information (Z-coordinate) associated with elements allows renderers to draw them in the correct order, ensuring closer elements obscure farther ones. Annotations are typically given a very high depth value to ensure they are drawn on top.</li>
<li><strong>Rendering:</strong> The <code>Scene</code> object, along with its elements and their associated styles, provides all the necessary information for a <code>Renderer</code> (like <code>SVGRenderer</code>) to draw the final visualization.</li>
</ol>
<hr />
<h2 id="main-scene-class">Main Scene Class</h2>
<p>The central container for all scene elements.</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.Scene"></a>
    <div class="doc doc-contents first">


        <p>Manages the scene graph for a protein structure visualization.</p>
<p>The Scene holds the core protein structure data and a hierarchical
tree of SceneElements (nodes), including SceneGroups.
It provides methods to build and manipulate this tree, and to query
elements based on residue information.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/scene.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Scene</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages the scene graph for a protein structure visualization.</span>

<span class="sd">    The Scene holds the core protein structure data and a hierarchical</span>
<span class="sd">    tree of SceneElements (nodes), including SceneGroups.</span>
<span class="sd">    It provides methods to build and manipulate this tree, and to query</span>
<span class="sd">    elements based on residue information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the Scene with a core Structure object.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core biological structure data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">Structure</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Scene must be initialized with a Structure object.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="c1"># List of top-level nodes (elements with no parent)</span>
        <span class="c1"># The order here determines the base rendering order of top-level items.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># For quick lookups by ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseSceneElement</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Create the coordinate resolver instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resolver</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoordinateResolver</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize as None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Structure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the core Structure object associated with this scene.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">top_level_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the list of top-level nodes in the scene graph.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span>

    <span class="k">def</span> <span class="nf">get_element_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a scene element by its unique ID.</span>

<span class="sd">        Args:</span>
<span class="sd">            id: The ID of the element to find.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The found BaseSceneElement or None if no element has that ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_register_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="n">BaseSceneElement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal method to add an element to the ID registry.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="p">:</span>
            <span class="c1"># Raise specific error for duplicate IDs</span>
            <span class="k">raise</span> <span class="n">DuplicateElementError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Element with ID &#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; already exists in the registry.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span>

    <span class="k">def</span> <span class="nf">_unregister_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="n">BaseSceneElement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal method to remove an element from the ID registry.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="c1"># Invalidate resolver cache if element affecting it is removed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resolver</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">add_element</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="n">BaseSceneElement</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a SceneElement to the scene graph.</span>

<span class="sd">        If parent_id is provided, the element is added as a child of the</span>
<span class="sd">        specified parent group. Otherwise, it&#39;s added as a top-level node.</span>

<span class="sd">        Args:</span>
<span class="sd">            element: The SceneElement to add.</span>
<span class="sd">            parent_id: The ID of the parent SceneGroup, or None for top-level.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If parent_id is specified but not found, or if the</span>
<span class="sd">                        target parent is not a SceneGroup, or if the element ID</span>
<span class="sd">                        already exists.</span>
<span class="sd">            TypeError: If the element is not a BaseSceneElement.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">BaseSceneElement</span><span class="p">):</span>
            <span class="c1"># Raise specific type error</span>
            <span class="k">raise</span> <span class="n">ElementTypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Object to add is not a BaseSceneElement subclass (got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">element</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Check for existing element using ID registry (more reliable)</span>
        <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DuplicateElementError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Element with ID &#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; already exists in the registry.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Check if element object seems already attached (should have parent=None)</span>
        <span class="c1"># This prevents adding the same *object* instance twice if somehow unregistered but still linked</span>
        <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidSceneOperationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Element &#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; already has a parent (&#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;) and cannot be added directly.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Check if it&#39;s already a top-level node (should not happen if parent is None check passes, but belt-and-suspenders)</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidSceneOperationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Element &#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; is already a top-level node.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_register_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>  <span class="c1"># Register first</span>

        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroup</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">parent_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">potential_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element_by_id</span><span class="p">(</span><span class="n">parent_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">potential_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_unregister_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>  <span class="c1"># Rollback</span>
                <span class="c1"># Raise specific error for parent not found</span>
                <span class="k">raise</span> <span class="n">ParentNotFoundError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Parent group with ID &#39;</span><span class="si">{</span><span class="n">parent_id</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">potential_parent</span><span class="p">,</span> <span class="n">SceneGroup</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_unregister_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>  <span class="c1"># Rollback</span>
                <span class="c1"># Raise specific type error for parent</span>
                <span class="k">raise</span> <span class="n">ElementTypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Specified parent &#39;</span><span class="si">{</span><span class="n">parent_id</span><span class="si">}</span><span class="s2">&#39; is not a SceneGroup (got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">potential_parent</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">potential_parent</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
                <span class="c1"># Let add_child raise its specific errors (e.g., ValueError for circular)</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="n">SceneError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Catch potential errors from add_child or _set_parent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unregister_element</span><span class="p">(</span>
                <span class="n">element</span>
            <span class="p">)</span>  <span class="c1"># Rollback registration (also invalidates resolver)</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>  <span class="c1"># Rollback adding to top-level</span>
            <span class="c1"># Re-raise the original specific error, don&#39;t wrap</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="c1"># Invalidate resolver cache if element affecting it is added</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resolver</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">remove_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes a SceneElement and its descendants from the scene graph by ID.</span>

<span class="sd">        Args:</span>
<span class="sd">            element_id: The ID of the SceneElement to remove.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the element with the given ID is not found in the scene.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element_by_id</span><span class="p">(</span><span class="n">element_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Raise specific error</span>
            <span class="k">raise</span> <span class="n">ElementNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Element with ID &#39;</span><span class="si">{</span><span class="n">element_id</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span><span class="p">)</span>

        <span class="c1"># --- Collect nodes to remove --- (No change needed here)</span>
        <span class="n">nodes_to_unregister</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nodes_to_process</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span><span class="p">]</span>

        <span class="k">while</span> <span class="n">nodes_to_process</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">nodes_to_process</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Check if already unregistered (in case of complex graph manipulations, though ideally not needed)</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">nodes_to_unregister</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">SceneGroup</span><span class="p">):</span>
                <span class="c1"># Add children to process queue (create copy for safe iteration)</span>
                <span class="n">nodes_to_process</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes_to_unregister</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unregister_element</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="c1"># --- Detach the root element --- #</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">element_was_top_level</span> <span class="o">=</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span>

        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">SceneGroup</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parent</span><span class="o">.</span><span class="n">remove_child</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># This *shouldn&#39;t* happen if graph is consistent. Treat as inconsistency.</span>
                    <span class="c1"># Log it, but also raise a specific error.</span>
                    <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="c1"># Raise inconsistency error instead of just warning</span>
                    <span class="k">raise</span> <span class="n">SceneGraphInconsistencyError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;SceneGraph Inconsistency: Element &#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; not found in supposed parent &#39;</span><span class="si">{</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; children list during removal.&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Parent reference exists but parent is invalid/unregistered.</span>
                <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="c1"># This is also an inconsistency</span>
                <span class="k">raise</span> <span class="n">SceneGraphInconsistencyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;SceneGraph Inconsistency: Parent &#39;</span><span class="si">{</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&#39; of element &#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; is invalid or unregistered during removal.&quot;</span>
                <span class="p">)</span>

        <span class="k">elif</span> <span class="n">element_was_top_level</span><span class="p">:</span>
            <span class="c1"># If it was supposed to be top-level, remove it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Element was registered, had no parent, but wasn&#39;t in top-level nodes.</span>
            <span class="c1"># This indicates an inconsistency.</span>
            <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">SceneGraphInconsistencyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SceneGraph Inconsistency: Element &#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; was registered but not found in the scene graph structure (neither parented nor top-level).&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Invalidate resolver cache since elements were removed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resolver</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">move_element</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">element_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_parent_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Moves a SceneElement identified by its ID to a new parent.</span>

<span class="sd">        Args:</span>
<span class="sd">            element_id: The ID of the SceneElement to move.</span>
<span class="sd">            new_parent_id: The ID of the new parent SceneGroup, or None to move</span>
<span class="sd">                           to the top level.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the element or new parent is not found, if the new</span>
<span class="sd">                        parent is not a SceneGroup, or if the move would create</span>
<span class="sd">                        a circular dependency.</span>
<span class="sd">            TypeError: If the target parent is not a SceneGroup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element_by_id</span><span class="p">(</span><span class="n">element_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ElementNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Element with ID &#39;</span><span class="si">{</span><span class="n">element_id</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span><span class="p">)</span>

        <span class="n">current_parent</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">new_parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroup</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">new_parent_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">potential_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element_by_id</span><span class="p">(</span><span class="n">new_parent_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">potential_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParentNotFoundError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;New parent group with ID &#39;</span><span class="si">{</span><span class="n">new_parent_id</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">potential_parent</span><span class="p">,</span> <span class="n">SceneGroup</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ElementTypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Target parent &#39;</span><span class="si">{</span><span class="n">new_parent_id</span><span class="si">}</span><span class="s2">&#39; is not a SceneGroup (got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">potential_parent</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>
            <span class="n">new_parent</span> <span class="o">=</span> <span class="n">potential_parent</span>

            <span class="c1"># Prevent circular dependency</span>
            <span class="n">temp_check</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_parent</span>
            <span class="k">while</span> <span class="n">temp_check</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">temp_check</span> <span class="ow">is</span> <span class="n">element</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CircularDependencyError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Cannot move element &#39;</span><span class="si">{</span><span class="n">element_id</span><span class="si">}</span><span class="s2">&#39; under &#39;</span><span class="si">{</span><span class="n">new_parent_id</span><span class="si">}</span><span class="s2">&#39; - would create circular dependency.&quot;</span>
                    <span class="p">)</span>
                <span class="n">temp_check</span> <span class="o">=</span> <span class="n">temp_check</span><span class="o">.</span><span class="n">parent</span>

        <span class="k">if</span> <span class="n">current_parent</span> <span class="ow">is</span> <span class="n">new_parent</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># --- Detach Phase --- #</span>
        <span class="n">element_was_in_nodes</span> <span class="o">=</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_parent</span><span class="p">:</span>
                <span class="n">current_parent</span><span class="o">.</span><span class="n">remove_child</span><span class="p">(</span>
                    <span class="n">element</span>
                <span class="p">)</span>  <span class="c1"># Let SceneGroup handle internal parent update</span>
            <span class="k">elif</span> <span class="n">element_was_in_nodes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">element</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="p">):</span>  <span class="c1"># Already detached, potentially inconsistent state</span>
                <span class="k">raise</span> <span class="n">SceneGraphInconsistencyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;SceneGraph Inconsistency: Element &#39;</span><span class="si">{</span><span class="n">element_id</span><span class="si">}</span><span class="s2">&#39; was already detached before move operation.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Should not be reachable if graph is consistent</span>
                <span class="k">raise</span> <span class="n">SceneGraphInconsistencyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;SceneGraph Inconsistency: Element &#39;</span><span class="si">{</span><span class="n">element_id</span><span class="si">}</span><span class="s2">&#39; in inconsistent state during detach phase of move.&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># If remove_child fails unexpectedly (e.g., element not found when it should be)</span>
            <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># Force detachment</span>
            <span class="k">raise</span> <span class="n">SceneGraphInconsistencyError</span><span class="p">(</span>
                <span class="s2">&quot;Scene Graph Inconsistency: &quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Error detaching &#39;</span><span class="si">{</span><span class="n">element_id</span><span class="si">}</span><span class="s2">&#39; from current parent &#39;</span><span class="si">{</span><span class="n">current_parent</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">current_parent</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>  <span class="c1"># Raise inconsistency</span>

        <span class="c1"># --- Attach Phase --- #</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_parent</span><span class="p">:</span>
                <span class="n">new_parent</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span>
                    <span class="n">element</span>
                <span class="p">)</span>  <span class="c1"># Let add_child handle parent update &amp; checks</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="n">SceneError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># If attaching fails, attempt rollback (reattach to original parent/location)</span>
            <span class="n">rollback_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to attach element &#39;</span><span class="si">{</span><span class="n">element_id</span><span class="si">}</span><span class="s2">&#39; to new parent &#39;</span><span class="si">{</span><span class="n">new_parent_id</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Attempting rollback.&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_parent</span><span class="p">:</span>
                    <span class="n">current_parent</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span>
                        <span class="n">element</span>
                    <span class="p">)</span>  <span class="c1"># Try adding back to original parent</span>
                <span class="k">elif</span> <span class="n">element_was_in_nodes</span><span class="p">:</span>  <span class="c1"># If it was originally top-level</span>
                    <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="c1"># If originally detached, leave it detached</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">rollback_e</span><span class="p">:</span>
                <span class="c1"># Rollback failed, graph is likely inconsistent</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Rollback failed after attach error for element &#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;. Scene graph may be inconsistent. Rollback error: </span><span class="si">{</span><span class="n">rollback_e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">raise</span> <span class="n">SceneGraphInconsistencyError</span><span class="p">(</span>
                    <span class="n">msg</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>  <span class="c1"># Raise inconsistency, chaining original error</span>

            <span class="k">raise</span> <span class="n">InvalidSceneOperationError</span><span class="p">(</span><span class="n">rollback_msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="c1"># Invalidate resolver cache since element position changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resolver</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs a depth-first traversal of the scene graph.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Tuple[BaseSceneElement, int]: A tuple containing the scene element</span>
<span class="sd">                                          and its depth in the tree (0 for top-level).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nodes_to_visit</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">visited_ids</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">nodes_to_visit</span><span class="p">:</span>
            <span class="n">element</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">nodes_to_visit</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="c1"># Check registry in case node was removed during traversal (unlikely but possible)</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span> <span class="ow">or</span> <span class="n">element</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">visited_ids</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">visited_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

            <span class="k">yield</span> <span class="n">element</span><span class="p">,</span> <span class="n">depth</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">SceneGroup</span><span class="p">):</span>
                <span class="c1"># Add children to the stack in reverse order to maintain visit order</span>
                <span class="c1"># Ensure children are also still registered before adding</span>
                <span class="n">children_to_add</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span>
                <span class="p">]</span>
                <span class="n">nodes_to_visit</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">children_to_add</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_all_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a flat list of all elements in the scene graph.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list containing all BaseSceneElement objects registered in the scene.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_sequential_structure_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseStructureSceneElement</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of all BaseStructureSceneElement instances in the scene,</span>
<span class="sd">        sorted sequentially by chain ID and then by starting residue index.</span>

<span class="sd">        Assumes each BaseStructureSceneElement primarily represents a single</span>
<span class="sd">        contiguous range for sorting purposes.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[BaseStructureSceneElement]: Sorted list of structure elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">structure_elements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseStructureSceneElement</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">BaseStructureSceneElement</span><span class="p">):</span>
                <span class="n">structure_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="n">BaseStructureSceneElement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
            <span class="n">primary_chain</span> <span class="o">=</span> <span class="s2">&quot;~&quot;</span>  <span class="c1"># Use ~ to sort after standard chain IDs</span>
            <span class="n">start_residue</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>  <span class="c1"># Sort elements without range last</span>

            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">residue_range_set</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">:</span>
                <span class="c1"># Use the first range (min start residue) for sorting key</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">first_range</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                        <span class="n">element</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">,</span>
                        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">chain_id</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">primary_chain</span> <span class="o">=</span> <span class="n">first_range</span><span class="o">.</span><span class="n">chain_id</span>
                    <span class="n">start_residue</span> <span class="o">=</span> <span class="n">first_range</span><span class="o">.</span><span class="n">start</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not determine sort key for element </span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> due to range issue: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Structure element </span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> has no residue range for sorting.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Return a tuple for multi-level sorting</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">primary_chain</span><span class="p">,</span> <span class="n">start_residue</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">structure_elements</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">sort_key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error sorting structure elements: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Return unsorted list in case of unexpected sorting error</span>

        <span class="k">return</span> <span class="n">structure_elements</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over the top-level nodes of the scene graph.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the total number of elements currently registered in the scene.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide a string representation of the scene.&quot;&quot;&quot;</span>
        <span class="n">structure_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>  <span class="c1"># Safely get structure ID</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;Scene structure_id=&#39;</span><span class="si">{</span><span class="n">structure_id</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;top_level_nodes=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">)</span><span class="si">}</span><span class="s2"> total_elements=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Lazily create resolver only when needed to avoid issues during Scene init</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">resolver</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CoordinateResolver</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the CoordinateResolver instance for this scene.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolver</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Pass the current element registry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resolver</span> <span class="o">=</span> <span class="n">CoordinateResolver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolver</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.Scene.resolver" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">resolver</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Get the CoordinateResolver instance for this scene.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.Scene.structure" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">structure</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Get the core Structure object associated with this scene.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.Scene.top_level_nodes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">top_level_nodes</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Get the list of top-level nodes in the scene graph.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.Scene.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Initializes the Scene with a core Structure object.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core biological structure data.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/scene.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the Scene with a core Structure object.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core biological structure data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">Structure</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Scene must be initialized with a Structure object.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="p">:</span> <span class="n">Structure</span> <span class="o">=</span> <span class="n">structure</span>
    <span class="c1"># List of top-level nodes (elements with no parent)</span>
    <span class="c1"># The order here determines the base rendering order of top-level items.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># For quick lookups by ID</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseSceneElement</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Create the coordinate resolver instance</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_resolver</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoordinateResolver</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize as None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.Scene.__iter__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__iter__</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Iterate over the top-level nodes of the scene graph.</p>


            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/scene.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iterate over the top-level nodes of the scene graph.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.Scene.__len__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__len__</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Return the total number of elements currently registered in the scene.</p>


            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/scene.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the total number of elements currently registered in the scene.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.Scene.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Provide a string representation of the scene.</p>


            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/scene.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a string representation of the scene.&quot;&quot;&quot;</span>
    <span class="n">structure_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>  <span class="c1"># Safely get structure ID</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&lt;Scene structure_id=&#39;</span><span class="si">{</span><span class="n">structure_id</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;top_level_nodes=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">)</span><span class="si">}</span><span class="s2"> total_elements=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.Scene.add_element" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_element</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Adds a SceneElement to the scene graph.</p>
<p>If parent_id is provided, the element is added as a child of the
specified parent group. Otherwise, it's added as a top-level node.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>element</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.scene.base_element.BaseSceneElement" href="#flatprot.scene.base_element.BaseSceneElement">BaseSceneElement</a></code>)
              –
              <div class="doc-md-description">
                <p>The SceneElement to add.</p>
              </div>
            </li>
            <li>
              <b><code>parent_id</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The ID of the parent SceneGroup, or None for top-level.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If parent_id is specified but not found, or if the
        target parent is not a SceneGroup, or if the element ID
        already exists.</p>
              </div>
            </li>
            <li>
                  <code><span title="TypeError">TypeError</span></code>
              –
              <div class="doc-md-description">
                <p>If the element is not a BaseSceneElement.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/scene.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_element</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="n">BaseSceneElement</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds a SceneElement to the scene graph.</span>

<span class="sd">    If parent_id is provided, the element is added as a child of the</span>
<span class="sd">    specified parent group. Otherwise, it&#39;s added as a top-level node.</span>

<span class="sd">    Args:</span>
<span class="sd">        element: The SceneElement to add.</span>
<span class="sd">        parent_id: The ID of the parent SceneGroup, or None for top-level.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If parent_id is specified but not found, or if the</span>
<span class="sd">                    target parent is not a SceneGroup, or if the element ID</span>
<span class="sd">                    already exists.</span>
<span class="sd">        TypeError: If the element is not a BaseSceneElement.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">BaseSceneElement</span><span class="p">):</span>
        <span class="c1"># Raise specific type error</span>
        <span class="k">raise</span> <span class="n">ElementTypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Object to add is not a BaseSceneElement subclass (got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">element</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">).&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Check for existing element using ID registry (more reliable)</span>
    <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DuplicateElementError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Element with ID &#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; already exists in the registry.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Check if element object seems already attached (should have parent=None)</span>
    <span class="c1"># This prevents adding the same *object* instance twice if somehow unregistered but still linked</span>
    <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidSceneOperationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Element &#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; already has a parent (&#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;) and cannot be added directly.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Check if it&#39;s already a top-level node (should not happen if parent is None check passes, but belt-and-suspenders)</span>
    <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidSceneOperationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Element &#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; is already a top-level node.&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_register_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>  <span class="c1"># Register first</span>

    <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroup</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">parent_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">potential_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element_by_id</span><span class="p">(</span><span class="n">parent_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">potential_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unregister_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>  <span class="c1"># Rollback</span>
            <span class="c1"># Raise specific error for parent not found</span>
            <span class="k">raise</span> <span class="n">ParentNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parent group with ID &#39;</span><span class="si">{</span><span class="n">parent_id</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">potential_parent</span><span class="p">,</span> <span class="n">SceneGroup</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unregister_element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>  <span class="c1"># Rollback</span>
            <span class="c1"># Raise specific type error for parent</span>
            <span class="k">raise</span> <span class="n">ElementTypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Specified parent &#39;</span><span class="si">{</span><span class="n">parent_id</span><span class="si">}</span><span class="s2">&#39; is not a SceneGroup (got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">potential_parent</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">potential_parent</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="c1"># Let add_child raise its specific errors (e.g., ValueError for circular)</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="n">SceneError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Catch potential errors from add_child or _set_parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unregister_element</span><span class="p">(</span>
            <span class="n">element</span>
        <span class="p">)</span>  <span class="c1"># Rollback registration (also invalidates resolver)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>  <span class="c1"># Rollback adding to top-level</span>
        <span class="c1"># Re-raise the original specific error, don&#39;t wrap</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="c1"># Invalidate resolver cache if element affecting it is added</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_resolver</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.Scene.get_all_elements" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_all_elements</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns a flat list of all elements in the scene graph.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="flatprot.scene.base_element.BaseSceneElement" href="#flatprot.scene.base_element.BaseSceneElement">BaseSceneElement</a>]</code>
              –
              <div class="doc-md-description">
                <p>A list containing all BaseSceneElement objects registered in the scene.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/scene.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_all_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a flat list of all elements in the scene graph.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list containing all BaseSceneElement objects registered in the scene.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.Scene.get_element_by_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_element_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrieve a scene element by its unique ID.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>id</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>The ID of the element to find.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="flatprot.scene.base_element.BaseSceneElement" href="#flatprot.scene.base_element.BaseSceneElement">BaseSceneElement</a>]</code>
              –
              <div class="doc-md-description">
                <p>The found BaseSceneElement or None if no element has that ID.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/scene.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_element_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve a scene element by its unique ID.</span>

<span class="sd">    Args:</span>
<span class="sd">        id: The ID of the element to find.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The found BaseSceneElement or None if no element has that ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.Scene.get_sequential_structure_elements" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_sequential_structure_elements</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns a list of all BaseStructureSceneElement instances in the scene,
sorted sequentially by chain ID and then by starting residue index.</p>
<p>Assumes each BaseStructureSceneElement primarily represents a single
contiguous range for sorting purposes.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="flatprot.scene.structure.BaseStructureSceneElement" href="#flatprot.scene.structure.base_structure.BaseStructureSceneElement">BaseStructureSceneElement</a>]</code>
              –
              <div class="doc-md-description">
                <p>List[BaseStructureSceneElement]: Sorted list of structure elements.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/scene.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_sequential_structure_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseStructureSceneElement</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of all BaseStructureSceneElement instances in the scene,</span>
<span class="sd">    sorted sequentially by chain ID and then by starting residue index.</span>

<span class="sd">    Assumes each BaseStructureSceneElement primarily represents a single</span>
<span class="sd">    contiguous range for sorting purposes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[BaseStructureSceneElement]: Sorted list of structure elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">structure_elements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseStructureSceneElement</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">BaseStructureSceneElement</span><span class="p">):</span>
            <span class="n">structure_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="n">element</span><span class="p">:</span> <span class="n">BaseStructureSceneElement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">primary_chain</span> <span class="o">=</span> <span class="s2">&quot;~&quot;</span>  <span class="c1"># Use ~ to sort after standard chain IDs</span>
        <span class="n">start_residue</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>  <span class="c1"># Sort elements without range last</span>

        <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">residue_range_set</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">:</span>
            <span class="c1"># Use the first range (min start residue) for sorting key</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">first_range</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">element</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">chain_id</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">primary_chain</span> <span class="o">=</span> <span class="n">first_range</span><span class="o">.</span><span class="n">chain_id</span>
                <span class="n">start_residue</span> <span class="o">=</span> <span class="n">first_range</span><span class="o">.</span><span class="n">start</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not determine sort key for element </span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> due to range issue: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Structure element </span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> has no residue range for sorting.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Return a tuple for multi-level sorting</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">primary_chain</span><span class="p">,</span> <span class="n">start_residue</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">structure_elements</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">sort_key</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error sorting structure elements: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Return unsorted list in case of unexpected sorting error</span>

    <span class="k">return</span> <span class="n">structure_elements</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.Scene.move_element" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">move_element</span><span class="p">(</span><span class="n">element_id</span><span class="p">,</span> <span class="n">new_parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Moves a SceneElement identified by its ID to a new parent.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>element_id</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>The ID of the SceneElement to move.</p>
              </div>
            </li>
            <li>
              <b><code>new_parent_id</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The ID of the new parent SceneGroup, or None to move
           to the top level.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If the element or new parent is not found, if the new
        parent is not a SceneGroup, or if the move would create
        a circular dependency.</p>
              </div>
            </li>
            <li>
                  <code><span title="TypeError">TypeError</span></code>
              –
              <div class="doc-md-description">
                <p>If the target parent is not a SceneGroup.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/scene.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">move_element</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">element_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_parent_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Moves a SceneElement identified by its ID to a new parent.</span>

<span class="sd">    Args:</span>
<span class="sd">        element_id: The ID of the SceneElement to move.</span>
<span class="sd">        new_parent_id: The ID of the new parent SceneGroup, or None to move</span>
<span class="sd">                       to the top level.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the element or new parent is not found, if the new</span>
<span class="sd">                    parent is not a SceneGroup, or if the move would create</span>
<span class="sd">                    a circular dependency.</span>
<span class="sd">        TypeError: If the target parent is not a SceneGroup.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element_by_id</span><span class="p">(</span><span class="n">element_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ElementNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Element with ID &#39;</span><span class="si">{</span><span class="n">element_id</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span><span class="p">)</span>

    <span class="n">current_parent</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">parent</span>
    <span class="n">new_parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroup</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">new_parent_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">potential_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element_by_id</span><span class="p">(</span><span class="n">new_parent_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">potential_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParentNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;New parent group with ID &#39;</span><span class="si">{</span><span class="n">new_parent_id</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">potential_parent</span><span class="p">,</span> <span class="n">SceneGroup</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ElementTypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Target parent &#39;</span><span class="si">{</span><span class="n">new_parent_id</span><span class="si">}</span><span class="s2">&#39; is not a SceneGroup (got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">potential_parent</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>
        <span class="n">new_parent</span> <span class="o">=</span> <span class="n">potential_parent</span>

        <span class="c1"># Prevent circular dependency</span>
        <span class="n">temp_check</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_parent</span>
        <span class="k">while</span> <span class="n">temp_check</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">temp_check</span> <span class="ow">is</span> <span class="n">element</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CircularDependencyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot move element &#39;</span><span class="si">{</span><span class="n">element_id</span><span class="si">}</span><span class="s2">&#39; under &#39;</span><span class="si">{</span><span class="n">new_parent_id</span><span class="si">}</span><span class="s2">&#39; - would create circular dependency.&quot;</span>
                <span class="p">)</span>
            <span class="n">temp_check</span> <span class="o">=</span> <span class="n">temp_check</span><span class="o">.</span><span class="n">parent</span>

    <span class="k">if</span> <span class="n">current_parent</span> <span class="ow">is</span> <span class="n">new_parent</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># --- Detach Phase --- #</span>
    <span class="n">element_was_in_nodes</span> <span class="o">=</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">current_parent</span><span class="p">:</span>
            <span class="n">current_parent</span><span class="o">.</span><span class="n">remove_child</span><span class="p">(</span>
                <span class="n">element</span>
            <span class="p">)</span>  <span class="c1"># Let SceneGroup handle internal parent update</span>
        <span class="k">elif</span> <span class="n">element_was_in_nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">element</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>  <span class="c1"># Already detached, potentially inconsistent state</span>
            <span class="k">raise</span> <span class="n">SceneGraphInconsistencyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SceneGraph Inconsistency: Element &#39;</span><span class="si">{</span><span class="n">element_id</span><span class="si">}</span><span class="s2">&#39; was already detached before move operation.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Should not be reachable if graph is consistent</span>
            <span class="k">raise</span> <span class="n">SceneGraphInconsistencyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SceneGraph Inconsistency: Element &#39;</span><span class="si">{</span><span class="n">element_id</span><span class="si">}</span><span class="s2">&#39; in inconsistent state during detach phase of move.&quot;</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># If remove_child fails unexpectedly (e.g., element not found when it should be)</span>
        <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># Force detachment</span>
        <span class="k">raise</span> <span class="n">SceneGraphInconsistencyError</span><span class="p">(</span>
            <span class="s2">&quot;Scene Graph Inconsistency: &quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Error detaching &#39;</span><span class="si">{</span><span class="n">element_id</span><span class="si">}</span><span class="s2">&#39; from current parent &#39;</span><span class="si">{</span><span class="n">current_parent</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">current_parent</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>  <span class="c1"># Raise inconsistency</span>

    <span class="c1"># --- Attach Phase --- #</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">new_parent</span><span class="p">:</span>
            <span class="n">new_parent</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span>
                <span class="n">element</span>
            <span class="p">)</span>  <span class="c1"># Let add_child handle parent update &amp; checks</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="n">SceneError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># If attaching fails, attempt rollback (reattach to original parent/location)</span>
        <span class="n">rollback_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to attach element &#39;</span><span class="si">{</span><span class="n">element_id</span><span class="si">}</span><span class="s2">&#39; to new parent &#39;</span><span class="si">{</span><span class="n">new_parent_id</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Attempting rollback.&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_parent</span><span class="p">:</span>
                <span class="n">current_parent</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span>
                    <span class="n">element</span>
                <span class="p">)</span>  <span class="c1"># Try adding back to original parent</span>
            <span class="k">elif</span> <span class="n">element_was_in_nodes</span><span class="p">:</span>  <span class="c1"># If it was originally top-level</span>
                <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="c1"># If originally detached, leave it detached</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">rollback_e</span><span class="p">:</span>
            <span class="c1"># Rollback failed, graph is likely inconsistent</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Rollback failed after attach error for element &#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;. Scene graph may be inconsistent. Rollback error: </span><span class="si">{</span><span class="n">rollback_e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="n">SceneGraphInconsistencyError</span><span class="p">(</span>
                <span class="n">msg</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>  <span class="c1"># Raise inconsistency, chaining original error</span>

        <span class="k">raise</span> <span class="n">InvalidSceneOperationError</span><span class="p">(</span><span class="n">rollback_msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="c1"># Invalidate resolver cache since element position changed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_resolver</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.Scene.remove_element" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">remove_element</span><span class="p">(</span><span class="n">element_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Removes a SceneElement and its descendants from the scene graph by ID.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>element_id</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>The ID of the SceneElement to remove.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If the element with the given ID is not found in the scene.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/scene.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">remove_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Removes a SceneElement and its descendants from the scene graph by ID.</span>

<span class="sd">    Args:</span>
<span class="sd">        element_id: The ID of the SceneElement to remove.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the element with the given ID is not found in the scene.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_element_by_id</span><span class="p">(</span><span class="n">element_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Raise specific error</span>
        <span class="k">raise</span> <span class="n">ElementNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Element with ID &#39;</span><span class="si">{</span><span class="n">element_id</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span><span class="p">)</span>

    <span class="c1"># --- Collect nodes to remove --- (No change needed here)</span>
    <span class="n">nodes_to_unregister</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nodes_to_process</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span><span class="p">]</span>

    <span class="k">while</span> <span class="n">nodes_to_process</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">nodes_to_process</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Check if already unregistered (in case of complex graph manipulations, though ideally not needed)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">nodes_to_unregister</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">SceneGroup</span><span class="p">):</span>
            <span class="c1"># Add children to process queue (create copy for safe iteration)</span>
            <span class="n">nodes_to_process</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes_to_unregister</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unregister_element</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="c1"># --- Detach the root element --- #</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">parent</span>
    <span class="n">element_was_top_level</span> <span class="o">=</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span>

    <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">SceneGroup</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">remove_child</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># This *shouldn&#39;t* happen if graph is consistent. Treat as inconsistency.</span>
                <span class="c1"># Log it, but also raise a specific error.</span>
                <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="c1"># Raise inconsistency error instead of just warning</span>
                <span class="k">raise</span> <span class="n">SceneGraphInconsistencyError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;SceneGraph Inconsistency: Element &#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; not found in supposed parent &#39;</span><span class="si">{</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; children list during removal.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Parent reference exists but parent is invalid/unregistered.</span>
            <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1"># This is also an inconsistency</span>
            <span class="k">raise</span> <span class="n">SceneGraphInconsistencyError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SceneGraph Inconsistency: Parent &#39;</span><span class="si">{</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&#39; of element &#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; is invalid or unregistered during removal.&quot;</span>
            <span class="p">)</span>

    <span class="k">elif</span> <span class="n">element_was_top_level</span><span class="p">:</span>
        <span class="c1"># If it was supposed to be top-level, remove it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Element was registered, had no parent, but wasn&#39;t in top-level nodes.</span>
        <span class="c1"># This indicates an inconsistency.</span>
        <span class="n">element</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">SceneGraphInconsistencyError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;SceneGraph Inconsistency: Element &#39;</span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; was registered but not found in the scene graph structure (neither parented nor top-level).&quot;</span>
        <span class="p">)</span>
    <span class="c1"># Invalidate resolver cache since elements were removed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_resolver</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.Scene.traverse" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">traverse</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Performs a depth-first traversal of the scene graph.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Yields:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-internal" title="flatprot.scene.base_element.BaseSceneElement" href="#flatprot.scene.base_element.BaseSceneElement">BaseSceneElement</a>, <span title="int">int</span>]</code>
              –
              <div class="doc-md-description">
                <p>Tuple[BaseSceneElement, int]: A tuple containing the scene element
                          and its depth in the tree (0 for top-level).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/scene.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performs a depth-first traversal of the scene graph.</span>

<span class="sd">    Yields:</span>
<span class="sd">        Tuple[BaseSceneElement, int]: A tuple containing the scene element</span>
<span class="sd">                                      and its depth in the tree (0 for top-level).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nodes_to_visit</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">BaseSceneElement</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">visited_ids</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">while</span> <span class="n">nodes_to_visit</span><span class="p">:</span>
        <span class="n">element</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">nodes_to_visit</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="c1"># Check registry in case node was removed during traversal (unlikely but possible)</span>
        <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span> <span class="ow">or</span> <span class="n">element</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">visited_ids</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">visited_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">element</span><span class="p">,</span> <span class="n">depth</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">SceneGroup</span><span class="p">):</span>
            <span class="c1"># Add children to the stack in reverse order to maintain visit order</span>
            <span class="c1"># Ensure children are also still registered before adding</span>
            <span class="n">children_to_add</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_element_registry</span>
            <span class="p">]</span>
            <span class="n">nodes_to_visit</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">children_to_add</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>options:
show_root_heading: true
members_order: source</p>
<h2 id="base-classes">Base Classes</h2>
<p>Abstract base classes for elements and styles within the scene.</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.base_element.BaseSceneElement"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code>, <code><span title="typing.Generic">Generic</span>[<span title="flatprot.scene.base_element.StyleType">StyleType</span>]</code></p>


        <p>Abstract base class for all elements within a scene graph.</p>
<p>This class is generic and requires a specific StyleType that inherits
from BaseSceneStyle.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/base_element.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">BaseSceneElement</span><span class="p">(</span><span class="n">ABC</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">StyleType</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for all elements within a scene graph.</span>

<span class="sd">    This class is generic and requires a specific StyleType that inherits</span>
<span class="sd">    from BaseSceneStyle.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StyleType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes a BaseSceneElement.</span>

<span class="sd">        Args:</span>
<span class="sd">            id: A unique identifier for this scene element.</span>
<span class="sd">            style: A style instance for this element.</span>
<span class="sd">            parent: The parent SceneGroup in the scene graph, if any.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;SceneElement ID must be a non-empty string.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StyleType</span><span class="p">]</span> <span class="o">=</span> <span class="n">style</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the parent group of this element.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>

    <span class="c1"># Keep internal setter for parent relationship management by Scene/SceneGroup</span>
    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal method to set the parent group. Should be called by Scene/SceneGroup.&quot;&quot;&quot;</span>
        <span class="c1"># Basic type check, assumes SceneGroup will inherit from BaseSceneElement</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">BaseSceneElement</span><span class="p">):</span>
            <span class="c1"># A more specific check like isinstance(value, SceneGroup) would be ideal</span>
            <span class="c1"># but causes circular dependency issues without careful structuring or protocols.</span>
            <span class="c1"># This provides a basic safeguard. We expect SceneGroup to inherit BaseSceneElement.</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Parent must be a SceneGroup (subclass of BaseSceneElement).&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">default_style</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StyleType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides the default style instance for this element type.</span>

<span class="sd">        Subclasses must implement this property.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An instance of the specific StyleType for this element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">style</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StyleType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the effective style for this element (instance-specific or default).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_style</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_style</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">update_style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_style</span><span class="p">:</span> <span class="n">StyleType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the instance-specific style of this element.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_style: The new style object to apply.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure the provided style is compatible</span>
        <span class="c1"># Note: isinstance check might be too strict if subclasses of the style are allowed.</span>
        <span class="c1"># Adjust check if necessary based on desired style inheritance behavior.</span>
        <span class="n">expected_style_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_style</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_style</span><span class="p">,</span> <span class="n">expected_style_type</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid style type. Expected </span><span class="si">{</span><span class="n">expected_style_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">new_style</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_style</span> <span class="o">=</span> <span class="n">new_style</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate or retrieve the representative depth for Z-ordering.</span>

<span class="sd">        Depth should typically be derived from the pre-projected coordinates</span>
<span class="sd">        (column 2) in the provided structure object.</span>
<span class="sd">        Lower values are typically closer to the viewer.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object containing pre-projected</span>
<span class="sd">                       2D + Depth coordinate data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A float representing the depth, or None if depth cannot be determined</span>
<span class="sd">            or is not applicable (e.g., for groups).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide a string representation of the scene element.&quot;&quot;&quot;</span>
        <span class="n">parent_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">style_source</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_style</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;instance&quot;</span>
        <span class="c1"># Safely get range representation, default to &#39;N/A&#39; if not present</span>
        <span class="n">range_repr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;residue_range_set&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">))</span>
        <span class="n">range_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; range=&#39;</span><span class="si">{</span><span class="n">range_repr</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="n">range_repr</span> <span class="o">!=</span> <span class="s2">&quot;N/A&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">target_repr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">))</span>
        <span class="n">target_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; target=&#39;</span><span class="si">{</span><span class="n">target_repr</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="n">target_repr</span> <span class="o">!=</span> <span class="s2">&quot;N/A&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> id=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">range_str</span><span class="si">}{</span><span class="n">target_str</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;parent=</span><span class="si">{</span><span class="n">parent_id</span><span class="si">}</span><span class="s2"> style_source=</span><span class="si">{</span><span class="n">style_source</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.base_element.BaseSceneElement.default_style" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_style</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Provides the default style instance for this element type.</p>
<p>Subclasses must implement this property.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="flatprot.scene.base_element.StyleType">StyleType</span></code>
              –
              <div class="doc-md-description">
                <p>An instance of the specific StyleType for this element.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.base_element.BaseSceneElement.parent" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">parent</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Get the parent group of this element.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.base_element.BaseSceneElement.style" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">style</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Get the effective style for this element (instance-specific or default).</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.base_element.BaseSceneElement.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Initializes a BaseSceneElement.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>id</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>A unique identifier for this scene element.</p>
              </div>
            </li>
            <li>
              <b><code>style</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="flatprot.scene.base_element.StyleType">StyleType</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>A style instance for this element.</p>
              </div>
            </li>
            <li>
              <b><code>parent</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="flatprot.scene.base_element.SceneGroupType">SceneGroupType</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The parent SceneGroup in the scene graph, if any.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/base_element.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StyleType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes a BaseSceneElement.</span>

<span class="sd">    Args:</span>
<span class="sd">        id: A unique identifier for this scene element.</span>
<span class="sd">        style: A style instance for this element.</span>
<span class="sd">        parent: The parent SceneGroup in the scene graph, if any.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">id</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;SceneElement ID must be a non-empty string.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StyleType</span><span class="p">]</span> <span class="o">=</span> <span class="n">style</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_style</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.base_element.BaseSceneElement.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Provide a string representation of the scene element.</p>


            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/base_element.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a string representation of the scene element.&quot;&quot;&quot;</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">style_source</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_style</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;instance&quot;</span>
    <span class="c1"># Safely get range representation, default to &#39;N/A&#39; if not present</span>
    <span class="n">range_repr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;residue_range_set&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">))</span>
    <span class="n">range_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; range=&#39;</span><span class="si">{</span><span class="n">range_repr</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="n">range_repr</span> <span class="o">!=</span> <span class="s2">&quot;N/A&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">target_repr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">))</span>
    <span class="n">target_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; target=&#39;</span><span class="si">{</span><span class="n">target_repr</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="n">target_repr</span> <span class="o">!=</span> <span class="s2">&quot;N/A&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> id=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">range_str</span><span class="si">}{</span><span class="n">target_str</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;parent=</span><span class="si">{</span><span class="n">parent_id</span><span class="si">}</span><span class="s2"> style_source=</span><span class="si">{</span><span class="n">style_source</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.base_element.BaseSceneElement.get_depth" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_depth</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate or retrieve the representative depth for Z-ordering.</p>
<p>Depth should typically be derived from the pre-projected coordinates
(column 2) in the provided structure object.
Lower values are typically closer to the viewer.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.structure.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing pre-projected
       2D + Depth coordinate data.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
              –
              <div class="doc-md-description">
                <p>A float representing the depth, or None if depth cannot be determined</p>
              </div>
            </li>
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
              –
              <div class="doc-md-description">
                <p>or is not applicable (e.g., for groups).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/base_element.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">get_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate or retrieve the representative depth for Z-ordering.</span>

<span class="sd">    Depth should typically be derived from the pre-projected coordinates</span>
<span class="sd">    (column 2) in the provided structure object.</span>
<span class="sd">    Lower values are typically closer to the viewer.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object containing pre-projected</span>
<span class="sd">                   2D + Depth coordinate data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A float representing the depth, or None if depth cannot be determined</span>
<span class="sd">        or is not applicable (e.g., for groups).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.base_element.BaseSceneElement.update_style" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_style</span><span class="p">(</span><span class="n">new_style</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Update the instance-specific style of this element.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>new_style</code></b>
                  (<code><span title="flatprot.scene.base_element.StyleType">StyleType</span></code>)
              –
              <div class="doc-md-description">
                <p>The new style object to apply.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/base_element.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_style</span><span class="p">:</span> <span class="n">StyleType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the instance-specific style of this element.</span>

<span class="sd">    Args:</span>
<span class="sd">        new_style: The new style object to apply.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ensure the provided style is compatible</span>
    <span class="c1"># Note: isinstance check might be too strict if subclasses of the style are allowed.</span>
    <span class="c1"># Adjust check if necessary based on desired style inheritance behavior.</span>
    <span class="n">expected_style_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_style</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_style</span><span class="p">,</span> <span class="n">expected_style_type</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid style type. Expected </span><span class="si">{</span><span class="n">expected_style_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">new_style</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_style</span> <span class="o">=</span> <span class="n">new_style</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>options:
show_root_heading: true
members_order: source</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.base_element.BaseSceneStyle"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>


        <p>Base class for all scene element style definitions using Pydantic.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/base_element.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">BaseSceneStyle</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for all scene element style definitions using Pydantic.&quot;&quot;&quot;</span>

    <span class="n">visibility</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Whether the element is visible.&quot;</span>
    <span class="p">)</span>
    <span class="n">opacity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Opacity of the element (0.0 to 1.0).&quot;</span>
    <span class="p">)</span>
    <span class="c1"># Add other common style attributes here if needed later</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;extra&quot;</span><span class="p">:</span> <span class="s2">&quot;forbid&quot;</span><span class="p">}</span>  <span class="c1"># Forbid extra fields</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div><p>options:
show_root_heading: true
members_order: source</p>
<h2 id="structure-elements">Structure Elements</h2>
<p>Classes representing secondary structure elements within the scene.</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.structure.base_structure.BaseStructureSceneElement"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.base_element.BaseSceneElement" href="#flatprot.scene.base_element.BaseSceneElement">BaseSceneElement</a>[<span title="flatprot.scene.structure.base_structure.StructureStyleType">StructureStyleType</span>]</code>, <code><span title="abc.ABC">ABC</span></code>, <code><span title="typing.Generic">Generic</span>[<span title="flatprot.scene.structure.base_structure.StructureStyleType">StructureStyleType</span>]</code></p>


        <p>Abstract base class for scene elements representing structural components.</p>
<p>Automatically generates an ID based on the subclass type and residue range.
Requires a concrete style type inheriting from BaseStructureStyle.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/structure/base_structure.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">BaseStructureSceneElement</span><span class="p">(</span>
    <span class="n">BaseSceneElement</span><span class="p">[</span><span class="n">StructureStyleType</span><span class="p">],</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">StructureStyleType</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for scene elements representing structural components.</span>

<span class="sd">    Automatically generates an ID based on the subclass type and residue range.</span>
<span class="sd">    Requires a concrete style type inheriting from BaseStructureStyle.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">residue_range_set</span><span class="p">:</span> <span class="n">ResidueRangeSet</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StructureStyleType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes a BaseStructureSceneElement.</span>

<span class="sd">        The ID is generated automatically based on the concrete subclass name</span>
<span class="sd">        and the provided residue range set.</span>

<span class="sd">        Args:</span>
<span class="sd">            residue_range_set: The set of residue ranges this element represents.</span>
<span class="sd">            style: An optional specific style instance for this element. If None,</span>
<span class="sd">                   the default style defined by the subclass&#39;s `default_style`</span>
<span class="sd">                   property will be used at access time.</span>
<span class="sd">            metadata: Optional dictionary for storing arbitrary metadata.</span>
<span class="sd">            parent: The parent SceneGroup in the scene graph, if any.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate the ID *before* calling super().__init__</span>
        <span class="c1"># Uses the concrete class&#39;s name (e.g., &quot;Helix&quot;)</span>
        <span class="n">generated_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">residue_range_set</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span> <span class="o">=</span> <span class="n">residue_range_set</span>
        <span class="c1"># Pass the potentially None style to the BaseSceneElement constructor.</span>
        <span class="c1"># BaseSceneElement&#39;s `style` property handles returning the default</span>
        <span class="c1"># style if the instance&#39;s `_style` attribute is None.</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">generated_id</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>  <span class="c1"># Pass the direct input style (can be None)</span>
            <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_generate_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="n">residue_range_set</span><span class="p">:</span> <span class="n">ResidueRangeSet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates a unique ID based on class name and residue range set.&quot;&quot;&quot;</span>
        <span class="c1"># Ensure the string representation of the range set is canonical and ID-friendly</span>
        <span class="c1"># Replace spaces, commas, and colons to create a valid identifier part.</span>
        <span class="c1"># Sorting ranges within the set ensures canonical representation if order matters.</span>
        <span class="c1"># Assuming ResidueRangeSet.__str__ provides a consistent, sorted representation.</span>
        <span class="n">range_repr</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">residue_range_set</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">range_repr</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the final 2D + Depth coordinates for rendering this element.</span>

<span class="sd">        Implementations should use the element&#39;s `residue_range_set` to query</span>
<span class="sd">        the provided `structure` object (which is assumed to already contain</span>
<span class="sd">        projected 2D + Depth coordinates) and return the relevant slice or</span>
<span class="sd">        a simplified representation (e.g., lines for coils) based on these</span>
<span class="sd">        pre-projected coordinates.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object containing pre-projected</span>
<span class="sd">                       2D + Depth coordinate data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array of 2D + Depth coordinates (shape [N, 3] or similar)</span>
<span class="sd">            suitable for rendering (X, Y, Depth).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1"># Concrete subclasses (Helix, Sheet, etc.) MUST implement default_style</span>
    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">default_style</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StructureStyleType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides the default style instance for this specific element type.</span>

<span class="sd">        Concrete subclasses (e.g., Helix, Sheet) must implement this property.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An instance of the specific StyleType (e.g., HelixStyle) for this element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">get_coordinate_at_residue</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">residue</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves the specific 2D canvas coordinate + Depth corresponding</span>
<span class="sd">        to a given residue, derived from the pre-projected coordinates in the</span>
<span class="sd">        structure object.</span>

<span class="sd">        This default implementation assumes a direct mapping between the residue</span>
<span class="sd">        index and the corresponding entry in the main structure.coordinates array.</span>
<span class="sd">        Subclasses that implement complex coordinate calculations or simplifications</span>
<span class="sd">        in their `get_coordinates` method (e.g., smoothing, interpolation)</span>
<span class="sd">        MAY NEED TO OVERRIDE this method to provide the correct mapping to their</span>
<span class="sd">        specific rendered representation.</span>

<span class="sd">        Args:</span>
<span class="sd">            residue: The residue coordinate (chain and index) to find the 2D point for.</span>
<span class="sd">            structure: The core Structure object containing pre-projected 2D + Depth data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array representing the calculated 2D coordinate + Depth (e.g., [X, Y, Depth]),</span>
<span class="sd">            or None if the residue is not found or its coordinate cannot be determined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Check if the residue belongs to the range represented by this element</span>
            <span class="k">if</span> <span class="n">residue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Residue </span><span class="si">{</span><span class="n">residue</span><span class="si">}</span><span class="s2"> not in range set </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="si">}</span><span class="s2"> for element &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">chain</span> <span class="o">=</span> <span class="n">structure</span><span class="p">[</span><span class="n">residue</span><span class="o">.</span><span class="n">chain_id</span><span class="p">]</span>

            <span class="c1"># Check if the residue index exists in this chain&#39;s mapping</span>
            <span class="k">if</span> <span class="n">residue</span><span class="o">.</span><span class="n">residue_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Residue </span><span class="si">{</span><span class="n">residue</span><span class="si">}</span><span class="s2"> not in chain </span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s2"> for element &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">coord_index</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">coordinate_index</span><span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">residue_index</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">coord_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)):</span>
                <span class="n">struct_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Coordinate index </span><span class="si">{</span><span class="n">coord_index</span><span class="si">}</span><span class="s2"> out of bounds for residue </span><span class="si">{</span><span class="n">residue</span><span class="si">}</span><span class="s2"> in structure &#39;</span><span class="si">{</span><span class="n">struct_id</span><span class="si">}</span><span class="s2">&#39; (element &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;).&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">structure</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">coord_index</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Residue </span><span class="si">{</span><span class="n">residue</span><span class="si">}</span><span class="s2"> not in chain </span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s2"> for element &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">struct_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error retrieving coordinate for </span><span class="si">{</span><span class="n">residue</span><span class="si">}</span><span class="s2"> in structure &#39;</span><span class="si">{</span><span class="n">struct_id</span><span class="si">}</span><span class="s2">&#39; (element &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="k">def</span> <span class="nf">get_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the mean depth of this structural element.</span>

<span class="sd">        Calculates the mean of the depth values (column 2) of the</span>
<span class="sd">        pre-projected coordinates corresponding to the residues in the</span>
<span class="sd">        element&#39;s residue_range_set.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object containing pre-projected</span>
<span class="sd">                       2D + Depth coordinate data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The mean depth as a float, or None if no coordinates are found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get coordinates directly from the element&#39;s get_coordinates method</span>
        <span class="c1"># which handles different element types appropriately</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Extract depth values (Z-coordinate) from the coordinates</span>
        <span class="n">depths</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">depths</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">is_adjacent_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;BaseStructureSceneElement&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this element is adjacent to another element.</span>

<span class="sd">        Args:</span>
<span class="sd">            other: The other element to check adjacency with.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if the elements are adjacent, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">BaseStructureSceneElement</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot check adjacency with </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">is_adjacent_to</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">residue_range_set</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_start_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the 2D coordinate (X, Y) of the start connection point.</span>

<span class="sd">        This is typically the coordinate corresponding to the first residue</span>
<span class="sd">        in the element&#39;s range, projected onto the 2D canvas.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object with pre-projected coordinates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array [X, Y] or None if not applicable/determinable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_end_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the 2D coordinate (X, Y) of the end connection point.</span>

<span class="sd">        This is typically the coordinate corresponding to the last residue</span>
<span class="sd">        in the element&#39;s range, projected onto the 2D canvas.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object with pre-projected coordinates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array [X, Y] or None if not applicable/determinable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.structure.base_structure.BaseStructureSceneElement.default_style" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_style</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Provides the default style instance for this specific element type.</p>
<p>Concrete subclasses (e.g., Helix, Sheet) must implement this property.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="flatprot.scene.structure.base_structure.StructureStyleType">StructureStyleType</span></code>
              –
              <div class="doc-md-description">
                <p>An instance of the specific StyleType (e.g., HelixStyle) for this element.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
    </div>

</div>



<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.base_structure.BaseStructureSceneElement.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">residue_range_set</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Initializes a BaseStructureSceneElement.</p>
<p>The ID is generated automatically based on the concrete subclass name
and the provided residue range set.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>residue_range_set</code></b>
                  (<code><a class="autorefs autorefs-internal" title="ResidueRangeSet (flatprot.core.ResidueRangeSet)" href="../core/#flatprot.core.coordinates.ResidueRangeSet">ResidueRangeSet</a></code>)
              –
              <div class="doc-md-description">
                <p>The set of residue ranges this element represents.</p>
              </div>
            </li>
            <li>
              <b><code>style</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="flatprot.scene.structure.base_structure.StructureStyleType">StructureStyleType</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>An optional specific style instance for this element. If None,
   the default style defined by the subclass's <code>default_style</code>
   property will be used at access time.</p>
              </div>
            </li>
            <li>
              <b><code>metadata</code></b>
              –
              <div class="doc-md-description">
                <p>Optional dictionary for storing arbitrary metadata.</p>
              </div>
            </li>
            <li>
              <b><code>parent</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="flatprot.scene.base_element.SceneGroupType">SceneGroupType</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The parent SceneGroup in the scene graph, if any.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/base_structure.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">residue_range_set</span><span class="p">:</span> <span class="n">ResidueRangeSet</span><span class="p">,</span>
    <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StructureStyleType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes a BaseStructureSceneElement.</span>

<span class="sd">    The ID is generated automatically based on the concrete subclass name</span>
<span class="sd">    and the provided residue range set.</span>

<span class="sd">    Args:</span>
<span class="sd">        residue_range_set: The set of residue ranges this element represents.</span>
<span class="sd">        style: An optional specific style instance for this element. If None,</span>
<span class="sd">               the default style defined by the subclass&#39;s `default_style`</span>
<span class="sd">               property will be used at access time.</span>
<span class="sd">        metadata: Optional dictionary for storing arbitrary metadata.</span>
<span class="sd">        parent: The parent SceneGroup in the scene graph, if any.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate the ID *before* calling super().__init__</span>
    <span class="c1"># Uses the concrete class&#39;s name (e.g., &quot;Helix&quot;)</span>
    <span class="n">generated_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">residue_range_set</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span> <span class="o">=</span> <span class="n">residue_range_set</span>
    <span class="c1"># Pass the potentially None style to the BaseSceneElement constructor.</span>
    <span class="c1"># BaseSceneElement&#39;s `style` property handles returning the default</span>
    <span class="c1"># style if the instance&#39;s `_style` attribute is None.</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">generated_id</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>  <span class="c1"># Pass the direct input style (can be None)</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.base_structure.BaseStructureSceneElement.get_coordinate_at_residue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_coordinate_at_residue</span><span class="p">(</span><span class="n">residue</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrieves the specific 2D canvas coordinate + Depth corresponding
to a given residue, derived from the pre-projected coordinates in the
structure object.</p>
<p>This default implementation assumes a direct mapping between the residue
index and the corresponding entry in the main structure.coordinates array.
Subclasses that implement complex coordinate calculations or simplifications
in their <code>get_coordinates</code> method (e.g., smoothing, interpolation)
MAY NEED TO OVERRIDE this method to provide the correct mapping to their
specific rendered representation.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>residue</code></b>
                  (<code><a class="autorefs autorefs-internal" title="ResidueCoordinate


  
      dataclass
   (flatprot.core.ResidueCoordinate)" href="../core/#flatprot.core.coordinates.ResidueCoordinate">ResidueCoordinate</a></code>)
              –
              <div class="doc-md-description">
                <p>The residue coordinate (chain and index) to find the 2D point for.</p>
              </div>
            </li>
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing pre-projected 2D + Depth data.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array representing the calculated 2D coordinate + Depth (e.g., [X, Y, Depth]),</p>
              </div>
            </li>
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>or None if the residue is not found or its coordinate cannot be determined.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/base_structure.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_coordinate_at_residue</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">residue</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves the specific 2D canvas coordinate + Depth corresponding</span>
<span class="sd">    to a given residue, derived from the pre-projected coordinates in the</span>
<span class="sd">    structure object.</span>

<span class="sd">    This default implementation assumes a direct mapping between the residue</span>
<span class="sd">    index and the corresponding entry in the main structure.coordinates array.</span>
<span class="sd">    Subclasses that implement complex coordinate calculations or simplifications</span>
<span class="sd">    in their `get_coordinates` method (e.g., smoothing, interpolation)</span>
<span class="sd">    MAY NEED TO OVERRIDE this method to provide the correct mapping to their</span>
<span class="sd">    specific rendered representation.</span>

<span class="sd">    Args:</span>
<span class="sd">        residue: The residue coordinate (chain and index) to find the 2D point for.</span>
<span class="sd">        structure: The core Structure object containing pre-projected 2D + Depth data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array representing the calculated 2D coordinate + Depth (e.g., [X, Y, Depth]),</span>
<span class="sd">        or None if the residue is not found or its coordinate cannot be determined.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if the residue belongs to the range represented by this element</span>
        <span class="k">if</span> <span class="n">residue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Residue </span><span class="si">{</span><span class="n">residue</span><span class="si">}</span><span class="s2"> not in range set </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="si">}</span><span class="s2"> for element &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">chain</span> <span class="o">=</span> <span class="n">structure</span><span class="p">[</span><span class="n">residue</span><span class="o">.</span><span class="n">chain_id</span><span class="p">]</span>

        <span class="c1"># Check if the residue index exists in this chain&#39;s mapping</span>
        <span class="k">if</span> <span class="n">residue</span><span class="o">.</span><span class="n">residue_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Residue </span><span class="si">{</span><span class="n">residue</span><span class="si">}</span><span class="s2"> not in chain </span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s2"> for element &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">coord_index</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">coordinate_index</span><span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">residue_index</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">coord_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)):</span>
            <span class="n">struct_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Coordinate index </span><span class="si">{</span><span class="n">coord_index</span><span class="si">}</span><span class="s2"> out of bounds for residue </span><span class="si">{</span><span class="n">residue</span><span class="si">}</span><span class="s2"> in structure &#39;</span><span class="si">{</span><span class="n">struct_id</span><span class="si">}</span><span class="s2">&#39; (element &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;).&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">structure</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">coord_index</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Residue </span><span class="si">{</span><span class="n">residue</span><span class="si">}</span><span class="s2"> not in chain </span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s2"> for element &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">struct_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Error retrieving coordinate for </span><span class="si">{</span><span class="n">residue</span><span class="si">}</span><span class="s2"> in structure &#39;</span><span class="si">{</span><span class="n">struct_id</span><span class="si">}</span><span class="s2">&#39; (element &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.base_structure.BaseStructureSceneElement.get_coordinates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Retrieve the final 2D + Depth coordinates for rendering this element.</p>
<p>Implementations should use the element's <code>residue_range_set</code> to query
the provided <code>structure</code> object (which is assumed to already contain
projected 2D + Depth coordinates) and return the relevant slice or
a simplified representation (e.g., lines for coils) based on these
pre-projected coordinates.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing pre-projected
       2D + Depth coordinate data.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array of 2D + Depth coordinates (shape [N, 3] or similar)</p>
              </div>
            </li>
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>suitable for rendering (X, Y, Depth).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/base_structure.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the final 2D + Depth coordinates for rendering this element.</span>

<span class="sd">    Implementations should use the element&#39;s `residue_range_set` to query</span>
<span class="sd">    the provided `structure` object (which is assumed to already contain</span>
<span class="sd">    projected 2D + Depth coordinates) and return the relevant slice or</span>
<span class="sd">    a simplified representation (e.g., lines for coils) based on these</span>
<span class="sd">    pre-projected coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object containing pre-projected</span>
<span class="sd">                   2D + Depth coordinate data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array of 2D + Depth coordinates (shape [N, 3] or similar)</span>
<span class="sd">        suitable for rendering (X, Y, Depth).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.base_structure.BaseStructureSceneElement.get_depth" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_depth</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate the mean depth of this structural element.</p>
<p>Calculates the mean of the depth values (column 2) of the
pre-projected coordinates corresponding to the residues in the
element's residue_range_set.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing pre-projected
       2D + Depth coordinate data.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
              –
              <div class="doc-md-description">
                <p>The mean depth as a float, or None if no coordinates are found.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/base_structure.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the mean depth of this structural element.</span>

<span class="sd">    Calculates the mean of the depth values (column 2) of the</span>
<span class="sd">    pre-projected coordinates corresponding to the residues in the</span>
<span class="sd">    element&#39;s residue_range_set.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object containing pre-projected</span>
<span class="sd">                   2D + Depth coordinate data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The mean depth as a float, or None if no coordinates are found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get coordinates directly from the element&#39;s get_coordinates method</span>
    <span class="c1"># which handles different element types appropriately</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Extract depth values (Z-coordinate) from the coordinates</span>
    <span class="n">depths</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">depths</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.base_structure.BaseStructureSceneElement.get_end_connection_point" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_end_connection_point</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Get the 2D coordinate (X, Y) of the end connection point.</p>
<p>This is typically the coordinate corresponding to the last residue
in the element's range, projected onto the 2D canvas.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object with pre-projected coordinates.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array [X, Y] or None if not applicable/determinable.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/base_structure.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">get_end_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the 2D coordinate (X, Y) of the end connection point.</span>

<span class="sd">    This is typically the coordinate corresponding to the last residue</span>
<span class="sd">    in the element&#39;s range, projected onto the 2D canvas.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object with pre-projected coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array [X, Y] or None if not applicable/determinable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.base_structure.BaseStructureSceneElement.get_start_connection_point" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_start_connection_point</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Get the 2D coordinate (X, Y) of the start connection point.</p>
<p>This is typically the coordinate corresponding to the first residue
in the element's range, projected onto the 2D canvas.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object with pre-projected coordinates.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array [X, Y] or None if not applicable/determinable.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/base_structure.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">get_start_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the 2D coordinate (X, Y) of the start connection point.</span>

<span class="sd">    This is typically the coordinate corresponding to the first residue</span>
<span class="sd">    in the element&#39;s range, projected onto the 2D canvas.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object with pre-projected coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array [X, Y] or None if not applicable/determinable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.base_structure.BaseStructureSceneElement.is_adjacent_to" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_adjacent_to</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Check if this element is adjacent to another element.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>other</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.scene.structure.base_structure.BaseStructureSceneElement" href="#flatprot.scene.structure.base_structure.BaseStructureSceneElement">BaseStructureSceneElement</a></code>)
              –
              <div class="doc-md-description">
                <p>The other element to check adjacency with.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="bool">bool</span></code>
              –
              <div class="doc-md-description">
                <p>True if the elements are adjacent, False otherwise.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/base_structure.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_adjacent_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;BaseStructureSceneElement&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if this element is adjacent to another element.</span>

<span class="sd">    Args:</span>
<span class="sd">        other: The other element to check adjacency with.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if the elements are adjacent, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">BaseStructureSceneElement</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot check adjacency with </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">is_adjacent_to</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">residue_range_set</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.structure.base_structure.BaseStructureStyle"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.base_element.BaseSceneStyle" href="#flatprot.scene.base_element.BaseSceneStyle">BaseSceneStyle</a></code></p>


        <p>Base style for elements representing parts of the protein structure.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/structure/base_structure.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">BaseStructureStyle</span><span class="p">(</span><span class="n">BaseSceneStyle</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base style for elements representing parts of the protein structure.&quot;&quot;&quot;</span>

    <span class="n">color</span><span class="p">:</span> <span class="n">Color</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">Color</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Default color for the element (hex string). Grey.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">stroke_color</span><span class="p">:</span> <span class="n">Color</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">Color</span><span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Color for the stroke (hex string). Black.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">stroke_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Line width for stroke.&quot;</span>
    <span class="p">)</span>
    <span class="n">opacity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Opacity for the element.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.structure.helix.HelixSceneElement"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.structure.base_structure.BaseStructureSceneElement" href="#flatprot.scene.structure.base_structure.BaseStructureSceneElement">BaseStructureSceneElement</a>[<a class="autorefs autorefs-internal" title="flatprot.scene.structure.helix.HelixStyle" href="#flatprot.scene.structure.helix.HelixStyle">HelixStyle</a>]</code></p>


        <p>Represents an Alpha Helix segment, visualized as a zigzag ribbon.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/structure/helix.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">HelixSceneElement</span><span class="p">(</span><span class="n">BaseStructureSceneElement</span><span class="p">[</span><span class="n">HelixStyle</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents an Alpha Helix segment, visualized as a zigzag ribbon.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">residue_range_set</span><span class="p">:</span> <span class="n">ResidueRangeSet</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HelixStyle</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the HelixSceneElement.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">residue_range_set</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="c1"># Cache for the calculated zigzag coordinates and original length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_style</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HelixStyle</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides the default style for Helix elements.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HelixStyle</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_original_coords_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper to extract the original coordinate slice for this helix.&quot;&quot;&quot;</span>
        <span class="n">coords_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">:</span>
            <span class="c1"># Cannot get coordinates if no ranges are defined.</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot get coordinates for Helix &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;: no residue ranges defined.&quot;</span>
            <span class="p">)</span>
        <span class="n">helix_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="n">structure</span><span class="p">[</span><span class="n">helix_range</span><span class="o">.</span><span class="n">chain_id</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">res_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">helix_range</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">helix_range</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">res_idx</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
                    <span class="n">coord_idx</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">coordinate_index</span><span class="p">(</span><span class="n">res_idx</span><span class="p">)</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">coord_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">coordinates</span><span class="p">):</span>
                        <span class="n">coords_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">coord_idx</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Coordinate index out of bounds.</span>
                        <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Coordinate index </span><span class="si">{</span><span class="n">coord_idx</span><span class="si">}</span><span class="s2"> out of bounds for residue </span><span class="si">{</span><span class="n">helix_range</span><span class="o">.</span><span class="n">chain_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">res_idx</span><span class="si">}</span><span class="s2"> in structure.&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Residue not found in chain coordinate map.</span>
                    <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Residue </span><span class="si">{</span><span class="n">helix_range</span><span class="o">.</span><span class="n">chain_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">res_idx</span><span class="si">}</span><span class="s2"> not found in chain coordinate map.&quot;</span>
                    <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Error fetching coordinates</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error fetching coordinates for helix &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">coords_list</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the 2D + Depth coordinates for the helix zigzag ribbon.</span>

<span class="sd">        Calculates the ribbon shape based on start/end points of the pre-projected</span>
<span class="sd">        coordinate slice and style parameters. Handles minimum length.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object containing pre-projected data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array of the ribbon outline coordinates [X, Y, Depth],</span>
<span class="sd">            or a simple line [start, end] if below min_helix_length.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>

        <span class="n">original_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_original_coords_slice</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">original_coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_coords</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># If only one residue, return just that point</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">original_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>

        <span class="c1"># If too short, return a simple line (start and end points)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">min_helix_length</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">original_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">original_coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>

        <span class="c1"># Calculate zigzag points</span>
        <span class="n">start_point_3d</span> <span class="o">=</span> <span class="n">original_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_point_3d</span> <span class="o">=</span> <span class="n">original_coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">zigzag_coords</span> <span class="o">=</span> <span class="n">calculate_zigzag_points</span><span class="p">(</span>
            <span class="n">start_point_3d</span><span class="p">,</span>
            <span class="n">end_point_3d</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">ribbon_thickness</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">amplitude</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">zigzag_coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">&gt;=</span> <span class="mi">2</span>
        <span class="p">):</span>  <span class="c1"># Log only if zigzag expected but failed</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not generate zigzag points for helix &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; (length=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="si">}</span><span class="s2">), likely zero length between endpoints.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="n">zigzag_coords</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>

    <span class="k">def</span> <span class="nf">get_coordinate_at_residue</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">residue</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves the specific 2D coordinate + Depth corresponding to a residue</span>
<span class="sd">        along the central axis of the helix representation.</span>

<span class="sd">        For short helices, interpolates linearly. For zigzag helices, finds the</span>
<span class="sd">        midpoint between the top and bottom ribbon points at the corresponding position.</span>

<span class="sd">        Args:</span>
<span class="sd">            residue: The residue coordinate (chain and index) to find the point for.</span>
<span class="sd">            structure: The core Structure object containing pre-projected data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array [X, Y, Depth] corresponding to the residue&#39;s position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. Ensure display coordinates are calculated</span>
        <span class="n">display_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">display_coords</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># 2. Check if residue is within the element&#39;s range</span>
        <span class="k">if</span> <span class="n">residue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">element_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Assuming single range</span>
        <span class="k">if</span> <span class="n">residue</span><span class="o">.</span><span class="n">chain_id</span> <span class="o">!=</span> <span class="n">element_range</span><span class="o">.</span><span class="n">chain_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># 3. Calculate the 0-based index within the original sequence length</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">original_sequence_index</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">residue_index</span> <span class="o">-</span> <span class="n">element_range</span><span class="o">.</span><span class="n">start</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">original_sequence_index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Handle single point case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">display_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Should be shape (1, 3)</span>

        <span class="c1"># 4. Handle the case where a simple line was drawn</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Linear interpolation along the line</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="n">original_sequence_index</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">interpolated_coord</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">display_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span> <span class="o">+</span> <span class="n">display_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">frac</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">interpolated_coord</span>

        <span class="c1"># 5. Handle the zigzag ribbon case</span>
        <span class="c1"># display_coords contains top points then bottom points reversed</span>
        <span class="n">num_wave_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_coords</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># Number of points along one edge</span>

        <span class="k">if</span> <span class="n">num_wave_points</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid number of wave points (</span><span class="si">{</span><span class="n">num_wave_points</span><span class="si">}</span><span class="s2">) for helix </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Map original sequence index to fractional position along the wave points (0 to num_wave_points-1)</span>
        <span class="n">mapped_wave_frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">original_sequence_index</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_wave_points</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">)</span>

        <span class="c1"># Find the indices in the display_coords array</span>
        <span class="n">idx_low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mapped_wave_frac</span><span class="p">))</span>
        <span class="n">idx_high</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx_low</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_wave_points</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">idx_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx_low</span><span class="p">,</span> <span class="n">num_wave_points</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Clamp low index too</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="n">mapped_wave_frac</span> <span class="o">-</span> <span class="n">idx_low</span>

        <span class="c1"># Get corresponding points on top and bottom edges</span>
        <span class="n">top_low</span> <span class="o">=</span> <span class="n">display_coords</span><span class="p">[</span><span class="n">idx_low</span><span class="p">]</span>
        <span class="n">top_high</span> <span class="o">=</span> <span class="n">display_coords</span><span class="p">[</span><span class="n">idx_high</span><span class="p">]</span>
        <span class="c1"># Bottom indices are reversed: num_total - 1 - index</span>
        <span class="n">bottom_low</span> <span class="o">=</span> <span class="n">display_coords</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">display_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">idx_low</span><span class="p">]</span>
        <span class="n">bottom_high</span> <span class="o">=</span> <span class="n">display_coords</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">display_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">idx_high</span><span class="p">]</span>

        <span class="c1"># Interpolate along top and bottom edges</span>
        <span class="n">interp_top</span> <span class="o">=</span> <span class="n">top_low</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span> <span class="o">+</span> <span class="n">top_high</span> <span class="o">*</span> <span class="n">frac</span>
        <span class="n">interp_bottom</span> <span class="o">=</span> <span class="n">bottom_low</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span> <span class="o">+</span> <span class="n">bottom_high</span> <span class="o">*</span> <span class="n">frac</span>

        <span class="c1"># Return the midpoint between the interpolated top and bottom points</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">interp_top</span> <span class="o">+</span> <span class="n">interp_bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="k">def</span> <span class="nf">get_start_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the 2D coordinate for the start connection point.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object containing projected coordinates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array [X, Y] or None if calculation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the full 3D coordinates used for rendering</span>
        <span class="n">display_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">display_coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">coords_2d</span> <span class="o">=</span> <span class="n">display_coords</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Work with XY</span>

        <span class="c1"># If rendered as a simple line (2 points)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_2d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># If rendered as zigzag (even number of points &gt;= 4)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_2d</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># Midpoint of the starting edge</span>
            <span class="c1"># First point (top edge start) = coords_2d[0]</span>
            <span class="c1"># Corresponding bottom point (bottom edge start) = coords_2d[-1]</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">coords_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">coords_2d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="c1"># Fallback for unexpected cases (e.g., single point helix coord result)</span>
        <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Return the first point</span>

    <span class="k">def</span> <span class="nf">get_end_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the 2D coordinate for the end connection point.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object containing projected coordinates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array [X, Y] or None if calculation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the full 3D coordinates used for rendering</span>
        <span class="n">display_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">display_coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">coords_2d</span> <span class="o">=</span> <span class="n">display_coords</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Work with XY</span>

        <span class="c1"># If rendered as a simple line (2 points)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_2d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># If rendered as zigzag (even number of points &gt;= 4)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_2d</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># Midpoint of the ending edge</span>
            <span class="c1"># Last point of top edge = coords_2d[num_edge_points - 1]</span>
            <span class="c1"># Corresponding last point of bottom edge = coords_2d[num_edge_points]</span>
            <span class="n">num_edge_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_2d</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">last_top_point</span> <span class="o">=</span> <span class="n">coords_2d</span><span class="p">[</span><span class="n">num_edge_points</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">last_bottom_point</span> <span class="o">=</span> <span class="n">coords_2d</span><span class="p">[</span><span class="n">num_edge_points</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">last_top_point</span> <span class="o">+</span> <span class="n">last_bottom_point</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="c1"># Fallback for unexpected cases (e.g., single point helix coord result)</span>
        <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Return the last point</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.structure.helix.HelixSceneElement.default_style" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_style</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Provides the default style for Helix elements.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.helix.HelixSceneElement.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">residue_range_set</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Initializes the HelixSceneElement.</p>


            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/helix.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">residue_range_set</span><span class="p">:</span> <span class="n">ResidueRangeSet</span><span class="p">,</span>
    <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HelixStyle</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the HelixSceneElement.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">residue_range_set</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
    <span class="c1"># Cache for the calculated zigzag coordinates and original length</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.helix.HelixSceneElement.get_coordinate_at_residue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_coordinate_at_residue</span><span class="p">(</span><span class="n">residue</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrieves the specific 2D coordinate + Depth corresponding to a residue
along the central axis of the helix representation.</p>
<p>For short helices, interpolates linearly. For zigzag helices, finds the
midpoint between the top and bottom ribbon points at the corresponding position.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>residue</code></b>
                  (<code><a class="autorefs autorefs-internal" title="ResidueCoordinate


  
      dataclass
   (flatprot.core.ResidueCoordinate)" href="../core/#flatprot.core.coordinates.ResidueCoordinate">ResidueCoordinate</a></code>)
              –
              <div class="doc-md-description">
                <p>The residue coordinate (chain and index) to find the point for.</p>
              </div>
            </li>
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing pre-projected data.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array [X, Y, Depth] corresponding to the residue's position.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/helix.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_coordinate_at_residue</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">residue</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves the specific 2D coordinate + Depth corresponding to a residue</span>
<span class="sd">    along the central axis of the helix representation.</span>

<span class="sd">    For short helices, interpolates linearly. For zigzag helices, finds the</span>
<span class="sd">    midpoint between the top and bottom ribbon points at the corresponding position.</span>

<span class="sd">    Args:</span>
<span class="sd">        residue: The residue coordinate (chain and index) to find the point for.</span>
<span class="sd">        structure: The core Structure object containing pre-projected data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array [X, Y, Depth] corresponding to the residue&#39;s position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. Ensure display coordinates are calculated</span>
    <span class="n">display_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">display_coords</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># 2. Check if residue is within the element&#39;s range</span>
    <span class="k">if</span> <span class="n">residue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">element_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Assuming single range</span>
    <span class="k">if</span> <span class="n">residue</span><span class="o">.</span><span class="n">chain_id</span> <span class="o">!=</span> <span class="n">element_range</span><span class="o">.</span><span class="n">chain_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># 3. Calculate the 0-based index within the original sequence length</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">original_sequence_index</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">residue_index</span> <span class="o">-</span> <span class="n">element_range</span><span class="o">.</span><span class="n">start</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">original_sequence_index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Handle single point case</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">display_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Should be shape (1, 3)</span>

    <span class="c1"># 4. Handle the case where a simple line was drawn</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Linear interpolation along the line</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="n">original_sequence_index</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">interpolated_coord</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">display_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span> <span class="o">+</span> <span class="n">display_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">frac</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">interpolated_coord</span>

    <span class="c1"># 5. Handle the zigzag ribbon case</span>
    <span class="c1"># display_coords contains top points then bottom points reversed</span>
    <span class="n">num_wave_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_coords</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># Number of points along one edge</span>

    <span class="k">if</span> <span class="n">num_wave_points</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid number of wave points (</span><span class="si">{</span><span class="n">num_wave_points</span><span class="si">}</span><span class="s2">) for helix </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Map original sequence index to fractional position along the wave points (0 to num_wave_points-1)</span>
    <span class="n">mapped_wave_frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">original_sequence_index</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_wave_points</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>

    <span class="c1"># Find the indices in the display_coords array</span>
    <span class="n">idx_low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mapped_wave_frac</span><span class="p">))</span>
    <span class="n">idx_high</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx_low</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_wave_points</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">idx_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx_low</span><span class="p">,</span> <span class="n">num_wave_points</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Clamp low index too</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="n">mapped_wave_frac</span> <span class="o">-</span> <span class="n">idx_low</span>

    <span class="c1"># Get corresponding points on top and bottom edges</span>
    <span class="n">top_low</span> <span class="o">=</span> <span class="n">display_coords</span><span class="p">[</span><span class="n">idx_low</span><span class="p">]</span>
    <span class="n">top_high</span> <span class="o">=</span> <span class="n">display_coords</span><span class="p">[</span><span class="n">idx_high</span><span class="p">]</span>
    <span class="c1"># Bottom indices are reversed: num_total - 1 - index</span>
    <span class="n">bottom_low</span> <span class="o">=</span> <span class="n">display_coords</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">display_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">idx_low</span><span class="p">]</span>
    <span class="n">bottom_high</span> <span class="o">=</span> <span class="n">display_coords</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">display_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">idx_high</span><span class="p">]</span>

    <span class="c1"># Interpolate along top and bottom edges</span>
    <span class="n">interp_top</span> <span class="o">=</span> <span class="n">top_low</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span> <span class="o">+</span> <span class="n">top_high</span> <span class="o">*</span> <span class="n">frac</span>
    <span class="n">interp_bottom</span> <span class="o">=</span> <span class="n">bottom_low</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span> <span class="o">+</span> <span class="n">bottom_high</span> <span class="o">*</span> <span class="n">frac</span>

    <span class="c1"># Return the midpoint between the interpolated top and bottom points</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">interp_top</span> <span class="o">+</span> <span class="n">interp_bottom</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.helix.HelixSceneElement.get_coordinates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrieve the 2D + Depth coordinates for the helix zigzag ribbon.</p>
<p>Calculates the ribbon shape based on start/end points of the pre-projected
coordinate slice and style parameters. Handles minimum length.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing pre-projected data.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array of the ribbon outline coordinates [X, Y, Depth],</p>
              </div>
            </li>
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>or a simple line [start, end] if below min_helix_length.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/helix.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the 2D + Depth coordinates for the helix zigzag ribbon.</span>

<span class="sd">    Calculates the ribbon shape based on start/end points of the pre-projected</span>
<span class="sd">    coordinate slice and style parameters. Handles minimum length.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object containing pre-projected data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array of the ribbon outline coordinates [X, Y, Depth],</span>
<span class="sd">        or a simple line [start, end] if below min_helix_length.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>

    <span class="n">original_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_original_coords_slice</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">original_coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_coords</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># If only one residue, return just that point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">original_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>

    <span class="c1"># If too short, return a simple line (start and end points)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">min_helix_length</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">original_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">original_coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>

    <span class="c1"># Calculate zigzag points</span>
    <span class="n">start_point_3d</span> <span class="o">=</span> <span class="n">original_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">end_point_3d</span> <span class="o">=</span> <span class="n">original_coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">zigzag_coords</span> <span class="o">=</span> <span class="n">calculate_zigzag_points</span><span class="p">(</span>
        <span class="n">start_point_3d</span><span class="p">,</span>
        <span class="n">end_point_3d</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">ribbon_thickness</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">amplitude</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">zigzag_coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">&gt;=</span> <span class="mi">2</span>
    <span class="p">):</span>  <span class="c1"># Log only if zigzag expected but failed</span>
        <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not generate zigzag points for helix &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; (length=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="si">}</span><span class="s2">), likely zero length between endpoints.&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="n">zigzag_coords</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.helix.HelixSceneElement.get_end_connection_point" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_end_connection_point</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate the 2D coordinate for the end connection point.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing projected coordinates.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array [X, Y] or None if calculation fails.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/helix.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_end_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the 2D coordinate for the end connection point.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object containing projected coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array [X, Y] or None if calculation fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the full 3D coordinates used for rendering</span>
    <span class="n">display_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">display_coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">coords_2d</span> <span class="o">=</span> <span class="n">display_coords</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Work with XY</span>

    <span class="c1"># If rendered as a simple line (2 points)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_2d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># If rendered as zigzag (even number of points &gt;= 4)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_2d</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># Midpoint of the ending edge</span>
        <span class="c1"># Last point of top edge = coords_2d[num_edge_points - 1]</span>
        <span class="c1"># Corresponding last point of bottom edge = coords_2d[num_edge_points]</span>
        <span class="n">num_edge_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_2d</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">last_top_point</span> <span class="o">=</span> <span class="n">coords_2d</span><span class="p">[</span><span class="n">num_edge_points</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">last_bottom_point</span> <span class="o">=</span> <span class="n">coords_2d</span><span class="p">[</span><span class="n">num_edge_points</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">last_top_point</span> <span class="o">+</span> <span class="n">last_bottom_point</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="c1"># Fallback for unexpected cases (e.g., single point helix coord result)</span>
    <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Return the last point</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.helix.HelixSceneElement.get_start_connection_point" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_start_connection_point</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate the 2D coordinate for the start connection point.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing projected coordinates.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array [X, Y] or None if calculation fails.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/helix.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_start_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the 2D coordinate for the start connection point.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object containing projected coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array [X, Y] or None if calculation fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the full 3D coordinates used for rendering</span>
    <span class="n">display_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">display_coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">coords_2d</span> <span class="o">=</span> <span class="n">display_coords</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Work with XY</span>

    <span class="c1"># If rendered as a simple line (2 points)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_2d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># If rendered as zigzag (even number of points &gt;= 4)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_2d</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># Midpoint of the starting edge</span>
        <span class="c1"># First point (top edge start) = coords_2d[0]</span>
        <span class="c1"># Corresponding bottom point (bottom edge start) = coords_2d[-1]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">coords_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">coords_2d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="c1"># Fallback for unexpected cases (e.g., single point helix coord result)</span>
    <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Return the first point</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.structure.helix.HelixStyle"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.structure.base_structure.BaseStructureStyle" href="#flatprot.scene.structure.base_structure.BaseStructureStyle">BaseStructureStyle</a></code></p>


        <p>Style properties specific to Helix elements.</p>
<p>Defines properties for rendering helices as zigzag ribbons.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/structure/helix.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">HelixStyle</span><span class="p">(</span><span class="n">BaseStructureStyle</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Style properties specific to Helix elements.</span>

<span class="sd">    Defines properties for rendering helices as zigzag ribbons.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Override inherited defaults</span>
    <span class="n">color</span><span class="p">:</span> <span class="n">Color</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#ff0000&quot;</span><span class="p">),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Default color for helix (red).&quot;</span>
    <span class="p">)</span>
    <span class="n">stroke_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Reference width for calculating helix dimensions.&quot;</span>
    <span class="p">)</span>
    <span class="n">simplified_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Width to use for simplified helix rendering (line only).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Helix-specific attributes</span>
    <span class="n">ribbon_thickness</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Factor to multiply linewidth by for the ribbon thickness.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">wavelength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Factor to multiply linewidth by for the zigzag wavelength.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">amplitude</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Factor to multiply linewidth by for the zigzag amplitude.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">min_helix_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Minimum number of residues required to draw a zigzag shape instead of a line.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.structure.sheet.SheetSceneElement"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.structure.base_structure.BaseStructureSceneElement" href="#flatprot.scene.structure.base_structure.BaseStructureSceneElement">BaseStructureSceneElement</a>[<a class="autorefs autorefs-internal" title="flatprot.scene.structure.sheet.SheetStyle" href="#flatprot.scene.structure.sheet.SheetStyle">SheetStyle</a>]</code></p>


        <p>Represents a Beta Sheet segment, visualized as a triangular arrow.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/structure/sheet.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SheetSceneElement</span><span class="p">(</span><span class="n">BaseStructureSceneElement</span><span class="p">[</span><span class="n">SheetStyle</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a Beta Sheet segment, visualized as a triangular arrow.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">residue_range_set</span><span class="p">:</span> <span class="n">ResidueRangeSet</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SheetStyle</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the SheetSceneElement.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">residue_range_set</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="c1"># Cache for the calculated arrow coordinates and original length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_style</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SheetStyle</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides the default style for Sheet elements.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SheetStyle</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_original_coords_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper to extract the original coordinate slice for this sheet.&quot;&quot;&quot;</span>
        <span class="n">coords_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot get coordinates for Sheet &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;: no residue ranges defined.&quot;</span>
            <span class="p">)</span>
        <span class="n">sheet_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="n">structure</span><span class="p">[</span><span class="n">sheet_range</span><span class="o">.</span><span class="n">chain_id</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">res_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sheet_range</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">sheet_range</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">res_idx</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
                    <span class="n">coord_idx</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">coordinate_index</span><span class="p">(</span><span class="n">res_idx</span><span class="p">)</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">coord_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">coordinates</span><span class="p">):</span>
                        <span class="n">coords_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">coord_idx</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Sheet &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;: Coordinate index </span><span class="si">{</span><span class="n">coord_idx</span><span class="si">}</span><span class="s2"> out of bounds for residue </span><span class="si">{</span><span class="n">sheet_range</span><span class="o">.</span><span class="n">chain_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">res_idx</span><span class="si">}</span><span class="s2">.&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Sheet &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;: Residue </span><span class="si">{</span><span class="n">sheet_range</span><span class="o">.</span><span class="n">chain_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">res_idx</span><span class="si">}</span><span class="s2"> not found in chain coordinate map.&quot;</span>
                    <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error fetching coordinates for sheet &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">coords_list</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the 2D + Depth coordinates for the sheet arrow.</span>

<span class="sd">        Calculates the three points (arrow base left, base right, tip) based</span>
<span class="sd">        on the start and end points of the pre-projected coordinate slice.</span>
<span class="sd">        Handles minimum length requirement.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object containing pre-projected data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array of the arrow coordinates (shape [3, 3] or [2, 3])</span>
<span class="sd">            containing [X, Y, Depth] for each point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>

        <span class="n">original_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_original_coords_slice</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">original_coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_coords</span><span class="p">)</span>

        <span class="c1"># If only one point, cannot draw line or arrow</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">original_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="p">)</span>  <span class="c1"># Return the single point</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>

        <span class="c1"># Use only X, Y for shape calculation, keep Z (depth)</span>
        <span class="n">start_point_xy</span> <span class="o">=</span> <span class="n">original_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">end_point_xy</span> <span class="o">=</span> <span class="n">original_coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Use average depth of start/end for the base, end depth for tip</span>
        <span class="n">start_depth</span> <span class="o">=</span> <span class="n">original_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">end_depth</span> <span class="o">=</span> <span class="n">original_coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">avg_base_depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_depth</span> <span class="o">+</span> <span class="n">end_depth</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="n">direction</span> <span class="o">=</span> <span class="n">end_point_xy</span> <span class="o">-</span> <span class="n">start_point_xy</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>

        <span class="c1"># If too short or degenerate, return a simple line (start and end points)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mf">1e-6</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">min_sheet_length</span><span class="p">:</span>
            <span class="c1"># Return original start and end points (X, Y, Depth)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">original_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">original_coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>

        <span class="c1"># Normalize direction vector (only need X, Y)</span>
        <span class="n">direction</span> <span class="o">/=</span> <span class="n">length</span>

        <span class="c1"># Calculate perpendicular vector in 2D</span>
        <span class="n">perp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">arrow_base_half_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">arrow_width</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="c1"># Calculate arrow base points (X, Y)</span>
        <span class="n">left_point_xy</span> <span class="o">=</span> <span class="n">start_point_xy</span> <span class="o">+</span> <span class="n">perp</span> <span class="o">*</span> <span class="n">arrow_base_half_width</span>
        <span class="n">right_point_xy</span> <span class="o">=</span> <span class="n">start_point_xy</span> <span class="o">-</span> <span class="n">perp</span> <span class="o">*</span> <span class="n">arrow_base_half_width</span>

        <span class="c1"># Combine XY with Depth</span>
        <span class="n">left_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">left_point_xy</span><span class="p">,</span> <span class="n">avg_base_depth</span><span class="p">)</span>
        <span class="n">right_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">right_point_xy</span><span class="p">,</span> <span class="n">avg_base_depth</span><span class="p">)</span>
        <span class="n">tip_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end_point_xy</span><span class="p">,</span> <span class="n">end_depth</span><span class="p">)</span>  <span class="c1"># Tip uses depth of last residue</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">left_point</span><span class="p">,</span> <span class="n">right_point</span><span class="p">,</span> <span class="n">tip_point</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>

    <span class="k">def</span> <span class="nf">get_coordinate_at_residue</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">residue</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves the specific 2D coordinate + Depth corresponding to a residue</span>
<span class="sd">        along the central axis of the sheet arrow representation.</span>

<span class="sd">        Interpolates along the axis from the base midpoint to the tip, or along</span>
<span class="sd">        the line if the arrow shape is not drawn.</span>

<span class="sd">        Args:</span>
<span class="sd">            residue: The residue coordinate (chain and index) to find the point for.</span>
<span class="sd">            structure: The core Structure object containing pre-projected data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array [X, Y, Depth] interpolated along the sheet axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. Ensure display coordinates are calculated and length is known</span>
        <span class="n">display_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">display_coords</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># 2. Check if residue is within the element&#39;s range</span>
        <span class="k">if</span> <span class="n">residue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Assuming single continuous range for sheet element representation</span>
        <span class="n">element_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">residue</span><span class="o">.</span><span class="n">chain_id</span> <span class="o">!=</span> <span class="n">element_range</span><span class="o">.</span><span class="n">chain_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># 3. Calculate the 0-based index within the original sequence length</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">original_sequence_index</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">residue_index</span> <span class="o">-</span> <span class="n">element_range</span><span class="o">.</span><span class="n">start</span>
            <span class="c1"># Validate index against the original length before simplification/arrow calc</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">original_sequence_index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Residue index </span><span class="si">{</span><span class="n">original_sequence_index</span><span class="si">}</span><span class="s2"> derived from </span><span class="si">{</span><span class="n">residue</span><span class="si">}</span><span class="s2"> is out of original bounds [0, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="si">}</span><span class="s2">) for element </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error calculating original sequence index for </span><span class="si">{</span><span class="n">residue</span><span class="si">}</span><span class="s2"> in element </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="c1"># Handle single point case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">display_coords</span><span class="p">[</span>
                <span class="mi">0</span>
            <span class="p">]</span>  <span class="c1"># Return the single point calculated by get_coordinates</span>

        <span class="c1"># 4. Handle the case where a line was drawn (display_coords has 2 points)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Simple linear interpolation between the start and end points of the line</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="n">original_sequence_index</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">interpolated_coord</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">display_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span> <span class="o">+</span> <span class="n">display_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">frac</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">interpolated_coord</span>

        <span class="c1"># 5. Interpolate along the arrow axis (base midpoint to tip)</span>
        <span class="c1"># display_coords has shape [3, 3]: [left_base, right_base, tip]</span>
        <span class="n">base_midpoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">display_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">display_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">tip_point</span> <span class="o">=</span> <span class="n">display_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Calculate fraction along the length (0 = base midpoint, 1 = tip)</span>
        <span class="c1"># Based on position within the *original* sequence length</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="n">original_sequence_index</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Linear interpolation between base midpoint and tip point</span>
        <span class="n">interpolated_coord</span> <span class="o">=</span> <span class="n">base_midpoint</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span> <span class="o">+</span> <span class="n">tip_point</span> <span class="o">*</span> <span class="n">frac</span>

        <span class="k">return</span> <span class="n">interpolated_coord</span>

    <span class="k">def</span> <span class="nf">get_start_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the 2D coordinate for the start connection point.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object containing projected coordinates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array [X, Y] or None if calculation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coords_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">coords_2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_2d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">coords_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">coords_2d</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">get_end_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the 2D coordinate for the end connection point.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object containing projected coordinates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array [X, Y] or None if calculation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coords_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">coords_2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.structure.sheet.SheetSceneElement.default_style" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_style</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Provides the default style for Sheet elements.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.sheet.SheetSceneElement.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">residue_range_set</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Initializes the SheetSceneElement.</p>


            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/sheet.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">residue_range_set</span><span class="p">:</span> <span class="n">ResidueRangeSet</span><span class="p">,</span>
    <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SheetStyle</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the SheetSceneElement.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">residue_range_set</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
    <span class="c1"># Cache for the calculated arrow coordinates and original length</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.sheet.SheetSceneElement.get_coordinate_at_residue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_coordinate_at_residue</span><span class="p">(</span><span class="n">residue</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrieves the specific 2D coordinate + Depth corresponding to a residue
along the central axis of the sheet arrow representation.</p>
<p>Interpolates along the axis from the base midpoint to the tip, or along
the line if the arrow shape is not drawn.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>residue</code></b>
                  (<code><a class="autorefs autorefs-internal" title="ResidueCoordinate


  
      dataclass
   (flatprot.core.ResidueCoordinate)" href="../core/#flatprot.core.coordinates.ResidueCoordinate">ResidueCoordinate</a></code>)
              –
              <div class="doc-md-description">
                <p>The residue coordinate (chain and index) to find the point for.</p>
              </div>
            </li>
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing pre-projected data.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array [X, Y, Depth] interpolated along the sheet axis.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/sheet.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_coordinate_at_residue</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">residue</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves the specific 2D coordinate + Depth corresponding to a residue</span>
<span class="sd">    along the central axis of the sheet arrow representation.</span>

<span class="sd">    Interpolates along the axis from the base midpoint to the tip, or along</span>
<span class="sd">    the line if the arrow shape is not drawn.</span>

<span class="sd">    Args:</span>
<span class="sd">        residue: The residue coordinate (chain and index) to find the point for.</span>
<span class="sd">        structure: The core Structure object containing pre-projected data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array [X, Y, Depth] interpolated along the sheet axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. Ensure display coordinates are calculated and length is known</span>
    <span class="n">display_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">display_coords</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># 2. Check if residue is within the element&#39;s range</span>
    <span class="k">if</span> <span class="n">residue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># Assuming single continuous range for sheet element representation</span>
    <span class="n">element_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">residue</span><span class="o">.</span><span class="n">chain_id</span> <span class="o">!=</span> <span class="n">element_range</span><span class="o">.</span><span class="n">chain_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># 3. Calculate the 0-based index within the original sequence length</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">original_sequence_index</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">residue_index</span> <span class="o">-</span> <span class="n">element_range</span><span class="o">.</span><span class="n">start</span>
        <span class="c1"># Validate index against the original length before simplification/arrow calc</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">original_sequence_index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Residue index </span><span class="si">{</span><span class="n">original_sequence_index</span><span class="si">}</span><span class="s2"> derived from </span><span class="si">{</span><span class="n">residue</span><span class="si">}</span><span class="s2"> is out of original bounds [0, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="si">}</span><span class="s2">) for element </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Error calculating original sequence index for </span><span class="si">{</span><span class="n">residue</span><span class="si">}</span><span class="s2"> in element </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="c1"># Handle single point case</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">display_coords</span><span class="p">[</span>
            <span class="mi">0</span>
        <span class="p">]</span>  <span class="c1"># Return the single point calculated by get_coordinates</span>

    <span class="c1"># 4. Handle the case where a line was drawn (display_coords has 2 points)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Simple linear interpolation between the start and end points of the line</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="n">original_sequence_index</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">interpolated_coord</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">display_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span> <span class="o">+</span> <span class="n">display_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">frac</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">interpolated_coord</span>

    <span class="c1"># 5. Interpolate along the arrow axis (base midpoint to tip)</span>
    <span class="c1"># display_coords has shape [3, 3]: [left_base, right_base, tip]</span>
    <span class="n">base_midpoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">display_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">display_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">tip_point</span> <span class="o">=</span> <span class="n">display_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Calculate fraction along the length (0 = base midpoint, 1 = tip)</span>
    <span class="c1"># Based on position within the *original* sequence length</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="n">original_sequence_index</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Linear interpolation between base midpoint and tip point</span>
    <span class="n">interpolated_coord</span> <span class="o">=</span> <span class="n">base_midpoint</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span> <span class="o">+</span> <span class="n">tip_point</span> <span class="o">*</span> <span class="n">frac</span>

    <span class="k">return</span> <span class="n">interpolated_coord</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.sheet.SheetSceneElement.get_coordinates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrieve the 2D + Depth coordinates for the sheet arrow.</p>
<p>Calculates the three points (arrow base left, base right, tip) based
on the start and end points of the pre-projected coordinate slice.
Handles minimum length requirement.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing pre-projected data.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array of the arrow coordinates (shape [3, 3] or [2, 3])</p>
              </div>
            </li>
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>containing [X, Y, Depth] for each point.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/sheet.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the 2D + Depth coordinates for the sheet arrow.</span>

<span class="sd">    Calculates the three points (arrow base left, base right, tip) based</span>
<span class="sd">    on the start and end points of the pre-projected coordinate slice.</span>
<span class="sd">    Handles minimum length requirement.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object containing pre-projected data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array of the arrow coordinates (shape [3, 3] or [2, 3])</span>
<span class="sd">        containing [X, Y, Depth] for each point.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>

    <span class="n">original_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_original_coords_slice</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">original_coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_coords</span><span class="p">)</span>

    <span class="c1"># If only one point, cannot draw line or arrow</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">original_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="p">)</span>  <span class="c1"># Return the single point</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>

    <span class="c1"># Use only X, Y for shape calculation, keep Z (depth)</span>
    <span class="n">start_point_xy</span> <span class="o">=</span> <span class="n">original_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">end_point_xy</span> <span class="o">=</span> <span class="n">original_coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Use average depth of start/end for the base, end depth for tip</span>
    <span class="n">start_depth</span> <span class="o">=</span> <span class="n">original_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">end_depth</span> <span class="o">=</span> <span class="n">original_coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">avg_base_depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_depth</span> <span class="o">+</span> <span class="n">end_depth</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="n">direction</span> <span class="o">=</span> <span class="n">end_point_xy</span> <span class="o">-</span> <span class="n">start_point_xy</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>

    <span class="c1"># If too short or degenerate, return a simple line (start and end points)</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mf">1e-6</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">min_sheet_length</span><span class="p">:</span>
        <span class="c1"># Return original start and end points (X, Y, Depth)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">original_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">original_coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>

    <span class="c1"># Normalize direction vector (only need X, Y)</span>
    <span class="n">direction</span> <span class="o">/=</span> <span class="n">length</span>

    <span class="c1"># Calculate perpendicular vector in 2D</span>
    <span class="n">perp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">arrow_base_half_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">arrow_width</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="c1"># Calculate arrow base points (X, Y)</span>
    <span class="n">left_point_xy</span> <span class="o">=</span> <span class="n">start_point_xy</span> <span class="o">+</span> <span class="n">perp</span> <span class="o">*</span> <span class="n">arrow_base_half_width</span>
    <span class="n">right_point_xy</span> <span class="o">=</span> <span class="n">start_point_xy</span> <span class="o">-</span> <span class="n">perp</span> <span class="o">*</span> <span class="n">arrow_base_half_width</span>

    <span class="c1"># Combine XY with Depth</span>
    <span class="n">left_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">left_point_xy</span><span class="p">,</span> <span class="n">avg_base_depth</span><span class="p">)</span>
    <span class="n">right_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">right_point_xy</span><span class="p">,</span> <span class="n">avg_base_depth</span><span class="p">)</span>
    <span class="n">tip_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">end_point_xy</span><span class="p">,</span> <span class="n">end_depth</span><span class="p">)</span>  <span class="c1"># Tip uses depth of last residue</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">left_point</span><span class="p">,</span> <span class="n">right_point</span><span class="p">,</span> <span class="n">tip_point</span><span class="p">])</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_display_coords</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.sheet.SheetSceneElement.get_end_connection_point" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_end_connection_point</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate the 2D coordinate for the end connection point.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing projected coordinates.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array [X, Y] or None if calculation fails.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/sheet.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_end_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the 2D coordinate for the end connection point.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object containing projected coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array [X, Y] or None if calculation fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coords_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">coords_2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.sheet.SheetSceneElement.get_start_connection_point" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_start_connection_point</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate the 2D coordinate for the start connection point.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing projected coordinates.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array [X, Y] or None if calculation fails.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/sheet.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_start_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the 2D coordinate for the start connection point.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object containing projected coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array [X, Y] or None if calculation fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coords_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">coords_2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords_2d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">coords_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">coords_2d</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.structure.sheet.SheetStyle"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.structure.base_structure.BaseStructureStyle" href="#flatprot.scene.structure.base_structure.BaseStructureStyle">BaseStructureStyle</a></code></p>


        <p>Style properties specific to Sheet elements.</p>
<p>Defines properties for rendering beta sheets as triangular arrows.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/structure/sheet.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SheetStyle</span><span class="p">(</span><span class="n">BaseStructureStyle</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Style properties specific to Sheet elements.</span>

<span class="sd">    Defines properties for rendering beta sheets as triangular arrows.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Override inherited defaults</span>
    <span class="n">color</span><span class="p">:</span> <span class="n">Color</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#0000ff&quot;</span><span class="p">),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Default color for sheet (blue).&quot;</span>
    <span class="p">)</span>
    <span class="n">stroke_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Base width of the sheet arrow.&quot;</span>
    <span class="p">)</span>
    <span class="n">simplified_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Width to use for simplified sheet rendering (line only).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Sheet-specific attributes</span>
    <span class="n">arrow_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Factor to multiply linewidth by for the arrowhead base width.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">min_sheet_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Minimum number of residues required to draw an arrow shape instead of a line.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.structure.coil.CoilSceneElement"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.structure.base_structure.BaseStructureSceneElement" href="#flatprot.scene.structure.base_structure.BaseStructureSceneElement">BaseStructureSceneElement</a>[<a class="autorefs autorefs-internal" title="flatprot.scene.structure.coil.CoilStyle" href="#flatprot.scene.structure.coil.CoilStyle">CoilStyle</a>]</code></p>


        <p>Represents a Coil segment of a protein structure.</p>
<p>Renders as a smoothed line based on the pre-projected coordinates.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/structure/coil.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CoilSceneElement</span><span class="p">(</span><span class="n">BaseStructureSceneElement</span><span class="p">[</span><span class="n">CoilStyle</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a Coil segment of a protein structure.</span>

<span class="sd">    Renders as a smoothed line based on the pre-projected coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">residue_range_set</span><span class="p">:</span> <span class="n">ResidueRangeSet</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoilStyle</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the CoilSceneElement.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">residue_range_set</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="c1"># Cache for the calculated smoothed coordinates and original indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_style</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CoilStyle</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides the default style for Coil elements.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CoilStyle</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_original_coords_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper to extract the original coordinate slice for this coil.&quot;&quot;&quot;</span>
        <span class="n">coords_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot get coordinates for Coil &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;: no residue ranges defined.&quot;</span>
            <span class="p">)</span>
        <span class="n">coil_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="n">structure</span><span class="p">[</span><span class="n">coil_range</span><span class="o">.</span><span class="n">chain_id</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">res_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">coil_range</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">coil_range</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">res_idx</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
                    <span class="n">coord_idx</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">coordinate_index</span><span class="p">(</span><span class="n">res_idx</span><span class="p">)</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">coord_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">coordinates</span><span class="p">):</span>
                        <span class="n">coords_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">coord_idx</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Coil &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;: Coordinate index </span><span class="si">{</span><span class="n">coord_idx</span><span class="si">}</span><span class="s2"> out of bounds for residue </span><span class="si">{</span><span class="n">coil_range</span><span class="o">.</span><span class="n">chain_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">res_idx</span><span class="si">}</span><span class="s2">.&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Coil &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;: Residue </span><span class="si">{</span><span class="n">coil_range</span><span class="o">.</span><span class="n">chain_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">res_idx</span><span class="si">}</span><span class="s2"> not found in chain coordinate map.&quot;</span>
                    <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error getting original coordinates for Coil &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">coords_list</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the smoothed 2D + Depth coordinates for rendering the coil.</span>

<span class="sd">        Fetches the pre-projected coordinates from the structure, applies smoothing</span>
<span class="sd">        based on the style&#39;s smoothing_factor, and caches the result.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object containing pre-projected data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array of smoothed 2D + Depth coordinates (X, Y, Depth).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Return cached result if available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span>

        <span class="c1"># 1. Get the original (pre-projected) coordinates slice for this element</span>
        <span class="n">original_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_original_coords_slice</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">original_coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_indices</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_coords</span><span class="p">)</span>

        <span class="c1"># Handle single-point coils separately</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span> <span class="o">=</span> <span class="n">original_coords</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_original_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Index of the single point</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span>

        <span class="c1"># 2. Apply smoothing based on style (only if &gt;= 2 points)</span>
        <span class="n">smoothing_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">smoothing_factor</span>
        <span class="n">smoothed_coords</span><span class="p">,</span> <span class="n">used_indices</span> <span class="o">=</span> <span class="n">smooth_coordinates</span><span class="p">(</span>
            <span class="n">original_coords</span><span class="p">,</span> <span class="n">smoothing_factor</span>
        <span class="p">)</span>

        <span class="c1"># 3. Cache and return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span> <span class="o">=</span> <span class="n">smoothed_coords</span>
        <span class="c1"># Map the indices from smooth_coordinates (relative to the slice) back to the</span>
        <span class="c1"># original residue indices or coordinate indices if needed elsewhere, but</span>
        <span class="c1"># for get_2d_coordinate_at_residue, we primarily need the mapping *between*</span>
        <span class="c1"># original sequence index and smoothed sequence index.</span>
        <span class="c1"># We store the indices *within the original slice* that were kept.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_indices</span> <span class="o">=</span> <span class="n">used_indices</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span>

    <span class="k">def</span> <span class="nf">get_coordinate_at_residue</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">residue</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves the specific 2D coordinate + Depth corresponding to a residue</span>
<span class="sd">        within the smoothed representation of the coil.</span>

<span class="sd">        Uses linear interpolation between the points of the smoothed coil line.</span>

<span class="sd">        Args:</span>
<span class="sd">            residue: The residue coordinate (chain and index) to find the 2D point for.</span>
<span class="sd">            structure: The core Structure object containing pre-projected 2D + Depth data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array [X, Y, Depth] from the smoothed representation, potentially interpolated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. Ensure smoothed coordinates are calculated and cached</span>
        <span class="c1"># This call populates self._cached_smoothed_coords, self._original_coords_len, etc.</span>
        <span class="n">smoothed_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">smoothed_coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Cannot determine coordinate if smoothing failed</span>

        <span class="c1"># 2. Check if residue is within the element&#39;s range</span>
        <span class="k">if</span> <span class="n">residue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Assuming single range for simplicity</span>
        <span class="n">element_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">residue</span><span class="o">.</span><span class="n">chain_id</span> <span class="o">!=</span> <span class="n">element_range</span><span class="o">.</span><span class="n">chain_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># 3. Map residue index to the 0-based index within the *original* sequence of this coil</span>
        <span class="c1"># This index represents the position *before* smoothing.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">original_sequence_index</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">residue_index</span> <span class="o">-</span> <span class="n">element_range</span><span class="o">.</span><span class="n">start</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">original_sequence_index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Residue index is outside the valid range for this element</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Should not happen if residue is in range set, but defensive check</span>

        <span class="c1"># 4. Map the original sequence index to the fractional index within the *smoothed* sequence</span>
        <span class="c1"># This tells us where the original residue falls along the smoothed line.</span>
        <span class="n">orig_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span>
        <span class="n">smooth_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">smoothed_coords</span><span class="p">)</span>

        <span class="c1"># Avoid division by zero if original length was 1 (although checked earlier)</span>
        <span class="k">if</span> <span class="n">orig_len</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">smoothed_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">smooth_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># Calculate fractional position along the smoothed line</span>
        <span class="n">mapped_idx_frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">original_sequence_index</span> <span class="o">*</span> <span class="p">(</span><span class="n">smooth_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">orig_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 5. Linear interpolation between adjacent smoothed points</span>
        <span class="n">idx_low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mapped_idx_frac</span><span class="p">))</span>
        <span class="c1"># Clamp idx_high to the last valid index of the smoothed array</span>
        <span class="n">idx_high</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx_low</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">smooth_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Ensure idx_low is also within bounds (handles edge case where mapped_idx_frac might be exactly smooth_len-1)</span>
        <span class="n">idx_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx_low</span><span class="p">,</span> <span class="n">smooth_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Calculate interpolation fraction</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="n">mapped_idx_frac</span> <span class="o">-</span> <span class="n">idx_low</span>

        <span class="c1"># Interpolate X, Y, and Depth</span>
        <span class="n">coord_low</span> <span class="o">=</span> <span class="n">smoothed_coords</span><span class="p">[</span><span class="n">idx_low</span><span class="p">]</span>
        <span class="n">coord_high</span> <span class="o">=</span> <span class="n">smoothed_coords</span><span class="p">[</span><span class="n">idx_high</span><span class="p">]</span>
        <span class="n">interpolated_coord</span> <span class="o">=</span> <span class="n">coord_low</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span> <span class="o">+</span> <span class="n">coord_high</span> <span class="o">*</span> <span class="n">frac</span>

        <span class="k">return</span> <span class="n">interpolated_coord</span>

    <span class="k">def</span> <span class="nf">get_start_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the 2D coordinate for the start connection point.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object containing projected coordinates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array [X, Y] or None if calculation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">coords_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">coords_2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_end_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the 2D coordinate for the end connection point.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object containing projected coordinates.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array [X, Y] or None if calculation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coords_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">coords_2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.structure.coil.CoilSceneElement.default_style" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_style</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Provides the default style for Coil elements.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.coil.CoilSceneElement.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">residue_range_set</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Initializes the CoilSceneElement.</p>


            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/coil.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">residue_range_set</span><span class="p">:</span> <span class="n">ResidueRangeSet</span><span class="p">,</span>
    <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoilStyle</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the CoilSceneElement.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">residue_range_set</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
    <span class="c1"># Cache for the calculated smoothed coordinates and original indices</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_original_indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.coil.CoilSceneElement.get_coordinate_at_residue" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_coordinate_at_residue</span><span class="p">(</span><span class="n">residue</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrieves the specific 2D coordinate + Depth corresponding to a residue
within the smoothed representation of the coil.</p>
<p>Uses linear interpolation between the points of the smoothed coil line.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>residue</code></b>
                  (<code><a class="autorefs autorefs-internal" title="ResidueCoordinate


  
      dataclass
   (flatprot.core.ResidueCoordinate)" href="../core/#flatprot.core.coordinates.ResidueCoordinate">ResidueCoordinate</a></code>)
              –
              <div class="doc-md-description">
                <p>The residue coordinate (chain and index) to find the 2D point for.</p>
              </div>
            </li>
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing pre-projected 2D + Depth data.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array [X, Y, Depth] from the smoothed representation, potentially interpolated.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/coil.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_coordinate_at_residue</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">residue</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves the specific 2D coordinate + Depth corresponding to a residue</span>
<span class="sd">    within the smoothed representation of the coil.</span>

<span class="sd">    Uses linear interpolation between the points of the smoothed coil line.</span>

<span class="sd">    Args:</span>
<span class="sd">        residue: The residue coordinate (chain and index) to find the 2D point for.</span>
<span class="sd">        structure: The core Structure object containing pre-projected 2D + Depth data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array [X, Y, Depth] from the smoothed representation, potentially interpolated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. Ensure smoothed coordinates are calculated and cached</span>
    <span class="c1"># This call populates self._cached_smoothed_coords, self._original_coords_len, etc.</span>
    <span class="n">smoothed_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">smoothed_coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Cannot determine coordinate if smoothing failed</span>

    <span class="c1"># 2. Check if residue is within the element&#39;s range</span>
    <span class="k">if</span> <span class="n">residue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># Assuming single range for simplicity</span>
    <span class="n">element_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residue_range_set</span><span class="o">.</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">residue</span><span class="o">.</span><span class="n">chain_id</span> <span class="o">!=</span> <span class="n">element_range</span><span class="o">.</span><span class="n">chain_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># 3. Map residue index to the 0-based index within the *original* sequence of this coil</span>
    <span class="c1"># This index represents the position *before* smoothing.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">original_sequence_index</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">residue_index</span> <span class="o">-</span> <span class="n">element_range</span><span class="o">.</span><span class="n">start</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">original_sequence_index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Residue index is outside the valid range for this element</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Should not happen if residue is in range set, but defensive check</span>

    <span class="c1"># 4. Map the original sequence index to the fractional index within the *smoothed* sequence</span>
    <span class="c1"># This tells us where the original residue falls along the smoothed line.</span>
    <span class="n">orig_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span>
    <span class="n">smooth_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">smoothed_coords</span><span class="p">)</span>

    <span class="c1"># Avoid division by zero if original length was 1 (although checked earlier)</span>
    <span class="k">if</span> <span class="n">orig_len</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">smoothed_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">smooth_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Calculate fractional position along the smoothed line</span>
    <span class="n">mapped_idx_frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">original_sequence_index</span> <span class="o">*</span> <span class="p">(</span><span class="n">smooth_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">orig_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 5. Linear interpolation between adjacent smoothed points</span>
    <span class="n">idx_low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mapped_idx_frac</span><span class="p">))</span>
    <span class="c1"># Clamp idx_high to the last valid index of the smoothed array</span>
    <span class="n">idx_high</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx_low</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">smooth_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Ensure idx_low is also within bounds (handles edge case where mapped_idx_frac might be exactly smooth_len-1)</span>
    <span class="n">idx_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx_low</span><span class="p">,</span> <span class="n">smooth_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Calculate interpolation fraction</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="n">mapped_idx_frac</span> <span class="o">-</span> <span class="n">idx_low</span>

    <span class="c1"># Interpolate X, Y, and Depth</span>
    <span class="n">coord_low</span> <span class="o">=</span> <span class="n">smoothed_coords</span><span class="p">[</span><span class="n">idx_low</span><span class="p">]</span>
    <span class="n">coord_high</span> <span class="o">=</span> <span class="n">smoothed_coords</span><span class="p">[</span><span class="n">idx_high</span><span class="p">]</span>
    <span class="n">interpolated_coord</span> <span class="o">=</span> <span class="n">coord_low</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span> <span class="o">+</span> <span class="n">coord_high</span> <span class="o">*</span> <span class="n">frac</span>

    <span class="k">return</span> <span class="n">interpolated_coord</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.coil.CoilSceneElement.get_coordinates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrieve the smoothed 2D + Depth coordinates for rendering the coil.</p>
<p>Fetches the pre-projected coordinates from the structure, applies smoothing
based on the style's smoothing_factor, and caches the result.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing pre-projected data.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array of smoothed 2D + Depth coordinates (X, Y, Depth).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/coil.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the smoothed 2D + Depth coordinates for rendering the coil.</span>

<span class="sd">    Fetches the pre-projected coordinates from the structure, applies smoothing</span>
<span class="sd">    based on the style&#39;s smoothing_factor, and caches the result.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object containing pre-projected data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array of smoothed 2D + Depth coordinates (X, Y, Depth).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Return cached result if available</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span>

    <span class="c1"># 1. Get the original (pre-projected) coordinates slice for this element</span>
    <span class="n">original_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_original_coords_slice</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">original_coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_indices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">original_coords</span><span class="p">)</span>

    <span class="c1"># Handle single-point coils separately</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_coords_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span> <span class="o">=</span> <span class="n">original_coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Index of the single point</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span>

    <span class="c1"># 2. Apply smoothing based on style (only if &gt;= 2 points)</span>
    <span class="n">smoothing_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">smoothing_factor</span>
    <span class="n">smoothed_coords</span><span class="p">,</span> <span class="n">used_indices</span> <span class="o">=</span> <span class="n">smooth_coordinates</span><span class="p">(</span>
        <span class="n">original_coords</span><span class="p">,</span> <span class="n">smoothing_factor</span>
    <span class="p">)</span>

    <span class="c1"># 3. Cache and return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span> <span class="o">=</span> <span class="n">smoothed_coords</span>
    <span class="c1"># Map the indices from smooth_coordinates (relative to the slice) back to the</span>
    <span class="c1"># original residue indices or coordinate indices if needed elsewhere, but</span>
    <span class="c1"># for get_2d_coordinate_at_residue, we primarily need the mapping *between*</span>
    <span class="c1"># original sequence index and smoothed sequence index.</span>
    <span class="c1"># We store the indices *within the original slice* that were kept.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_original_indices</span> <span class="o">=</span> <span class="n">used_indices</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_smoothed_coords</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.coil.CoilSceneElement.get_end_connection_point" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_end_connection_point</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate the 2D coordinate for the end connection point.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing projected coordinates.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array [X, Y] or None if calculation fails.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/coil.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_end_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the 2D coordinate for the end connection point.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object containing projected coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array [X, Y] or None if calculation fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coords_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">coords_2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.structure.coil.CoilSceneElement.get_start_connection_point" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_start_connection_point</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate the 2D coordinate for the start connection point.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing projected coordinates.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>A NumPy array [X, Y] or None if calculation fails.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/structure/coil.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_start_connection_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the 2D coordinate for the start connection point.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object containing projected coordinates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array [X, Y] or None if calculation fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">coords_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">structure</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">coords_2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">coords_2d</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.structure.coil.CoilStyle"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.structure.base_structure.BaseStructureStyle" href="#flatprot.scene.structure.base_structure.BaseStructureStyle">BaseStructureStyle</a></code></p>


        <p>Style properties specific to Coil elements.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/structure/coil.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CoilStyle</span><span class="p">(</span><span class="n">BaseStructureStyle</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Style properties specific to Coil elements.&quot;&quot;&quot;</span>

    <span class="c1"># Override inherited defaults</span>
    <span class="n">color</span><span class="p">:</span> <span class="n">Color</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#5b5859&quot;</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Default color for coil (light grey).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">stroke_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Line width for coil.&quot;</span><span class="p">)</span>

    <span class="c1"># Coil-specific attribute</span>
    <span class="n">smoothing_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">le</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Fraction of points to keep during smoothing (0.0 to 1.0).&quot;</span>
        <span class="s2">&quot;Higher value means less smoothing.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div><p>options:
show_root_heading: true</p>
<h2 id="annotation-elements">Annotation Elements</h2>
<p>Classes representing annotation elements within the scene.</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.annotation.base_annotation.BaseAnnotationElement"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.base_element.BaseSceneElement" href="#flatprot.scene.base_element.BaseSceneElement">BaseSceneElement</a>[<span title="flatprot.scene.annotation.base_annotation.AnnotationStyleType">AnnotationStyleType</span>]</code>, <code><span title="abc.ABC">ABC</span></code>, <code><span title="typing.Generic">Generic</span>[<span title="flatprot.scene.annotation.base_annotation.AnnotationStyleType">AnnotationStyleType</span>]</code></p>


        <p>Abstract base class for scene elements representing annotations.</p>
<p>Stores the original target specification (coordinates, range, or range set)
and requires the corresponding ResidueRangeSet for the base scene element.
Requires a concrete style type inheriting from BaseAnnotationStyle.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/annotation/base_annotation.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">BaseAnnotationElement</span><span class="p">(</span>
    <span class="n">BaseSceneElement</span><span class="p">[</span><span class="n">AnnotationStyleType</span><span class="p">],</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">AnnotationStyleType</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for scene elements representing annotations.</span>

<span class="sd">    Stores the original target specification (coordinates, range, or range set)</span>
<span class="sd">    and requires the corresponding ResidueRangeSet for the base scene element.</span>
<span class="sd">    Requires a concrete style type inheriting from BaseAnnotationStyle.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># ID is required for annotations</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">ResidueCoordinate</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ResidueCoordinate</span><span class="p">],</span> <span class="n">ResidueRange</span><span class="p">,</span> <span class="n">ResidueRangeSet</span>
        <span class="p">],</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AnnotationStyleType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes a BaseAnnotationElement.</span>

<span class="sd">        Subclasses are responsible for constructing the appropriate `residue_range_set`</span>
<span class="sd">        based on their specific `target` type before calling this initializer.</span>

<span class="sd">        Args:</span>
<span class="sd">            id: A unique identifier for this annotation element.</span>
<span class="sd">            target: The original target specification (list of coordinates, range, or set).</span>
<span class="sd">                    Stored for use by subclasses in `get_coordinates`.</span>
<span class="sd">            residue_range_set: The ResidueRangeSet derived from the target, required by</span>
<span class="sd">                               the BaseSceneElement for its internal logic (e.g., bounding box).</span>
<span class="sd">            label: The label for the annotation.</span>
<span class="sd">            style: An optional specific style instance for this annotation.</span>
<span class="sd">            parent: The parent SceneGroup in the scene graph, if any.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the target type is not one of the allowed types.</span>
<span class="sd">            ValueError: If residue_range_set is empty.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate the target type</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">target</span><span class="p">,</span> <span class="p">(</span><span class="n">ResidueCoordinate</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">ResidueRange</span><span class="p">,</span> <span class="n">ResidueRangeSet</span><span class="p">)</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">ResidueCoordinate</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">target</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported target type for annotation: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Expected List[ResidueCoordinate], ResidueRange, or ResidueRangeSet.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="n">target</span>  <span class="c1"># Store the original target</span>

        <span class="c1"># Pass the explicitly provided residue_range_set to the BaseSceneElement constructor</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">target</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ResidueCoordinate</span><span class="p">],</span> <span class="n">ResidueRange</span><span class="p">,</span> <span class="n">ResidueRangeSet</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the target specification provided during initialization.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">targets_specific_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this annotation targets a list of specific coordinates.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolver</span><span class="p">:</span> <span class="n">CoordinateResolver</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the renderable coordinates for this annotation.</span>

<span class="sd">        Uses the provided CoordinateResolver to find the correct coordinates for</span>
<span class="sd">        its target (coordinates, range, or range set) in the context of the scene elements.</span>
<span class="sd">        The interpretation of the target depends on the concrete annotation type.</span>

<span class="sd">        Args:</span>
<span class="sd">            resolver: The CoordinateResolver instance for the scene.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array of coordinates (shape [N, 3], X, Y, Z) suitable for rendering.</span>

<span class="sd">        Raises:</span>
<span class="sd">            CoordinateCalculationError: If coordinates cannot be resolved.</span>
<span class="sd">            TargetResidueNotFoundError: If a target residue is not found.</span>
<span class="sd">            # Other specific exceptions possible depending on implementation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1"># Concrete subclasses (Marker, Line, Area) MUST implement default_style</span>
    <span class="nd">@property</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">default_style</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AnnotationStyleType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides the default style instance for this specific annotation type.</span>

<span class="sd">        Concrete subclasses must implement this property.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An instance of the specific AnnotationStyleType for this element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">get_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a fixed high depth value for annotations.</span>

<span class="sd">        This ensures annotations are rendered on top of other elements</span>
<span class="sd">        when sorted by depth (ascending).</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            A very large float value (infinity).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Return positive infinity to ensure annotations are sorted last (drawn on top)</span>
        <span class="c1"># when using ascending sort order for depth. Adjust if sort order is descending.</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.annotation.base_annotation.BaseAnnotationElement.default_style" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_style</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Provides the default style instance for this specific annotation type.</p>
<p>Concrete subclasses must implement this property.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="flatprot.scene.annotation.base_annotation.AnnotationStyleType">AnnotationStyleType</span></code>
              –
              <div class="doc-md-description">
                <p>An instance of the specific AnnotationStyleType for this element.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.annotation.base_annotation.BaseAnnotationElement.target" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">target</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Get the target specification provided during initialization.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.annotation.base_annotation.BaseAnnotationElement.targets_specific_coordinates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">targets_specific_coordinates</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Check if this annotation targets a list of specific coordinates.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.annotation.base_annotation.BaseAnnotationElement.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Initializes a BaseAnnotationElement.</p>
<p>Subclasses are responsible for constructing the appropriate <code>residue_range_set</code>
based on their specific <code>target</code> type before calling this initializer.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>id</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>A unique identifier for this annotation element.</p>
              </div>
            </li>
            <li>
              <b><code>target</code></b>
                  (<code><span title="typing.Union">Union</span>[<a class="autorefs autorefs-internal" title="ResidueCoordinate


  
      dataclass
   (flatprot.core.coordinates.ResidueCoordinate)" href="../core/#flatprot.core.coordinates.ResidueCoordinate">ResidueCoordinate</a>, <span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="ResidueCoordinate


  
      dataclass
   (flatprot.core.coordinates.ResidueCoordinate)" href="../core/#flatprot.core.coordinates.ResidueCoordinate">ResidueCoordinate</a>], <a class="autorefs autorefs-internal" title="ResidueRange


  
      dataclass
   (flatprot.core.coordinates.ResidueRange)" href="../core/#flatprot.core.coordinates.ResidueRange">ResidueRange</a>, <a class="autorefs autorefs-internal" title="ResidueRangeSet (flatprot.core.coordinates.ResidueRangeSet)" href="../core/#flatprot.core.coordinates.ResidueRangeSet">ResidueRangeSet</a>]</code>)
              –
              <div class="doc-md-description">
                <p>The original target specification (list of coordinates, range, or set).
    Stored for use by subclasses in <code>get_coordinates</code>.</p>
              </div>
            </li>
            <li>
              <b><code>residue_range_set</code></b>
              –
              <div class="doc-md-description">
                <p>The ResidueRangeSet derived from the target, required by
               the BaseSceneElement for its internal logic (e.g., bounding box).</p>
              </div>
            </li>
            <li>
              <b><code>label</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The label for the annotation.</p>
              </div>
            </li>
            <li>
              <b><code>style</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="flatprot.scene.annotation.base_annotation.AnnotationStyleType">AnnotationStyleType</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>An optional specific style instance for this annotation.</p>
              </div>
            </li>
            <li>
              <b><code>parent</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="flatprot.scene.base_element.SceneGroupType">SceneGroupType</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The parent SceneGroup in the scene graph, if any.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="TypeError">TypeError</span></code>
              –
              <div class="doc-md-description">
                <p>If the target type is not one of the allowed types.</p>
              </div>
            </li>
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If residue_range_set is empty.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/annotation/base_annotation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># ID is required for annotations</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">ResidueCoordinate</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ResidueCoordinate</span><span class="p">],</span> <span class="n">ResidueRange</span><span class="p">,</span> <span class="n">ResidueRangeSet</span>
    <span class="p">],</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AnnotationStyleType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes a BaseAnnotationElement.</span>

<span class="sd">    Subclasses are responsible for constructing the appropriate `residue_range_set`</span>
<span class="sd">    based on their specific `target` type before calling this initializer.</span>

<span class="sd">    Args:</span>
<span class="sd">        id: A unique identifier for this annotation element.</span>
<span class="sd">        target: The original target specification (list of coordinates, range, or set).</span>
<span class="sd">                Stored for use by subclasses in `get_coordinates`.</span>
<span class="sd">        residue_range_set: The ResidueRangeSet derived from the target, required by</span>
<span class="sd">                           the BaseSceneElement for its internal logic (e.g., bounding box).</span>
<span class="sd">        label: The label for the annotation.</span>
<span class="sd">        style: An optional specific style instance for this annotation.</span>
<span class="sd">        parent: The parent SceneGroup in the scene graph, if any.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the target type is not one of the allowed types.</span>
<span class="sd">        ValueError: If residue_range_set is empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate the target type</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">target</span><span class="p">,</span> <span class="p">(</span><span class="n">ResidueCoordinate</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">ResidueRange</span><span class="p">,</span> <span class="n">ResidueRangeSet</span><span class="p">)</span>
    <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">ResidueCoordinate</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">target</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unsupported target type for annotation: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Expected List[ResidueCoordinate], ResidueRange, or ResidueRangeSet.&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_target</span> <span class="o">=</span> <span class="n">target</span>  <span class="c1"># Store the original target</span>

    <span class="c1"># Pass the explicitly provided residue_range_set to the BaseSceneElement constructor</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.annotation.base_annotation.BaseAnnotationElement.get_coordinates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_coordinates</span><span class="p">(</span><span class="n">resolver</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate the renderable coordinates for this annotation.</p>
<p>Uses the provided CoordinateResolver to find the correct coordinates for
its target (coordinates, range, or range set) in the context of the scene elements.
The interpretation of the target depends on the concrete annotation type.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>resolver</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.scene.resolver.CoordinateResolver" href="#flatprot.scene.resolver.CoordinateResolver">CoordinateResolver</a></code>)
              –
              <div class="doc-md-description">
                <p>The CoordinateResolver instance for the scene.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="numpy.ndarray">ndarray</span></code>
              –
              <div class="doc-md-description">
                <p>A NumPy array of coordinates (shape [N, 3], X, Y, Z) suitable for rendering.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="CoordinateCalculationError">CoordinateCalculationError</span></code>
              –
              <div class="doc-md-description">
                <p>If coordinates cannot be resolved.</p>
              </div>
            </li>
            <li>
                  <code><a class="autorefs autorefs-internal" title="TargetResidueNotFoundError (flatprot.scene.errors.TargetResidueNotFoundError)" href="#flatprot.scene.errors.TargetResidueNotFoundError">TargetResidueNotFoundError</a></code>
              –
              <div class="doc-md-description">
                <p>If a target residue is not found.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/annotation/base_annotation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolver</span><span class="p">:</span> <span class="n">CoordinateResolver</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the renderable coordinates for this annotation.</span>

<span class="sd">    Uses the provided CoordinateResolver to find the correct coordinates for</span>
<span class="sd">    its target (coordinates, range, or range set) in the context of the scene elements.</span>
<span class="sd">    The interpretation of the target depends on the concrete annotation type.</span>

<span class="sd">    Args:</span>
<span class="sd">        resolver: The CoordinateResolver instance for the scene.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array of coordinates (shape [N, 3], X, Y, Z) suitable for rendering.</span>

<span class="sd">    Raises:</span>
<span class="sd">        CoordinateCalculationError: If coordinates cannot be resolved.</span>
<span class="sd">        TargetResidueNotFoundError: If a target residue is not found.</span>
<span class="sd">        # Other specific exceptions possible depending on implementation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.annotation.base_annotation.BaseAnnotationElement.get_depth" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_depth</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Return a fixed high depth value for annotations.</p>
<p>This ensures annotations are rendered on top of other elements
when sorted by depth (ascending).</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.structure.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object (unused).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>
              –
              <div class="doc-md-description">
                <p>A very large float value (infinity).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/annotation/base_annotation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a fixed high depth value for annotations.</span>

<span class="sd">    This ensures annotations are rendered on top of other elements</span>
<span class="sd">    when sorted by depth (ascending).</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        A very large float value (infinity).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Return positive infinity to ensure annotations are sorted last (drawn on top)</span>
    <span class="c1"># when using ascending sort order for depth. Adjust if sort order is descending.</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.annotation.base_annotation.BaseAnnotationStyle"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.base_element.BaseSceneStyle" href="#flatprot.scene.base_element.BaseSceneStyle">BaseSceneStyle</a></code></p>


        <p>Base style for annotation elements.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/annotation/base_annotation.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">BaseAnnotationStyle</span><span class="p">(</span><span class="n">BaseSceneStyle</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base style for annotation elements.&quot;&quot;&quot;</span>

    <span class="n">color</span><span class="p">:</span> <span class="n">Color</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">Color</span><span class="p">((</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Default color for the annotation (hex string). Red.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">offset</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;2D offset (x, y) from the anchor point in canvas units.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">label_offset</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;2D offset (x, y) from the label anchor point in canvas units.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">label_color</span><span class="p">:</span> <span class="n">Color</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">Color</span><span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Default color for the label (hex string). Black.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">label_font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">12.0</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Font size for the label.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">label_font_weight</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Font weight for the label.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">label_font_family</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;Arial&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Font family for the label.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional text label for the annotation.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.annotation.point.PointAnnotation"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.annotation.base_annotation.BaseAnnotationElement" href="#flatprot.scene.annotation.base_annotation.BaseAnnotationElement">BaseAnnotationElement</a>[<a class="autorefs autorefs-internal" title="flatprot.scene.annotation.point.PointAnnotationStyle" href="#flatprot.scene.annotation.point.PointAnnotationStyle">PointAnnotationStyle</a>]</code></p>


        <p>Represents an annotation marking a single residue coordinate.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/annotation/point.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">PointAnnotation</span><span class="p">(</span><span class="n">BaseAnnotationElement</span><span class="p">[</span><span class="n">PointAnnotationStyle</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents an annotation marking a single residue coordinate.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">,</span>  <span class="c1"># Expects a single coordinate</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PointAnnotationStyle</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes a PointAnnotation.</span>

<span class="sd">        Args:</span>
<span class="sd">            id: A unique identifier for this annotation element.</span>
<span class="sd">            target_coordinate: The specific residue coordinate this annotation targets.</span>
<span class="sd">            style: An optional specific style instance for this annotation.</span>
<span class="sd">            metadata: Optional dictionary for storing arbitrary metadata.</span>
<span class="sd">            parent: The parent SceneGroup in the scene graph, if any.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ResidueCoordinate</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;target_coordinate must be a single ResidueCoordinate instance.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Call superclass init, passing the single coordinate in a list</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>  <span class="c1"># Base class expects a list</span>
            <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">target_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResidueCoordinate</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the specific target coordinate for this point annotation.&quot;&quot;&quot;</span>
        <span class="c1"># target_coordinates is guaranteed to be a list with one element by __init__</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_style</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PointAnnotationStyle</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides the default style for PointAnnotation elements.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">PointAnnotationStyle</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolver</span><span class="p">:</span> <span class="n">CoordinateResolver</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the coordinates for the point annotation marker.</span>

<span class="sd">        Uses the CoordinateResolver to find the rendered coordinate of the target residue.</span>

<span class="sd">        Args:</span>
<span class="sd">            resolver: The CoordinateResolver instance for the scene.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array of shape [1, 3] containing the (X, Y, Z) coordinates</span>
<span class="sd">            of the target point.</span>

<span class="sd">        Raises:</span>
<span class="sd">            CoordinateCalculationError: If the coordinate cannot be resolved.</span>
<span class="sd">            TargetResidueNotFoundError: If the target residue is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_coordinate</span>
        <span class="c1"># Delegate resolution to the resolver</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">target_res</span><span class="p">)</span>
        <span class="c1"># Resolver handles errors, so point should be valid if no exception was raised</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">point</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.annotation.point.PointAnnotation.default_style" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_style</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Provides the default style for PointAnnotation elements.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.annotation.point.PointAnnotation.target_coordinate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">target_coordinate</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Get the specific target coordinate for this point annotation.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.annotation.point.PointAnnotation.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Initializes a PointAnnotation.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>id</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>A unique identifier for this annotation element.</p>
              </div>
            </li>
            <li>
              <b><code>target_coordinate</code></b>
              –
              <div class="doc-md-description">
                <p>The specific residue coordinate this annotation targets.</p>
              </div>
            </li>
            <li>
              <b><code>style</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="flatprot.scene.annotation.point.PointAnnotationStyle" href="#flatprot.scene.annotation.point.PointAnnotationStyle">PointAnnotationStyle</a>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>An optional specific style instance for this annotation.</p>
              </div>
            </li>
            <li>
              <b><code>metadata</code></b>
              –
              <div class="doc-md-description">
                <p>Optional dictionary for storing arbitrary metadata.</p>
              </div>
            </li>
            <li>
              <b><code>parent</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="flatprot.scene.base_element.SceneGroupType">SceneGroupType</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The parent SceneGroup in the scene graph, if any.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/annotation/point.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">,</span>  <span class="c1"># Expects a single coordinate</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PointAnnotationStyle</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes a PointAnnotation.</span>

<span class="sd">    Args:</span>
<span class="sd">        id: A unique identifier for this annotation element.</span>
<span class="sd">        target_coordinate: The specific residue coordinate this annotation targets.</span>
<span class="sd">        style: An optional specific style instance for this annotation.</span>
<span class="sd">        metadata: Optional dictionary for storing arbitrary metadata.</span>
<span class="sd">        parent: The parent SceneGroup in the scene graph, if any.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ResidueCoordinate</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;target_coordinate must be a single ResidueCoordinate instance.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Call superclass init, passing the single coordinate in a list</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>  <span class="c1"># Base class expects a list</span>
        <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.annotation.point.PointAnnotation.get_coordinates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_coordinates</span><span class="p">(</span><span class="n">resolver</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate the coordinates for the point annotation marker.</p>
<p>Uses the CoordinateResolver to find the rendered coordinate of the target residue.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>resolver</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.scene.resolver.CoordinateResolver" href="#flatprot.scene.resolver.CoordinateResolver">CoordinateResolver</a></code>)
              –
              <div class="doc-md-description">
                <p>The CoordinateResolver instance for the scene.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="numpy.ndarray">ndarray</span></code>
              –
              <div class="doc-md-description">
                <p>A NumPy array of shape [1, 3] containing the (X, Y, Z) coordinates</p>
              </div>
            </li>
            <li>
                  <code><span title="numpy.ndarray">ndarray</span></code>
              –
              <div class="doc-md-description">
                <p>of the target point.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="CoordinateCalculationError">CoordinateCalculationError</span></code>
              –
              <div class="doc-md-description">
                <p>If the coordinate cannot be resolved.</p>
              </div>
            </li>
            <li>
                  <code><a class="autorefs autorefs-internal" title="TargetResidueNotFoundError (flatprot.scene.errors.TargetResidueNotFoundError)" href="#flatprot.scene.errors.TargetResidueNotFoundError">TargetResidueNotFoundError</a></code>
              –
              <div class="doc-md-description">
                <p>If the target residue is not found.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/annotation/point.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolver</span><span class="p">:</span> <span class="n">CoordinateResolver</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the coordinates for the point annotation marker.</span>

<span class="sd">    Uses the CoordinateResolver to find the rendered coordinate of the target residue.</span>

<span class="sd">    Args:</span>
<span class="sd">        resolver: The CoordinateResolver instance for the scene.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array of shape [1, 3] containing the (X, Y, Z) coordinates</span>
<span class="sd">        of the target point.</span>

<span class="sd">    Raises:</span>
<span class="sd">        CoordinateCalculationError: If the coordinate cannot be resolved.</span>
<span class="sd">        TargetResidueNotFoundError: If the target residue is not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_coordinate</span>
    <span class="c1"># Delegate resolution to the resolver</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">target_res</span><span class="p">)</span>
    <span class="c1"># Resolver handles errors, so point should be valid if no exception was raised</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">point</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.annotation.point.PointAnnotationStyle"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.annotation.base_annotation.BaseAnnotationStyle" href="#flatprot.scene.annotation.base_annotation.BaseAnnotationStyle">BaseAnnotationStyle</a></code></p>


        <p>Style properties specific to PointAnnotation elements.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/annotation/point.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">PointAnnotationStyle</span><span class="p">(</span><span class="n">BaseAnnotationStyle</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Style properties specific to PointAnnotation elements.&quot;&quot;&quot;</span>

    <span class="n">marker_shape</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;circle&quot;</span><span class="p">,</span> <span class="s2">&quot;square&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="s2">&quot;diamond&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;circle&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Shape of the marker.&quot;</span>
    <span class="p">)</span>
    <span class="n">marker_radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Radius of the point marker.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.annotation.line.LineAnnotation"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.annotation.base_annotation.BaseAnnotationElement" href="#flatprot.scene.annotation.base_annotation.BaseAnnotationElement">BaseAnnotationElement</a>[<a class="autorefs autorefs-internal" title="flatprot.scene.annotation.line.LineAnnotationStyle" href="#flatprot.scene.annotation.line.LineAnnotationStyle">LineAnnotationStyle</a>]</code></p>


        <p>Represents an annotation connecting two specific residue coordinates with a line.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/annotation/line.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">LineAnnotation</span><span class="p">(</span><span class="n">BaseAnnotationElement</span><span class="p">[</span><span class="n">LineAnnotationStyle</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents an annotation connecting two specific residue coordinates with a line.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start_coordinate</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">,</span>
        <span class="n">end_coordinate</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LineAnnotationStyle</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes a LineAnnotation.</span>

<span class="sd">        Args:</span>
<span class="sd">            id: A unique identifier for this annotation element.</span>
<span class="sd">            target_coordinates: A list containing exactly two ResidueCoordinates</span>
<span class="sd">                                defining the start and end points of the line.</span>
<span class="sd">            style: The specific style instance for this line annotation.</span>
<span class="sd">            label: The label for the annotation.</span>
<span class="sd">            parent: The parent SceneGroup in the scene graph, if any.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If `target_coordinates` does not contain exactly two elements.</span>
<span class="sd">            TypeError: If elements in `target_coordinates` are not ResidueCoordinate instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_coordinate</span><span class="p">,</span> <span class="n">ResidueCoordinate</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">end_coordinate</span><span class="p">,</span> <span class="n">ResidueCoordinate</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;LineAnnotation must be initialized with two ResidueCoordinate instances.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Call superclass init</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="p">[</span><span class="n">start_coordinate</span><span class="p">,</span> <span class="n">end_coordinate</span><span class="p">],</span>
            <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">start_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResidueCoordinate</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the start target coordinate for the line.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">end_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResidueCoordinate</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the end target coordinate for the line.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_style</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LineAnnotationStyle</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides the default style for LineAnnotation elements.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LineAnnotationStyle</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolver</span><span class="p">:</span> <span class="n">CoordinateResolver</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the start and end coordinates for the line annotation.</span>

<span class="sd">        Uses the CoordinateResolver to find the rendered coordinates of the two target residues.</span>

<span class="sd">        Args:</span>
<span class="sd">            resolver: The CoordinateResolver instance for the scene.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array of shape [2, 3] containing the (X, Y, Z) coordinates</span>
<span class="sd">            of the start and end points.</span>

<span class="sd">        Raises:</span>
<span class="sd">            CoordinateCalculationError: If coordinates cannot be resolved.</span>
<span class="sd">            TargetResidueNotFoundError: If a target residue is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_coordinate</span>
        <span class="n">end_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_coordinate</span>

        <span class="n">start_point</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">start_res</span><span class="p">)</span>
        <span class="n">end_point</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">end_res</span><span class="p">)</span>

        <span class="c1"># Return as a [2, 3] array</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">start_point</span><span class="p">,</span> <span class="n">end_point</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.annotation.line.LineAnnotation.default_style" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_style</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Provides the default style for LineAnnotation elements.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.annotation.line.LineAnnotation.end_coordinate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">end_coordinate</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Get the end target coordinate for the line.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.annotation.line.LineAnnotation.start_coordinate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">start_coordinate</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Get the start target coordinate for the line.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.annotation.line.LineAnnotation.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">start_coordinate</span><span class="p">,</span> <span class="n">end_coordinate</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Initializes a LineAnnotation.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>id</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>A unique identifier for this annotation element.</p>
              </div>
            </li>
            <li>
              <b><code>target_coordinates</code></b>
              –
              <div class="doc-md-description">
                <p>A list containing exactly two ResidueCoordinates
                defining the start and end points of the line.</p>
              </div>
            </li>
            <li>
              <b><code>style</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="flatprot.scene.annotation.line.LineAnnotationStyle" href="#flatprot.scene.annotation.line.LineAnnotationStyle">LineAnnotationStyle</a>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The specific style instance for this line annotation.</p>
              </div>
            </li>
            <li>
              <b><code>label</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The label for the annotation.</p>
              </div>
            </li>
            <li>
              <b><code>parent</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="flatprot.scene.base_element.SceneGroupType">SceneGroupType</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The parent SceneGroup in the scene graph, if any.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If <code>target_coordinates</code> does not contain exactly two elements.</p>
              </div>
            </li>
            <li>
                  <code><span title="TypeError">TypeError</span></code>
              –
              <div class="doc-md-description">
                <p>If elements in <code>target_coordinates</code> are not ResidueCoordinate instances.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/annotation/line.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">start_coordinate</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">,</span>
    <span class="n">end_coordinate</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">,</span>
    <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LineAnnotationStyle</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes a LineAnnotation.</span>

<span class="sd">    Args:</span>
<span class="sd">        id: A unique identifier for this annotation element.</span>
<span class="sd">        target_coordinates: A list containing exactly two ResidueCoordinates</span>
<span class="sd">                            defining the start and end points of the line.</span>
<span class="sd">        style: The specific style instance for this line annotation.</span>
<span class="sd">        label: The label for the annotation.</span>
<span class="sd">        parent: The parent SceneGroup in the scene graph, if any.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If `target_coordinates` does not contain exactly two elements.</span>
<span class="sd">        TypeError: If elements in `target_coordinates` are not ResidueCoordinate instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_coordinate</span><span class="p">,</span> <span class="n">ResidueCoordinate</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">end_coordinate</span><span class="p">,</span> <span class="n">ResidueCoordinate</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;LineAnnotation must be initialized with two ResidueCoordinate instances.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Call superclass init</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="p">[</span><span class="n">start_coordinate</span><span class="p">,</span> <span class="n">end_coordinate</span><span class="p">],</span>
        <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.annotation.line.LineAnnotation.get_coordinates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_coordinates</span><span class="p">(</span><span class="n">resolver</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate the start and end coordinates for the line annotation.</p>
<p>Uses the CoordinateResolver to find the rendered coordinates of the two target residues.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>resolver</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.scene.resolver.CoordinateResolver" href="#flatprot.scene.resolver.CoordinateResolver">CoordinateResolver</a></code>)
              –
              <div class="doc-md-description">
                <p>The CoordinateResolver instance for the scene.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="numpy.ndarray">ndarray</span></code>
              –
              <div class="doc-md-description">
                <p>A NumPy array of shape [2, 3] containing the (X, Y, Z) coordinates</p>
              </div>
            </li>
            <li>
                  <code><span title="numpy.ndarray">ndarray</span></code>
              –
              <div class="doc-md-description">
                <p>of the start and end points.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="CoordinateCalculationError">CoordinateCalculationError</span></code>
              –
              <div class="doc-md-description">
                <p>If coordinates cannot be resolved.</p>
              </div>
            </li>
            <li>
                  <code><a class="autorefs autorefs-internal" title="TargetResidueNotFoundError (flatprot.scene.errors.TargetResidueNotFoundError)" href="#flatprot.scene.errors.TargetResidueNotFoundError">TargetResidueNotFoundError</a></code>
              –
              <div class="doc-md-description">
                <p>If a target residue is not found.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/annotation/line.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolver</span><span class="p">:</span> <span class="n">CoordinateResolver</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the start and end coordinates for the line annotation.</span>

<span class="sd">    Uses the CoordinateResolver to find the rendered coordinates of the two target residues.</span>

<span class="sd">    Args:</span>
<span class="sd">        resolver: The CoordinateResolver instance for the scene.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array of shape [2, 3] containing the (X, Y, Z) coordinates</span>
<span class="sd">        of the start and end points.</span>

<span class="sd">    Raises:</span>
<span class="sd">        CoordinateCalculationError: If coordinates cannot be resolved.</span>
<span class="sd">        TargetResidueNotFoundError: If a target residue is not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_coordinate</span>
    <span class="n">end_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_coordinate</span>

    <span class="n">start_point</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">start_res</span><span class="p">)</span>
    <span class="n">end_point</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">end_res</span><span class="p">)</span>

    <span class="c1"># Return as a [2, 3] array</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">start_point</span><span class="p">,</span> <span class="n">end_point</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.annotation.line.LineAnnotationStyle"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.annotation.base_annotation.BaseAnnotationStyle" href="#flatprot.scene.annotation.base_annotation.BaseAnnotationStyle">BaseAnnotationStyle</a></code></p>


        <p>Style properties specific to LineAnnotation elements.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/annotation/line.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">LineAnnotationStyle</span><span class="p">(</span><span class="n">BaseAnnotationStyle</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Style properties specific to LineAnnotation elements.&quot;&quot;&quot;</span>

    <span class="n">stroke_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Width of the annotation line.&quot;</span>
    <span class="p">)</span>
    <span class="n">line_style</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Dash pattern for the line (e.g., (5, 5) for dashed). Empty tuple means solid.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">connector_color</span><span class="p">:</span> <span class="n">Color</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#000000&quot;</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Color of the connector circles at the start and end of the line.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">line_color</span><span class="p">:</span> <span class="n">Color</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">Color</span><span class="p">(</span><span class="s2">&quot;#000000&quot;</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Color of the line.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">arrowhead_start</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Whether to draw an arrowhead at the start of the line.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">arrowhead_end</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Whether to draw an arrowhead at the end of the line.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">connector_radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Radius of the connector circles at the start and end of the line.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.annotation.area.AreaAnnotation"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.annotation.base_annotation.BaseAnnotationElement" href="#flatprot.scene.annotation.base_annotation.BaseAnnotationElement">BaseAnnotationElement</a>[<a class="autorefs autorefs-internal" title="flatprot.scene.annotation.area.AreaAnnotationStyle" href="#flatprot.scene.annotation.area.AreaAnnotationStyle">AreaAnnotationStyle</a>]</code></p>


        <p>Represents an annotation highlighting an area encompassing specific residues or ranges.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/annotation/area.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">AreaAnnotation</span><span class="p">(</span><span class="n">BaseAnnotationElement</span><span class="p">[</span><span class="n">AreaAnnotationStyle</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents an annotation highlighting an area encompassing specific residues or ranges.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AreaAnnotationStyle</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">residue_range_set</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ResidueRangeSet</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes an AreaAnnotation.</span>

<span class="sd">        Exactly one of `residue_range_set` or `target_coordinates` must be provided</span>
<span class="sd">        to define the residues encompassed by the area.</span>

<span class="sd">        Args:</span>
<span class="sd">            id: A unique identifier for this annotation element.</span>
<span class="sd">            style: The specific style instance for this area annotation.</span>
<span class="sd">            label: Optional text label for the annotation.</span>
<span class="sd">            residue_range_set: The set of residue ranges this annotation targets.</span>
<span class="sd">            parent: The parent SceneGroup in the scene graph, if any.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If neither or both targeting arguments are provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Metadata argument removed, using label directly</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="n">residue_range_set</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_outline_coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_style</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AreaAnnotationStyle</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides the default style for AreaAnnotation elements.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">AreaAnnotationStyle</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolver</span><span class="p">:</span> <span class="n">CoordinateResolver</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the padded convex hull outline coordinates for the area annotation.</span>

<span class="sd">        Fetches coordinates for all residues defined in the residue_range_set</span>
<span class="sd">        using the CoordinateResolver. Calculates the convex hull if at least 3</span>
<span class="sd">        points are found.</span>

<span class="sd">        Args:</span>
<span class="sd">            resolver: The CoordinateResolver instance for the scene.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array of 2D + Depth coordinates (shape [N, 3]) representing</span>
<span class="sd">            the padded convex hull outline of the area (X, Y, AvgDepth).</span>

<span class="sd">        Raises:</span>
<span class="sd">            CoordinateCalculationError: If fewer than 3 valid coordinates are found</span>
<span class="sd">                                        for the specified residue range set, or if</span>
<span class="sd">                                        hull/padding calculation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating area coordinates for &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; using resolver&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AreaAnnotation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; has no target defined.&quot;</span><span class="p">)</span>

        <span class="c1"># 1. Collect all available target 3D coordinates using the resolver</span>
        <span class="n">target_coords_3d_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">res_coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">point</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">res_coord</span><span class="p">)</span>
                <span class="n">target_coords_3d_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">CoordinateCalculationError</span><span class="p">,</span> <span class="n">TargetResidueNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not resolve coordinate for </span><span class="si">{</span><span class="n">res_coord</span><span class="si">}</span><span class="s2"> in AreaAnnotation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Skipping point.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Let unexpected errors propagate</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_coords_3d_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Need at least 3 resolvable points to calculate area for annotation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;, found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_coords_3d_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> within its range set.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Convert list to numpy array for calculations</span>
        <span class="n">target_coords_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_coords_3d_list</span><span class="p">)</span>

        <span class="n">target_coords_2d</span> <span class="o">=</span> <span class="n">target_coords_3d</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Use only XY for shape calculation</span>
        <span class="n">avg_depth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_coords_3d</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]))</span>  <span class="c1"># Calculate average depth</span>

        <span class="c1"># 2. Compute the convex hull using Andrew&#39;s monotone chain algorithm</span>
        <span class="n">hull_points_2d</span> <span class="o">=</span> <span class="n">_convex_hull</span><span class="p">(</span><span class="n">target_coords_2d</span><span class="p">)</span>

        <span class="c1"># 3. Apply padding by offsetting the vertices of the convex hull</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">padding</span>
        <span class="k">if</span> <span class="n">padding</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hull_points_2d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Add check for non-empty hull</span>
            <span class="n">padded_points_2d</span> <span class="o">=</span> <span class="n">_apply_padding</span><span class="p">(</span><span class="n">hull_points_2d</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">padded_points_2d</span> <span class="o">=</span> <span class="n">hull_points_2d</span>

        <span class="c1"># 4. Combine XY with the calculated average depth</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">padded_points_2d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># This could happen if input points were collinear/identical and hull failed</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not compute valid outline for AreaAnnotation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; after padding. This is a calculation issue, please check the residue range set.&quot;</span>
            <span class="p">)</span>

        <span class="n">num_outline_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">padded_points_2d</span><span class="p">)</span>
        <span class="n">depth_column</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_outline_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">avg_depth</span><span class="p">)</span>
        <span class="n">outline_coords_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">padded_points_2d</span><span class="p">,</span> <span class="n">depth_column</span><span class="p">))</span>

        <span class="c1"># self._cached_outline_coords = outline_coords_3d # Removed caching</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully calculated area coordinates for &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outline_coords_3d</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="flatprot.scene.annotation.area.AreaAnnotation.default_style" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_style</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Provides the default style for AreaAnnotation elements.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.annotation.area.AreaAnnotation.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">residue_range_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Initializes an AreaAnnotation.</p>
<p>Exactly one of <code>residue_range_set</code> or <code>target_coordinates</code> must be provided
to define the residues encompassed by the area.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>id</code></b>
                  (<code><span title="str">str</span></code>)
              –
              <div class="doc-md-description">
                <p>A unique identifier for this annotation element.</p>
              </div>
            </li>
            <li>
              <b><code>style</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="flatprot.scene.annotation.area.AreaAnnotationStyle" href="#flatprot.scene.annotation.area.AreaAnnotationStyle">AreaAnnotationStyle</a>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The specific style instance for this area annotation.</p>
              </div>
            </li>
            <li>
              <b><code>label</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Optional text label for the annotation.</p>
              </div>
            </li>
            <li>
              <b><code>residue_range_set</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="ResidueRangeSet (flatprot.core.ResidueRangeSet)" href="../core/#flatprot.core.coordinates.ResidueRangeSet">ResidueRangeSet</a>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The set of residue ranges this annotation targets.</p>
              </div>
            </li>
            <li>
              <b><code>parent</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="flatprot.scene.base_element.SceneGroupType">SceneGroupType</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The parent SceneGroup in the scene graph, if any.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If neither or both targeting arguments are provided.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/annotation/area.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">style</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AreaAnnotationStyle</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">residue_range_set</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ResidueRangeSet</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroupType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes an AreaAnnotation.</span>

<span class="sd">    Exactly one of `residue_range_set` or `target_coordinates` must be provided</span>
<span class="sd">    to define the residues encompassed by the area.</span>

<span class="sd">    Args:</span>
<span class="sd">        id: A unique identifier for this annotation element.</span>
<span class="sd">        style: The specific style instance for this area annotation.</span>
<span class="sd">        label: Optional text label for the annotation.</span>
<span class="sd">        residue_range_set: The set of residue ranges this annotation targets.</span>
<span class="sd">        parent: The parent SceneGroup in the scene graph, if any.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If neither or both targeting arguments are provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Metadata argument removed, using label directly</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">residue_range_set</span><span class="p">,</span>
        <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cached_outline_coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.annotation.area.AreaAnnotation.get_coordinates" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_coordinates</span><span class="p">(</span><span class="n">resolver</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Calculate the padded convex hull outline coordinates for the area annotation.</p>
<p>Fetches coordinates for all residues defined in the residue_range_set
using the CoordinateResolver. Calculates the convex hull if at least 3
points are found.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>resolver</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.scene.resolver.CoordinateResolver" href="#flatprot.scene.resolver.CoordinateResolver">CoordinateResolver</a></code>)
              –
              <div class="doc-md-description">
                <p>The CoordinateResolver instance for the scene.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="numpy.ndarray">ndarray</span></code>
              –
              <div class="doc-md-description">
                <p>A NumPy array of 2D + Depth coordinates (shape [N, 3]) representing</p>
              </div>
            </li>
            <li>
                  <code><span title="numpy.ndarray">ndarray</span></code>
              –
              <div class="doc-md-description">
                <p>the padded convex hull outline of the area (X, Y, AvgDepth).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><a class="autorefs autorefs-internal" title="CoordinateCalculationError (flatprot.core.CoordinateCalculationError)" href="../core/#flatprot.core.errors.CoordinateCalculationError">CoordinateCalculationError</a></code>
              –
              <div class="doc-md-description">
                <p>If fewer than 3 valid coordinates are found
                        for the specified residue range set, or if
                        hull/padding calculation fails.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/annotation/area.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolver</span><span class="p">:</span> <span class="n">CoordinateResolver</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the padded convex hull outline coordinates for the area annotation.</span>

<span class="sd">    Fetches coordinates for all residues defined in the residue_range_set</span>
<span class="sd">    using the CoordinateResolver. Calculates the convex hull if at least 3</span>
<span class="sd">    points are found.</span>

<span class="sd">    Args:</span>
<span class="sd">        resolver: The CoordinateResolver instance for the scene.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array of 2D + Depth coordinates (shape [N, 3]) representing</span>
<span class="sd">        the padded convex hull outline of the area (X, Y, AvgDepth).</span>

<span class="sd">    Raises:</span>
<span class="sd">        CoordinateCalculationError: If fewer than 3 valid coordinates are found</span>
<span class="sd">                                    for the specified residue range set, or if</span>
<span class="sd">                                    hull/padding calculation fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating area coordinates for &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; using resolver&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AreaAnnotation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; has no target defined.&quot;</span><span class="p">)</span>

    <span class="c1"># 1. Collect all available target 3D coordinates using the resolver</span>
    <span class="n">target_coords_3d_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">res_coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">res_coord</span><span class="p">)</span>
            <span class="n">target_coords_3d_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">CoordinateCalculationError</span><span class="p">,</span> <span class="n">TargetResidueNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not resolve coordinate for </span><span class="si">{</span><span class="n">res_coord</span><span class="si">}</span><span class="s2"> in AreaAnnotation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Skipping point.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Let unexpected errors propagate</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_coords_3d_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Need at least 3 resolvable points to calculate area for annotation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;, found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_coords_3d_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> within its range set.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Convert list to numpy array for calculations</span>
    <span class="n">target_coords_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_coords_3d_list</span><span class="p">)</span>

    <span class="n">target_coords_2d</span> <span class="o">=</span> <span class="n">target_coords_3d</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># Use only XY for shape calculation</span>
    <span class="n">avg_depth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_coords_3d</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]))</span>  <span class="c1"># Calculate average depth</span>

    <span class="c1"># 2. Compute the convex hull using Andrew&#39;s monotone chain algorithm</span>
    <span class="n">hull_points_2d</span> <span class="o">=</span> <span class="n">_convex_hull</span><span class="p">(</span><span class="n">target_coords_2d</span><span class="p">)</span>

    <span class="c1"># 3. Apply padding by offsetting the vertices of the convex hull</span>
    <span class="n">padding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">padding</span>
    <span class="k">if</span> <span class="n">padding</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">hull_points_2d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Add check for non-empty hull</span>
        <span class="n">padded_points_2d</span> <span class="o">=</span> <span class="n">_apply_padding</span><span class="p">(</span><span class="n">hull_points_2d</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">padded_points_2d</span> <span class="o">=</span> <span class="n">hull_points_2d</span>

    <span class="c1"># 4. Combine XY with the calculated average depth</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">padded_points_2d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># This could happen if input points were collinear/identical and hull failed</span>
        <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not compute valid outline for AreaAnnotation &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; after padding. This is a calculation issue, please check the residue range set.&quot;</span>
        <span class="p">)</span>

    <span class="n">num_outline_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">padded_points_2d</span><span class="p">)</span>
    <span class="n">depth_column</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_outline_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">avg_depth</span><span class="p">)</span>
    <span class="n">outline_coords_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">padded_points_2d</span><span class="p">,</span> <span class="n">depth_column</span><span class="p">))</span>

    <span class="c1"># self._cached_outline_coords = outline_coords_3d # Removed caching</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully calculated area coordinates for &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outline_coords_3d</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.annotation.area.AreaAnnotationStyle"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="flatprot.scene.annotation.base_annotation.BaseAnnotationStyle" href="#flatprot.scene.annotation.base_annotation.BaseAnnotationStyle">BaseAnnotationStyle</a></code></p>


        <p>Style properties specific to AreaAnnotation elements.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/annotation/area.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">AreaAnnotationStyle</span><span class="p">(</span><span class="n">BaseAnnotationStyle</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Style properties specific to AreaAnnotation elements.&quot;&quot;&quot;</span>

    <span class="n">fill_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Color</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">Color</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional fill color (hex string). If None, uses &#39;color&#39; with reduced opacity.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fill_opacity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Opacity for the fill color.&quot;</span>
    <span class="p">)</span>
    <span class="n">stroke_width</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Width of the area outline stroke.&quot;</span>
    <span class="p">)</span>
    <span class="n">line_style</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Dash pattern for the outline (e.g., (5, 5) for dashed). Empty tuple means solid.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">padding</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Padding pixels added outside the convex hull.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">interpolation_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number of points to generate along the hull outline before smoothing.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">smoothing_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Window size for rolling average smoothing (odd number recommended).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div><p>options:
show_root_heading: true</p>
<h2 id="coordinate-resolver">Coordinate Resolver</h2>
<p>Handles the mapping between residue identifiers and scene coordinates.</p>


<div class="doc doc-object doc-class">



<a id="flatprot.scene.resolver.CoordinateResolver"></a>
    <div class="doc doc-contents first">


        <p>Resolves ResidueCoordinates to their final rendered coordinates.</p>
<p>This class iterates through relevant scene elements to find the one
covering the target residue and asks that element for the coordinate
in its specific rendered space.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/resolver.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CoordinateResolver</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resolves ResidueCoordinates to their final rendered coordinates.</span>

<span class="sd">    This class iterates through relevant scene elements to find the one</span>
<span class="sd">    covering the target residue and asks that element for the coordinate</span>
<span class="sd">    in its specific rendered space.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">element_registry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseSceneElement</span><span class="p">]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the CoordinateResolver.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: The core Structure object.</span>
<span class="sd">            element_registry: The Scene&#39;s dictionary mapping element IDs to elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="c1"># Filter the registry to only contain structure elements for efficiency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure_elements</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">element</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">element_registry</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">BaseStructureSceneElement</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_residue</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the covering structure element and gets the rendered coordinate.</span>

<span class="sd">        Args:</span>
<span class="sd">            target_residue: The ResidueCoordinate to resolve.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A NumPy array [3,] with the resolved (X, Y, Z) coordinate.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TargetResidueNotFoundError: If the residue is not found within any</span>
<span class="sd">                                        covering structure element&#39;s range.</span>
<span class="sd">            CoordinateCalculationError: If the covering element exists but fails</span>
<span class="sd">                                        to calculate the specific coordinate, or</span>
<span class="sd">                                        if no covering element is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">covering_element</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseStructureSceneElement</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure_elements</span><span class="p">:</span>
            <span class="c1"># Check if the element&#39;s range set exists and contains the target</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">element</span><span class="o">.</span><span class="n">residue_range_set</span>
                <span class="ow">and</span> <span class="n">target_residue</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">residue_range_set</span>
            <span class="p">):</span>
                <span class="n">covering_element</span> <span class="o">=</span> <span class="n">element</span>
                <span class="k">break</span>  <span class="c1"># Use the first one found</span>

        <span class="k">if</span> <span class="n">covering_element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No structure element found covering target residue </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Raise specific error indicating no element coverage</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Target residue </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2"> is not covered by any structure element in the scene.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Ask the covering element for the coordinate</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resolved_coord</span> <span class="o">=</span> <span class="n">covering_element</span><span class="o">.</span><span class="n">get_coordinate_at_residue</span><span class="p">(</span>
                <span class="n">target_residue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">resolved_coord</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Element covered the range but couldn&#39;t resolve the specific point</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; could not provide coordinate for </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; failed to resolve coordinate for </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Validate shape</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resolved_coord</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">resolved_coord</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span>
                <span class="mi">3</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; returned invalid coordinate shape for </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">resolved_coord</span><span class="p">)</span><span class="si">}</span><span class="s2"> shape </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">resolved_coord</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;shape&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; returned invalid coordinate data for </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">resolved_coord</span>

        <span class="k">except</span> <span class="n">TargetResidueNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># This can happen if the element&#39;s internal lookup fails</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; could not find </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2"> internally: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span>  <span class="c1"># Re-raise the specific error</span>

        <span class="k">except</span> <span class="n">CoordinateCalculationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Coordinate calculation error within element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; for </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span>  <span class="c1"># Re-raise calculation errors from the element</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Catch unexpected errors from the element&#39;s method</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected error in get_coordinate_at_residue for element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; and </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected error resolving coordinate for </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2"> via element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.resolver.CoordinateResolver.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">element_registry</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Initializes the CoordinateResolver.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object.</p>
              </div>
            </li>
            <li>
              <b><code>element_registry</code></b>
                  (<code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <a class="autorefs autorefs-internal" title="flatprot.scene.base_element.BaseSceneElement" href="#flatprot.scene.base_element.BaseSceneElement">BaseSceneElement</a>]</code>)
              –
              <div class="doc-md-description">
                <p>The Scene's dictionary mapping element IDs to elements.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/resolver.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">element_registry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseSceneElement</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the CoordinateResolver.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object.</span>
<span class="sd">        element_registry: The Scene&#39;s dictionary mapping element IDs to elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure</span>
    <span class="c1"># Filter the registry to only contain structure elements for efficiency</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_structure_elements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">element</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">element_registry</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">BaseStructureSceneElement</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="flatprot.scene.resolver.CoordinateResolver.resolve" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">resolve</span><span class="p">(</span><span class="n">target_residue</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Finds the covering structure element and gets the rendered coordinate.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>target_residue</code></b>
                  (<code><a class="autorefs autorefs-internal" title="ResidueCoordinate


  
      dataclass
   (flatprot.core.ResidueCoordinate)" href="../core/#flatprot.core.coordinates.ResidueCoordinate">ResidueCoordinate</a></code>)
              –
              <div class="doc-md-description">
                <p>The ResidueCoordinate to resolve.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="numpy.ndarray">ndarray</span></code>
              –
              <div class="doc-md-description">
                <p>A NumPy array [3,] with the resolved (X, Y, Z) coordinate.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><a class="autorefs autorefs-internal" title="TargetResidueNotFoundError (flatprot.scene.errors.TargetResidueNotFoundError)" href="#flatprot.scene.errors.TargetResidueNotFoundError">TargetResidueNotFoundError</a></code>
              –
              <div class="doc-md-description">
                <p>If the residue is not found within any
                        covering structure element's range.</p>
              </div>
            </li>
            <li>
                  <code><a class="autorefs autorefs-internal" title="CoordinateCalculationError (flatprot.core.CoordinateCalculationError)" href="../core/#flatprot.core.errors.CoordinateCalculationError">CoordinateCalculationError</a></code>
              –
              <div class="doc-md-description">
                <p>If the covering element exists but fails
                        to calculate the specific coordinate, or
                        if no covering element is found.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/scene/resolver.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_residue</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the covering structure element and gets the rendered coordinate.</span>

<span class="sd">    Args:</span>
<span class="sd">        target_residue: The ResidueCoordinate to resolve.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array [3,] with the resolved (X, Y, Z) coordinate.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TargetResidueNotFoundError: If the residue is not found within any</span>
<span class="sd">                                    covering structure element&#39;s range.</span>
<span class="sd">        CoordinateCalculationError: If the covering element exists but fails</span>
<span class="sd">                                    to calculate the specific coordinate, or</span>
<span class="sd">                                    if no covering element is found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">covering_element</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseStructureSceneElement</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure_elements</span><span class="p">:</span>
        <span class="c1"># Check if the element&#39;s range set exists and contains the target</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">element</span><span class="o">.</span><span class="n">residue_range_set</span>
            <span class="ow">and</span> <span class="n">target_residue</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">residue_range_set</span>
        <span class="p">):</span>
            <span class="n">covering_element</span> <span class="o">=</span> <span class="n">element</span>
            <span class="k">break</span>  <span class="c1"># Use the first one found</span>

    <span class="k">if</span> <span class="n">covering_element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No structure element found covering target residue </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Raise specific error indicating no element coverage</span>
        <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Target residue </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2"> is not covered by any structure element in the scene.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Ask the covering element for the coordinate</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resolved_coord</span> <span class="o">=</span> <span class="n">covering_element</span><span class="o">.</span><span class="n">get_coordinate_at_residue</span><span class="p">(</span>
            <span class="n">target_residue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">resolved_coord</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Element covered the range but couldn&#39;t resolve the specific point</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; could not provide coordinate for </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; failed to resolve coordinate for </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Validate shape</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resolved_coord</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">resolved_coord</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span>
            <span class="mi">3</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; returned invalid coordinate shape for </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">resolved_coord</span><span class="p">)</span><span class="si">}</span><span class="s2"> shape </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">resolved_coord</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;shape&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; returned invalid coordinate data for </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">resolved_coord</span>

    <span class="k">except</span> <span class="n">TargetResidueNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># This can happen if the element&#39;s internal lookup fails</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; could not find </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2"> internally: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span>  <span class="c1"># Re-raise the specific error</span>

    <span class="k">except</span> <span class="n">CoordinateCalculationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Coordinate calculation error within element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; for </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">raise</span>  <span class="c1"># Re-raise calculation errors from the element</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Catch unexpected errors from the element&#39;s method</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unexpected error in get_coordinate_at_residue for element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; and </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unexpected error resolving coordinate for </span><span class="si">{</span><span class="n">target_residue</span><span class="si">}</span><span class="s2"> via element &#39;</span><span class="si">{</span><span class="n">covering_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>options:
show_root_heading: true
members_order: source</p>
<h2 id="scene-utilities">Scene Utilities</h2>
<p>Helper functions for creating and modifying scenes.</p>


<div class="doc doc-object doc-function">



<a id="flatprot.utils.scene_utils.create_scene_from_structure"></a>
    <div class="doc doc-contents first">

        <p>Creates a Scene object populated with elements derived from a Structure.</p>
<p>Iterates through chains and secondary structure elements within the provided
Structure object, creating corresponding SceneGroup and structure-specific
SceneElements (Helix, Sheet, Coil). Elements within each chain group are
sorted by their mean depth based on the pre-calculated coordinates in the
Structure object.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The core Structure object containing chain, secondary structure,
       and pre-projected coordinate data (X, Y, Depth).</p>
              </div>
            </li>
            <li>
              <b><code>default_styles</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Union">Union</span>[<a class="autorefs autorefs-internal" title="flatprot.scene.BaseStructureStyle" href="#flatprot.scene.structure.base_structure.BaseStructureStyle">BaseStructureStyle</a>, <span title="flatprot.scene.connection.ConnectionStyle">ConnectionStyle</span>]]]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>An optional dictionary mapping lowercase element type names
            ('helix', 'sheet', 'coil', 'connection') to specific style
            instances to be used as defaults. If not provided or a type
            is missing, the element's own default style will be used.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><a class="autorefs autorefs-internal" title="flatprot.scene.Scene" href="#flatprot.scene.Scene">Scene</a></code>
              –
              <div class="doc-md-description">
                <p>A Scene object representing the structure.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><a class="autorefs autorefs-internal" title="SceneCreationError (flatprot.scene.SceneCreationError)" href="#flatprot.scene.errors.SceneCreationError">SceneCreationError</a></code>
              –
              <div class="doc-md-description">
                <p>If Structure has no coordinates or other critical errors occur.</p>
              </div>
            </li>
            <li>
                  <code><a class="autorefs autorefs-internal" title="CoordinateCalculationError (flatprot.core.CoordinateCalculationError)" href="../core/#flatprot.core.errors.CoordinateCalculationError">CoordinateCalculationError</a></code>
              –
              <div class="doc-md-description">
                <p>If depth calculation fails for an element.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/utils/scene_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_scene_from_structure</span><span class="p">(</span>
    <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span>
    <span class="n">default_styles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
        <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">BaseStructureStyle</span><span class="p">,</span> <span class="n">ConnectionStyle</span><span class="p">]]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Scene</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a Scene object populated with elements derived from a Structure.</span>

<span class="sd">    Iterates through chains and secondary structure elements within the provided</span>
<span class="sd">    Structure object, creating corresponding SceneGroup and structure-specific</span>
<span class="sd">    SceneElements (Helix, Sheet, Coil). Elements within each chain group are</span>
<span class="sd">    sorted by their mean depth based on the pre-calculated coordinates in the</span>
<span class="sd">    Structure object.</span>

<span class="sd">    Args:</span>
<span class="sd">        structure: The core Structure object containing chain, secondary structure,</span>
<span class="sd">                   and pre-projected coordinate data (X, Y, Depth).</span>
<span class="sd">        default_styles: An optional dictionary mapping lowercase element type names</span>
<span class="sd">                        (&#39;helix&#39;, &#39;sheet&#39;, &#39;coil&#39;, &#39;connection&#39;) to specific style</span>
<span class="sd">                        instances to be used as defaults. If not provided or a type</span>
<span class="sd">                        is missing, the element&#39;s own default style will be used.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A Scene object representing the structure.</span>

<span class="sd">    Raises:</span>
<span class="sd">        SceneCreationError: If Structure has no coordinates or other critical errors occur.</span>
<span class="sd">        CoordinateCalculationError: If depth calculation fails for an element.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">structure</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SceneCreationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Structure &#39;</span><span class="si">{</span><span class="n">structure</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; has no coordinates.&quot;</span><span class="p">)</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="n">Scene</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">)</span>
    <span class="n">styles</span> <span class="o">=</span> <span class="n">default_styles</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">chain_id</span><span class="p">,</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">structure</span><span class="p">:</span>
        <span class="n">chain_group</span> <span class="o">=</span> <span class="n">SceneGroup</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">structure</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">chain_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">scene</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">chain_group</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&gt;Adding chain group </span><span class="si">{</span><span class="n">chain_group</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> to scene&quot;</span><span class="p">)</span>

        <span class="n">elements_with_depth</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chain_elements_in_order</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseStructureSceneElement</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ss_element</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">secondary_structure</span><span class="p">:</span>
            <span class="n">ss_type</span> <span class="o">=</span> <span class="n">ss_element</span><span class="o">.</span><span class="n">secondary_structure_type</span>
            <span class="n">element_info</span> <span class="o">=</span> <span class="n">STRUCTURE_ELEMENT_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ss_type</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">element_info</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported secondary structure type: </span><span class="si">{</span><span class="n">ss_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">ElementClass</span><span class="p">,</span> <span class="n">DefaultStyleClass</span> <span class="o">=</span> <span class="n">element_info</span>
            <span class="c1"># Ensure ss_element start/end are valid ints</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ss_element</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ss_element</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
            <span class="n">ss_range_set</span> <span class="o">=</span> <span class="n">ResidueRangeSet</span><span class="p">(</span>
                <span class="p">[</span><span class="n">ResidueRange</span><span class="p">(</span><span class="n">chain_id</span><span class="o">=</span><span class="n">chain_id</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_idx</span><span class="p">)]</span>
            <span class="p">)</span>

            <span class="c1"># Determine the style: Use provided default or element&#39;s default</span>
            <span class="n">element_type_key</span> <span class="o">=</span> <span class="n">ss_type</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">style_instance</span> <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">element_type_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">viz_element</span> <span class="o">=</span> <span class="n">ElementClass</span><span class="p">(</span>
                    <span class="n">residue_range_set</span><span class="o">=</span><span class="n">ss_range_set</span><span class="p">,</span>
                    <span class="n">style</span><span class="o">=</span><span class="n">style_instance</span><span class="p">,</span>  <span class="c1"># Pass the specific instance or None</span>
                <span class="p">)</span>

                <span class="c1"># Calculate depth based on *pre-projected* coords in structure</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="n">viz_element</span><span class="o">.</span><span class="n">get_depth</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Raise or warn if depth calculation fails</span>
                    <span class="k">raise</span> <span class="n">CoordinateCalculationError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not calculate depth for element </span><span class="si">{</span><span class="n">viz_element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="n">elements_with_depth</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">viz_element</span><span class="p">,</span> <span class="n">depth</span><span class="p">))</span>
                <span class="n">chain_elements_in_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">viz_element</span>
                <span class="p">)</span>  <span class="c1"># &lt;-- Add element to ordered list</span>

            <span class="k">except</span> <span class="n">CoordinateCalculationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Log or handle coordinate/depth errors</span>
                <span class="c1"># For now, re-raise to indicate a problem</span>
                <span class="k">raise</span> <span class="n">SceneCreationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error processing element </span><span class="si">{</span><span class="n">ss_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ss_range_set</span><span class="si">}</span><span class="s2"> in chain </span><span class="si">{</span><span class="n">chain_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Catch unexpected errors during element creation</span>
                <span class="k">raise</span> <span class="n">SceneCreationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unexpected error creating element </span><span class="si">{</span><span class="n">ss_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ss_range_set</span><span class="si">}</span><span class="s2"> in chain </span><span class="si">{</span><span class="n">chain_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="c1"># Sort elements by depth (farthest first)</span>
        <span class="n">elements_with_depth</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Add Connections between adjacent elements in the original structural order</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chain_elements_in_order</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">element_i</span> <span class="o">=</span> <span class="n">chain_elements_in_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">element_i_plus_1</span> <span class="o">=</span> <span class="n">chain_elements_in_order</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">element_i</span><span class="o">.</span><span class="n">is_adjacent_to</span><span class="p">(</span><span class="n">element_i_plus_1</span><span class="p">):</span>
                <span class="c1"># Get the default connection style if provided</span>
                <span class="n">conn_style</span> <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;connection&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># Ensure it&#39;s a ConnectionStyle or None before passing</span>
                <span class="k">if</span> <span class="n">conn_style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">conn_style</span><span class="p">,</span> <span class="n">ConnectionStyle</span>
                <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Invalid type provided for &#39;connection&#39; style. Expected ConnectionStyle, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">conn_style</span><span class="p">)</span><span class="si">}</span><span class="s2">. Using default.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">conn_style</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">conn</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span>
                    <span class="n">start_element</span><span class="o">=</span><span class="n">element_i</span><span class="p">,</span>
                    <span class="n">end_element</span><span class="o">=</span><span class="n">element_i_plus_1</span><span class="p">,</span>
                    <span class="n">style</span><span class="o">=</span><span class="n">conn_style</span><span class="p">,</span>  <span class="c1"># Pass the default style</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&gt;Adding connection </span><span class="si">{</span><span class="n">conn</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> to chain group </span><span class="si">{</span><span class="n">chain_group</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">scene</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="n">chain_group</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Add sorted elements to the chain group</span>
        <span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">elements_with_depth</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&gt;Adding element </span><span class="si">{</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> to chain group </span><span class="si">{</span><span class="n">chain_group</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">scene</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="n">chain_group</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scene</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-function">



<a id="flatprot.utils.scene_utils.add_annotations_to_scene"></a>
    <div class="doc doc-contents first">

        <p>Parses annotations from a file and adds them to the scene.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>annotations_path</code></b>
                  (<code><span title="pathlib.Path">Path</span></code>)
              –
              <div class="doc-md-description">
                <p>Path to the TOML annotations file.</p>
              </div>
            </li>
            <li>
              <b><code>scene</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.scene.Scene" href="#flatprot.scene.Scene">Scene</a></code>)
              –
              <div class="doc-md-description">
                <p>The Scene object to add annotations to.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><a class="autorefs autorefs-internal" title="AnnotationFileNotFoundError (flatprot.io.AnnotationFileNotFoundError)" href="../io/#flatprot.io.errors.AnnotationFileNotFoundError">AnnotationFileNotFoundError</a></code>
              –
              <div class="doc-md-description">
                <p>If the annotation file is not found.</p>
              </div>
            </li>
            <li>
                  <code><a class="autorefs autorefs-internal" title="MalformedAnnotationError (flatprot.io.MalformedAnnotationError)" href="../io/#flatprot.io.errors.MalformedAnnotationError">MalformedAnnotationError</a></code>
              –
              <div class="doc-md-description">
                <p>If the annotation file has invalid content or format.</p>
              </div>
            </li>
            <li>
                  <code><a class="autorefs autorefs-internal" title="AnnotationError (flatprot.io.AnnotationError)" href="../io/#flatprot.io.errors.AnnotationError">AnnotationError</a></code>
              –
              <div class="doc-md-description">
                <p>For other annotation parsing related errors.</p>
              </div>
            </li>
            <li>
                  <code><a class="autorefs autorefs-internal" title="SceneCreationError (flatprot.scene.SceneCreationError)" href="#flatprot.scene.errors.SceneCreationError">SceneCreationError</a></code>
              –
              <div class="doc-md-description">
                <p>If adding an element to the scene fails (e.g., duplicate ID).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/utils/scene_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_annotations_to_scene</span><span class="p">(</span><span class="n">annotations_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">scene</span><span class="p">:</span> <span class="n">Scene</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parses annotations from a file and adds them to the scene.</span>

<span class="sd">    Args:</span>
<span class="sd">        annotations_path: Path to the TOML annotations file.</span>
<span class="sd">        scene: The Scene object to add annotations to.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AnnotationFileNotFoundError: If the annotation file is not found.</span>
<span class="sd">        MalformedAnnotationError: If the annotation file has invalid content or format.</span>
<span class="sd">        AnnotationError: For other annotation parsing related errors.</span>
<span class="sd">        SceneCreationError: If adding an element to the scene fails (e.g., duplicate ID).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Instantiate the parser with just the file path</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">AnnotationParser</span><span class="p">(</span><span class="n">annotations_path</span><span class="p">)</span>
        <span class="c1"># Parse the file to get fully initialized annotation objects</span>
        <span class="n">annotation_objects</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseAnnotationElement</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">annotation_objects</span><span class="p">)</span><span class="si">}</span><span class="s2"> annotations from </span><span class="si">{</span><span class="n">annotations_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">annotation_objects</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&gt; Adding annotation &#39;</span><span class="si">{</span><span class="n">annotation</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="n">annotation</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">) to scene&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">scene</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to add annotation &#39;</span><span class="si">{</span><span class="n">annotation</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; to scene: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">SceneCreationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to add annotation &#39;</span><span class="si">{</span><span class="n">annotation</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&#39; to scene: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="k">except</span> <span class="p">(</span>
        <span class="n">AnnotationFileNotFoundError</span><span class="p">,</span>
        <span class="n">MalformedAnnotationError</span><span class="p">,</span>
        <span class="n">AnnotationError</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse annotations from </span><span class="si">{</span><span class="n">annotations_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Re-raise parser errors as they indicate a problem with the input file</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred while adding annotations: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Re-raise unexpected errors</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><p>options:
show_root_heading: true</p>


<div class="doc doc-object doc-function">



<a id="flatprot.utils.domain_utils.create_domain_aware_scene"></a>
    <div class="doc doc-contents first">

        <p>Creates a Scene containing only specified domains, each in its own group.</p>
<p>Elements (structure, connections, annotations) are assigned to their respective
domain group. Elements not belonging to any defined domain are discarded.
Domain groups are translated by a fixed margin based on the <code>spacing</code> parameter.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>projected_structure</code></b>
                  (<code><a class="autorefs autorefs-internal" title="flatprot.core.Structure" href="../core/#flatprot.core.Structure">Structure</a></code>)
              –
              <div class="doc-md-description">
                <p>The Structure object with final 2D projected coordinates.</p>
              </div>
            </li>
            <li>
              <b><code>domain_definitions</code></b>
                  (<code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="flatprot.utils.domain_utils.DomainTransformation" href="../transformation/#flatprot.utils.domain_utils.DomainTransformation">DomainTransformation</a>]</code>)
              –
              <div class="doc-md-description">
                <p>List of DomainTransformation objects defining the domains.
                The domain_id attribute is crucial.</p>
              </div>
            </li>
            <li>
              <b><code>spacing</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>0.0</code>
)
              –
              <div class="doc-md-description">
                <p>Fixed margin used to separate domain groups in pixels.</p>
              </div>
            </li>
            <li>
              <b><code>arrangement</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;horizontal&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>How to arrange domain groups ('horizontal' or 'vertical').</p>
              </div>
            </li>
            <li>
              <b><code>default_styles</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Union">Union</span>[<a class="autorefs autorefs-internal" title="flatprot.scene.BaseStructureStyle" href="#flatprot.scene.structure.base_structure.BaseStructureStyle">BaseStructureStyle</a>, <span title="flatprot.scene.connection.ConnectionStyle">ConnectionStyle</span>, <a class="autorefs autorefs-internal" title="flatprot.scene.AreaAnnotationStyle" href="#flatprot.scene.annotation.area.AreaAnnotationStyle">AreaAnnotationStyle</a>]]]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Optional dictionary mapping element type names to style instances.</p>
              </div>
            </li>
            <li>
              <b><code>domain_scop_ids</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="str">str</span>]]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Optional dictionary mapping domain_id to an annotation string
             (e.g., SCOP ID) used for AreaAnnotation labels.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><a class="autorefs autorefs-internal" title="flatprot.scene.Scene" href="#flatprot.scene.Scene">Scene</a></code>
              –
              <div class="doc-md-description">
                <p>A Scene object containing only the specified domain groups, laid out.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If arrangement is invalid, structure lacks coordinates, or
        domain_definitions have issues (missing IDs when needed, duplicates).</p>
              </div>
            </li>
            <li>
                  <code><span title="TypeError">TypeError</span></code>
              –
              <div class="doc-md-description">
                <p>If incompatible style types are provided in default_styles.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="quote">
              <summary>Source code in <code>src/flatprot/utils/domain_utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_domain_aware_scene</span><span class="p">(</span>
    <span class="n">projected_structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span>
    <span class="n">domain_definitions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DomainTransformation</span><span class="p">],</span>
    <span class="n">spacing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">arrangement</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
    <span class="n">default_styles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
        <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">BaseStructureStyle</span><span class="p">,</span> <span class="n">ConnectionStyle</span><span class="p">,</span> <span class="n">AreaAnnotationStyle</span><span class="p">]]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">domain_scop_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Scene</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a Scene containing only specified domains, each in its own group.</span>

<span class="sd">    Elements (structure, connections, annotations) are assigned to their respective</span>
<span class="sd">    domain group. Elements not belonging to any defined domain are discarded.</span>
<span class="sd">    Domain groups are translated by a fixed margin based on the `spacing` parameter.</span>

<span class="sd">    Args:</span>
<span class="sd">        projected_structure: The Structure object with final 2D projected coordinates.</span>
<span class="sd">        domain_definitions: List of DomainTransformation objects defining the domains.</span>
<span class="sd">                            The domain_id attribute is crucial.</span>
<span class="sd">        spacing: Fixed margin used to separate domain groups in pixels.</span>
<span class="sd">        arrangement: How to arrange domain groups (&#39;horizontal&#39; or &#39;vertical&#39;).</span>
<span class="sd">        default_styles: Optional dictionary mapping element type names to style instances.</span>
<span class="sd">        domain_scop_ids: Optional dictionary mapping domain_id to an annotation string</span>
<span class="sd">                         (e.g., SCOP ID) used for AreaAnnotation labels.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A Scene object containing only the specified domain groups, laid out.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If arrangement is invalid, structure lacks coordinates, or</span>
<span class="sd">                    domain_definitions have issues (missing IDs when needed, duplicates).</span>
<span class="sd">        TypeError: If incompatible style types are provided in default_styles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">projected_structure</span><span class="o">.</span><span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="n">projected_structure</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input projected_structure has no coordinates.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">arrangement</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="s2">&quot;vertical&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Arrangement must be &#39;horizontal&#39; or &#39;vertical&#39;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">domain_scop_ids</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">domain_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">domain_definitions</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;All domain_definitions must have a domain_id if domain_scop_ids is provided.&quot;</span>
        <span class="p">)</span>
    <span class="n">defined_domain_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">domain_id</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">domain_definitions</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">domain_id</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">defined_domain_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">defined_domain_ids</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Duplicate domain_ids found in domain_definitions.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">domain_scop_ids</span><span class="p">:</span>
        <span class="n">scop_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">domain_scop_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">scop_keys</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">defined_domain_ids</span><span class="p">)):</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">scop_keys</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">defined_domain_ids</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;domain_scop_ids keys not in domain_ids: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">scene</span> <span class="o">=</span> <span class="n">Scene</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">projected_structure</span><span class="p">)</span>
    <span class="n">styles</span> <span class="o">=</span> <span class="n">default_styles</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">domain_groups</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SceneGroup</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Map domain_id to SceneGroup</span>
    <span class="n">domain_ids_in_order</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Maintain order for fixed layout</span>
    <span class="n">domain_tf_lookup</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">DomainTransformation</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- 1. Create Domain Groups Only ---</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating scene groups for defined domains...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">domain_tf</span> <span class="ow">in</span> <span class="n">domain_definitions</span><span class="p">:</span>
        <span class="n">domain_id</span> <span class="o">=</span> <span class="n">domain_tf</span><span class="o">.</span><span class="n">domain_id</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">domain_tf</span><span class="o">.</span><span class="n">domain_range</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">domain_id</span> <span class="ow">in</span> <span class="n">domain_groups</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping duplicate domain ID &#39;</span><span class="si">{</span><span class="n">domain_id</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">domain_group</span> <span class="o">=</span> <span class="n">SceneGroup</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">domain_id</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="n">GroupTransform</span><span class="p">())</span>
        <span class="n">scene</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">domain_group</span><span class="p">)</span>
        <span class="n">domain_groups</span><span class="p">[</span><span class="n">domain_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">domain_group</span>
        <span class="n">domain_ids_in_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">domain_id</span><span class="p">)</span>
        <span class="n">domain_tf_lookup</span><span class="p">[</span><span class="n">domain_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">domain_tf</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">domain_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> domain groups.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">domain_groups</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No domain groups created. Scene will be empty.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scene</span>  <span class="c1"># Return early if no domains defined/created</span>

    <span class="c1"># --- 2. Assign Structure Elements ONLY to Domain Groups ---</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assigning structure elements to domain groups...&quot;</span><span class="p">)</span>
    <span class="n">element_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SceneGroup</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Map element ID to its parent group</span>
    <span class="n">elements_assigned_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">elements_discarded_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">projected_structure</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ss_element</span> <span class="ow">in</span> <span class="n">chain</span><span class="o">.</span><span class="n">secondary_structure</span><span class="p">:</span>
            <span class="n">ss_type</span> <span class="o">=</span> <span class="n">ss_element</span><span class="o">.</span><span class="n">secondary_structure_type</span>
            <span class="n">element_info</span> <span class="o">=</span> <span class="n">STRUCTURE_ELEMENT_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ss_type</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">element_info</span><span class="p">:</span>
                <span class="n">elements_discarded_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>  <span class="c1"># Skip unsupported types</span>

            <span class="n">ElementClass</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">element_info</span>
            <span class="n">ss_range_set</span> <span class="o">=</span> <span class="n">ResidueRangeSet</span><span class="p">([</span><span class="n">ss_element</span><span class="p">])</span>
            <span class="n">element_type_key</span> <span class="o">=</span> <span class="n">ss_type</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="n">assigned_group</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SceneGroup</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Find the domain this element belongs to</span>
            <span class="k">for</span> <span class="n">domain_tf</span> <span class="ow">in</span> <span class="n">domain_definitions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ss_element</span> <span class="ow">in</span> <span class="n">domain_tf</span><span class="o">.</span><span class="n">domain_range</span><span class="p">:</span>
                    <span class="n">domain_id</span> <span class="o">=</span> <span class="n">domain_tf</span><span class="o">.</span><span class="n">domain_id</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">domain_tf</span><span class="o">.</span><span class="n">domain_range</span><span class="p">)</span>
                    <span class="n">assigned_group</span> <span class="o">=</span> <span class="n">domain_groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">domain_id</span><span class="p">)</span>
                    <span class="k">break</span>  <span class="c1"># Assign to first matching domain</span>

            <span class="c1"># If element belongs to a defined domain, create and add it</span>
            <span class="k">if</span> <span class="n">assigned_group</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">base_style</span> <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">element_type_key</span><span class="p">)</span>
                    <span class="c1"># Type check base style</span>
                    <span class="k">if</span> <span class="n">base_style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                        <span class="n">base_style</span><span class="p">,</span> <span class="n">BaseStructureStyle</span>
                    <span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Invalid style type for &#39;</span><span class="si">{</span><span class="n">element_type_key</span><span class="si">}</span><span class="s2">&#39;. Using default.&quot;</span>
                        <span class="p">)</span>
                        <span class="n">base_style</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="n">viz_element</span> <span class="o">=</span> <span class="n">ElementClass</span><span class="p">(</span>
                        <span class="n">residue_range_set</span><span class="o">=</span><span class="n">ss_range_set</span><span class="p">,</span>
                        <span class="n">style</span><span class="o">=</span><span class="n">base_style</span><span class="p">,</span>  <span class="c1"># Pass style or None</span>
                    <span class="p">)</span>
                    <span class="n">scene</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">viz_element</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="n">assigned_group</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="n">element_map</span><span class="p">[</span><span class="n">viz_element</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">assigned_group</span>
                    <span class="n">elements_assigned_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Error creating/assigning element </span><span class="si">{</span><span class="n">ss_element</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">elements_discarded_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Element does not belong to any defined domain, discard it</span>
                <span class="n">elements_discarded_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Assigned </span><span class="si">{</span><span class="n">elements_assigned_count</span><span class="si">}</span><span class="s2"> elements to domain groups. Discarded </span><span class="si">{</span><span class="n">elements_discarded_count</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="p">)</span>

    <span class="c1"># --- 3. Add Connections ONLY Within the Same Domain Group ---</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding connections within domain groups...&quot;</span><span class="p">)</span>
    <span class="n">all_structure_elements</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">get_sequential_structure_elements</span><span class="p">()</span>
    <span class="n">connections_added_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">connections_discarded_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_structure_elements</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">element_i</span> <span class="o">=</span> <span class="n">all_structure_elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">element_i_plus_1</span> <span class="o">=</span> <span class="n">all_structure_elements</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Check adjacency first</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">element_i</span><span class="o">.</span><span class="n">is_adjacent_to</span><span class="p">(</span><span class="n">element_i_plus_1</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="c1"># Find the groups these elements belong to (if they were added)</span>
        <span class="n">group_i</span> <span class="o">=</span> <span class="n">element_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">element_i</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">group_i_plus_1</span> <span class="o">=</span> <span class="n">element_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">element_i_plus_1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Only add connection if both elements exist and are in the SAME group</span>
        <span class="k">if</span> <span class="n">group_i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">group_i</span> <span class="ow">is</span> <span class="n">group_i_plus_1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base_conn_style</span> <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;connection&quot;</span><span class="p">)</span>
                <span class="c1"># Type check</span>
                <span class="k">if</span> <span class="n">base_conn_style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">base_conn_style</span><span class="p">,</span> <span class="n">ConnectionStyle</span>
                <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Invalid type for &#39;connection&#39; style. Using default.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">base_conn_style</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">conn</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span>
                    <span class="n">start_element</span><span class="o">=</span><span class="n">element_i</span><span class="p">,</span>
                    <span class="n">end_element</span><span class="o">=</span><span class="n">element_i_plus_1</span><span class="p">,</span>
                    <span class="n">style</span><span class="o">=</span><span class="n">base_conn_style</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Adding connection between </span><span class="si">{</span><span class="n">element_i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">element_i_plus_1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> to group </span><span class="si">{</span><span class="n">group_i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">scene</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="n">group_i</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">connections_added_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed adding connection between </span><span class="si">{</span><span class="n">element_i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">element_i_plus_1</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">connections_discarded_count</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># Count as discarded if creation fails</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Connection spans groups or involves discarded elements</span>
            <span class="n">connections_discarded_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="n">connections_added_count</span><span class="si">}</span><span class="s2"> connections within groups. Discarded </span><span class="si">{</span><span class="n">connections_discarded_count</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="p">)</span>

    <span class="c1"># --- 4. Add Domain Annotations to Respective Groups ---</span>
    <span class="k">if</span> <span class="n">domain_scop_ids</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding domain annotations...&quot;</span><span class="p">)</span>
        <span class="n">annotations_added_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">base_area_style</span> <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;area_annotation&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base area style: </span><span class="si">{</span><span class="n">base_area_style</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Type check</span>
        <span class="k">if</span> <span class="n">base_area_style</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">base_area_style</span><span class="p">,</span> <span class="n">AreaAnnotationStyle</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Invalid type for &#39;area_annotation&#39; style. Using default.&quot;</span><span class="p">)</span>
            <span class="n">base_area_style</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">domain_id</span><span class="p">,</span> <span class="n">scop_id</span> <span class="ow">in</span> <span class="n">domain_scop_ids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">domain_groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">domain_id</span><span class="p">)</span>
            <span class="n">domain_tf</span> <span class="o">=</span> <span class="n">domain_tf_lookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">domain_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">domain_tf</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot add annotation for domain &#39;</span><span class="si">{</span><span class="n">domain_id</span><span class="si">}</span><span class="s2">&#39;: missing group/definition.&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">target_range_set</span> <span class="o">=</span> <span class="n">ResidueRangeSet</span><span class="p">([</span><span class="n">domain_tf</span><span class="o">.</span><span class="n">domain_range</span><span class="p">])</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="n">AreaAnnotation</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">domain_id</span><span class="si">}</span><span class="s2">_area&quot;</span><span class="p">,</span>
                    <span class="n">residue_range_set</span><span class="o">=</span><span class="n">target_range_set</span><span class="p">,</span>
                    <span class="n">style</span><span class="o">=</span><span class="n">base_area_style</span><span class="p">,</span>  <span class="c1"># Pass style or None</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">scop_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Add annotation as child of the specific domain group</span>
                <span class="n">scene</span><span class="o">.</span><span class="n">add_element</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">annotations_added_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed adding area annotation for domain </span><span class="si">{</span><span class="n">domain_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="n">annotations_added_count</span><span class="si">}</span><span class="s2"> domain area annotations.&quot;</span><span class="p">)</span>

    <span class="c1"># --- 5. Apply Fixed Layout Translation to Domain Groups ---</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying fixed layout translations...&quot;</span><span class="p">)</span>
    <span class="n">layout_applied_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Use the ordered list for consistent layout</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">domain_ids_in_order</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">domain_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">domain_ids_in_order</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">domain_groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">domain_id</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">total</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">continue</span>  <span class="c1"># Should not happen based on checks</span>

        <span class="c1"># Calculate fixed translation based on index and spacing (margin)</span>
        <span class="k">if</span> <span class="n">arrangement</span> <span class="o">==</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">:</span>
            <span class="n">translate_x</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">spacing</span>
            <span class="n">translate_y</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># vertical</span>
            <span class="n">translate_x</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">translate_y</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">spacing</span>

        <span class="c1"># Apply the translation</span>
        <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">transforms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">GroupTransform</span><span class="p">()</span>  <span class="c1"># Should exist, but safety check</span>
        <span class="n">group</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">translate</span> <span class="o">=</span> <span class="p">(</span><span class="n">translate_x</span><span class="p">,</span> <span class="n">translate_y</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Applied fixed translate to group </span><span class="si">{</span><span class="n">domain_id</span><span class="si">}</span><span class="s2">: (</span><span class="si">{</span><span class="n">translate_x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">translate_y</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="n">layout_applied_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied fixed layout transforms to </span><span class="si">{</span><span class="n">layout_applied_count</span><span class="si">}</span><span class="s2"> domain groups.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scene</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><p>options:
show_root_heading: true</p>
<h2 id="scene-errors">Scene Errors</h2>
<p>Exceptions specific to scene creation or processing.</p>


<div class="doc doc-object doc-module">



<a id="flatprot.scene.errors"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="flatprot.scene.errors.CircularDependencyError" class="doc doc-heading">
            <code>CircularDependencyError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="SceneError (flatprot.scene.errors.SceneError)" href="#flatprot.scene.errors.SceneError">SceneError</a></code>, <code><span title="ValueError">ValueError</span></code></p>


        <p>Raised when an operation would create a circular parent-child relationship.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">CircularDependencyError</span><span class="p">(</span><span class="n">SceneError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>  <span class="c1"># Inherit ValueError for context</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when an operation would create a circular parent-child relationship.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="flatprot.scene.errors.DuplicateElementError" class="doc doc-heading">
            <code>DuplicateElementError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="SceneError (flatprot.scene.errors.SceneError)" href="#flatprot.scene.errors.SceneError">SceneError</a></code></p>


        <p>Raised when attempting to add an element that already exists.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DuplicateElementError</span><span class="p">(</span><span class="n">SceneError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when attempting to add an element that already exists.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="flatprot.scene.errors.ElementNotFoundError" class="doc doc-heading">
            <code>ElementNotFoundError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="SceneError (flatprot.scene.errors.SceneError)" href="#flatprot.scene.errors.SceneError">SceneError</a></code></p>


        <p>Raised when a scene element is not found, typically by ID.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ElementNotFoundError</span><span class="p">(</span><span class="n">SceneError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when a scene element is not found, typically by ID.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="flatprot.scene.errors.ElementTypeError" class="doc doc-heading">
            <code>ElementTypeError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="SceneError (flatprot.scene.errors.SceneError)" href="#flatprot.scene.errors.SceneError">SceneError</a></code>, <code><span title="TypeError">TypeError</span></code></p>


        <p>Raised when an element is not of the expected type (e.g., expecting SceneGroup).</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ElementTypeError</span><span class="p">(</span><span class="n">SceneError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>  <span class="c1"># Inherit TypeError for type context</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when an element is not of the expected type (e.g., expecting SceneGroup).&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="flatprot.scene.errors.InvalidSceneOperationError" class="doc doc-heading">
            <code>InvalidSceneOperationError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="SceneError (flatprot.scene.errors.SceneError)" href="#flatprot.scene.errors.SceneError">SceneError</a></code>, <code><span title="ValueError">ValueError</span></code></p>


        <p>Raised for operations that are invalid given the current element state (e.g., adding already parented element).</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">InvalidSceneOperationError</span><span class="p">(</span><span class="n">SceneError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>  <span class="c1"># Inherit ValueError</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised for operations that are invalid given the current element state (e.g., adding already parented element).&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="flatprot.scene.errors.ParentNotFoundError" class="doc doc-heading">
            <code>ParentNotFoundError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ElementNotFoundError (flatprot.scene.errors.ElementNotFoundError)" href="#flatprot.scene.errors.ElementNotFoundError">ElementNotFoundError</a></code></p>


        <p>Raised when a specified parent element ID is not found.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ParentNotFoundError</span><span class="p">(</span><span class="n">ElementNotFoundError</span><span class="p">):</span>  <span class="c1"># Inherits as it&#39;s a specific case</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when a specified parent element ID is not found.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="flatprot.scene.errors.SceneAnnotationError" class="doc doc-heading">
            <code>SceneAnnotationError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="SceneError (flatprot.scene.errors.SceneError)" href="#flatprot.scene.errors.SceneError">SceneError</a></code></p>


        <p>Error related to scene annotations.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SceneAnnotationError</span><span class="p">(</span><span class="n">SceneError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Error related to scene annotations.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="flatprot.scene.errors.SceneCreationError" class="doc doc-heading">
            <code>SceneCreationError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="SceneError (flatprot.scene.errors.SceneError)" href="#flatprot.scene.errors.SceneError">SceneError</a></code></p>


        <p>Raised when creation of a scene fails.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SceneCreationError</span><span class="p">(</span><span class="n">SceneError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when creation of a scene fails.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="flatprot.scene.errors.SceneError" class="doc doc-heading">
            <code>SceneError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="FlatProtError (flatprot.core.FlatProtError)" href="../core/#flatprot.core.errors.FlatProtError">FlatProtError</a></code></p>


        <p>Base class for all errors in the scene module.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SceneError</span><span class="p">(</span><span class="n">FlatProtError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for all errors in the scene module.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="flatprot.scene.errors.SceneGraphInconsistencyError" class="doc doc-heading">
            <code>SceneGraphInconsistencyError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="SceneError (flatprot.scene.errors.SceneError)" href="#flatprot.scene.errors.SceneError">SceneError</a></code>, <code><span title="RuntimeError">RuntimeError</span></code></p>


        <p>Raised when an internal inconsistency in the scene graph state is detected.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SceneGraphInconsistencyError</span><span class="p">(</span><span class="n">SceneError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">):</span>  <span class="c1"># Inherit RuntimeError</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when an internal inconsistency in the scene graph state is detected.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="flatprot.scene.errors.TargetResidueNotFoundError" class="doc doc-heading">
            <code>TargetResidueNotFoundError</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="SceneError (flatprot.scene.errors.SceneError)" href="#flatprot.scene.errors.SceneError">SceneError</a></code></p>


        <p>Error raised when a target residue is not found in the structure.</p>







              <details class="quote">
                <summary>Source code in <code>src/flatprot/scene/errors.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TargetResidueNotFoundError</span><span class="p">(</span><span class="n">SceneError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Error raised when a target residue is not found in the structure.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">residue</span><span class="p">:</span> <span class="n">ResidueCoordinate</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Residue </span><span class="si">{</span><span class="n">residue</span><span class="si">}</span><span class="s2"> not found in structure </span><span class="si">{</span><span class="n">structure</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>




  </div>

    </div>

</div><p>options:
show_root_heading: true</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../transformation/" class="btn btn-neutral float-left" title="Transformation & Projection"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../rendering/" class="btn btn-neutral float-right" title="Rendering">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/t03i/FlatProt" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../transformation/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../rendering/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
